<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة ر </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" href="images (1).jpeg" type="image/png">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo+Play:wght@200..1000&family=Lalezar&display=swap" rel="stylesheet">    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
    --primary: #0a70ff; /* أزرق فاتح */
    --primary-light: #0a70ff; /* أزرق أفتح */
    --secondary: #0a70ff; /* رمادي مزرق */
    --accent: #ffffff; /* وردي فاتح */
    --dark: #2C3E50; /* أزرق داكن */
    --light: #F5F7FA; /* خلفية فاتحة */
    --success: #14ee88; /* أخضر فاتح */
    --danger: #FC5C65; /* أحمر فاتح */
    --warning: #FFCE54; /* أصفر فاتح */
    --gray: #AAB2BD; /* رمادي فاتح */
    --text: #656D78; /* لون النص الرئيسي */
    --card-bg: #ffffff; /* خلفية البطاقات */
}
/* ...existing code... */
/* ...existing code... */
#addQuestionBankModal .modal-content {
    max-width: 340px !important;
    width: 98vw !important;
    padding: 12px 8px !important;
    font-size: 0.97rem !important;
    min-height: unset !important;
    max-height: 420px !important; /* تقليل الطول الأقصى */
    overflow-y: auto !important;
}
/* ...existing code... */
/* ...existing code... */
/* ...existing code... */
body, html {
  scrollbar-width: none;           /* Firefox */
  -ms-overflow-style: none;        /* IE 10+ */
}
body::-webkit-scrollbar,
html::-webkit-scrollbar {
  display: none;                   /* Chrome, Safari */
}
@media (min-width: 901px) {
  .sidebar {
    overflow: hidden !important;
    scrollbar-width: none;        /* Firefox */
    -ms-overflow-style: none;     /* IE 10+ */
  }
  .sidebar::-webkit-scrollbar {
    display: none;                /* Chrome, Safari */
  }
}
#toggleSidebarBtn {
  display: none !important;
}

@media (max-width: 900px) {
  #toggleSidebarBtn {
    display: flex !important;
  }
}
@media (max-width: 900px) {
  #toggleSidebarBtn {
    display: flex;
  }
}
/* ...existing code... */
@media (max-width: 900px) {
    #toggleSidebarBtn {
        display: flex !important;
    }
    .sidebar {
        position: fixed;
        top: 80px;
        right: 0;
        width: 85vw;
        max-width: 320px;
        min-width: 180px;
        height: calc(100vh - 80px);
        z-index: 2000;
        background: #fff;
        box-shadow: 0 4px 16px rgba(10,112,255,0.09);
        border-radius: 0 0 10px 10px;
        padding-bottom: 30px;
        display: block !important;
        transform: translateY(-120%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
    }
    .sidebar.show {
        transform: translateY(0);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
}
/* ...existing code... */
/* ================== أساسيات التصميم المتجاوب ================== */
.sidebar {
  max-height: 0;
  transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
}

.sidebar.show {
  max-height: 500px; /* عدل القيمة حسب طول القائمة */
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}
/* الحاوية الرئيسية */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
    width: 100%;
    box-sizing: border-box;
}

/* الشبكة الرئيسية */
.dashboard {
    display: flex;
    flex-direction: row-reverse;
    gap: 20px;
    min-height: 70vh;
    width: 100%;
    box-sizing: border-box;
}

/* القائمة الجانبية */
.sidebar {
    min-width: 220px;
    max-width: 260px;
    width: 240px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 16px rgba(10,112,255,0.09);
    padding: 20px 10px 30px 10px;
    height: fit-content;
    position: relative;
    z-index: 100;
    transition: all 0.3s;
}

/* زر القائمة الجانبية */
#toggleSidebarBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2001;
    background: #0a70ff;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 48px;
            display: none;

    height: 48px;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    box-shadow: 0 2px 8px rgba(10,112,255,0.12);
    cursor: pointer;
    transition: background 0.2s, color 0.2s, transform 0.2s;
}
#toggleSidebarBtn:hover {
    background: #14ee88;
    color: #0a70ff;
    transform: scale(1.08);
}

/* منطقة المحتوى */
.content-area {
    flex: 1 1 0%;
    min-width: 0;
    width: 100%;
    max-width: 100%;
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    margin-bottom: 30px;
    box-sizing: border-box;
}

/* الفوتر دائماً فوق كل شيء */
/* ...existing code... */
.footer {
    position: relative; /* أو احذف السطر تماماً */
    z-index: 1;         /* قلل قيمة z-index */
    background-color: #0a70ff;
    color: white;
    padding: 20px 0;
    text-align: center;
    margin-top: 30px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    width: 100%;
}
/* ...existing code... */

/* أضف هذا السطر ليضمن أن المحتوى لا يختفي خلف الفوتر */
main, .container {
    margin-bottom: 80px; /* عدل القيمة حسب ارتفاع الفوتر */
}

/* القائمة الجانبية لا تغطي الفوتر */
@media (min-width: 900px) {
    .dashboard {
        flex-direction: row-reverse;
    }
    .sidebar {
        position: sticky;
        top: 110px;
        height: fit-content;
        max-height: calc(100vh - 120px);
    }
}

/* موبايل وتابلت: القائمة الجانبية تظهر فوق المحتوى وتختفي افتراضياً */
@media (max-width: 900px) {
    .dashboard {
        flex-direction: column;
        gap: 0;
    }
    .sidebar {
        position: fixed;
        top: 80px;
        right: 0;
        width: 85vw;
        max-width: 320px;
        min-width: 180px;
        height: calc(100vh - 80px);
        z-index: 2000;
        background: #fff;
        box-shadow: 0 4px 16px rgba(10,112,255,0.09);
        border-radius: 0 0 10px 10px;
        padding-bottom: 30px;
         display: block; /* Added */
        transform: translateX(100%); /* Added */
        transition: transform 0.3s ease-in-out; /* Added */
        overflow-y: auto;
    }
    .sidebar.show {
             transform: translateX(0); /* Added */
    }
    .content-area {
        width: 100% !important;
        max-width: 100% !important;
        margin-bottom: 20px;
    }
}

/* الجداول متجاوبة */
table, .grades-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(10,112,255,0.06);
    margin-bottom: 20px;
    font-size: 1rem;
}
th, td {
    padding: 12px 15px;
    text-align: right;
    border-bottom: 1px solid #eaeaea;
    vertical-align: middle;
    word-break: break-word;
}
th {
    background: #f8f9fa;
    color: #0a70ff;
    font-weight: bold;
    font-size: 1.05rem;
}
tr:hover {
    background: #f5f7fa;
}
@media (max-width: 12000px) {
    table, .grades-table {
        font-size: 0.93rem;
        min-width: 480px;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        border-radius: 8px;
    }
    th, td {
        padding: 8px 5px;
    }
}
@media (max-width: 500px) {
    table, .grades-table {
        font-size: 0.89rem;
        min-width: 340px;
    }
    th, td {
        padding: 7px 3px;
    }
}
/* اجعل القائمة الجانبية (sidebar) قابلة للتمرير العمودي فقط */
.sidebar {
    overflow-y: auto !important;
    overflow-x: hidden !important;
    max-height: calc(130vh - 120px); /* حتى لا تغطي الفوتر أو الهيدر */
}

/* تحسين شكل شريط التمرير للـ sidebar */
.sidebar::-webkit-scrollbar {
    width: 8px;
}
.sidebar::-webkit-scrollbar-thumb {
    background: #ffffff;
    border-radius: 4px;
}
.sidebar::-webkit-scrollbar-track {
    background: #f5f7fa;
}
/* البطاقات متجاوبة */
.exam-card, .slide-card, .self-test-card, .card {
    width: 100%;
    min-width: 0;
    max-width: 100%;
    box-sizing: border-box;
    margin-bottom: 20px;
}
.exams-grid, #slidesGrid, #coursesContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}
@media (max-width: 900px) {
    .exams-grid, #slidesGrid, #coursesContainer {
        grid-template-columns: 1fr;
        gap: 15px;
    }
}

/* النوافذ المنبثقة متجاوبة */
.modal-content {
    width: 95vw;
    max-width: 400px;
    min-width: 0;
    box-sizing: border-box;
}
@media (max-width: 500px) {
    .modal-content {
        padding: 10px 5px;
        font-size: 0.95rem;
    }
}

/* تحسينات عامة */
body {
    font-family: 'Tajawal', Arial, sans-serif;
    font-size: 16px;
    line-height: 1.7;
    color: #555;
    margin: 0;
    padding: 0;
    background: #f5f7fa;
    min-height: 100vh;
    box-sizing: border-box;
}
.slide-card-body {
    padding: 20px;
    background-color: #0a70ff;
    color: #333; /* لون النص */
    font-size: 1rem;
    line-height: 1.6;
    text-align: justify;
}
body {
    font-family: 'Tajawal', sans-serif;
    font-size: 16px;
    line-height: 1.7;
    color: #555;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    
}
#searchInput {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

#searchInput:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 5px rgba(67, 97, 238, 0.5);
}
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
}

header, footer {
    width: 100%;
    text-align: center;
}
/* تصميم بطاقة الاختبار */
.exam-card {
    background-color: #ffffff; /* خلفية بيضاء */
    border-radius: 15px; /* حواف مستديرة */
    overflow: hidden;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); /* ظل خفيف */
    transition: all 0.3s ease; /* تأثير عند التحويم */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    border: 1px solid #e0e0e0; /* لون الحدود */
}

.exam-card:hover {
    transform: translateY(-5px); /* رفع البطاقة عند التحويم */
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* زيادة الظل */
}

.exam-card-header {
    background: linear-gradient(135deg, #a73106, #ff6347); /* تدرج لوني برتقالي */
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 1.2rem;
    font-weight: bold;
}

.exam-card-body {
    padding: 20px;
    color: #333; /* لون النص */
    font-size: 1rem;
    line-height: 1.6;
    text-align: justify;
    
}

.exam-card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 13px 3px;
    background-color: #067ef5; /* خلفية رمادية فاتحة */
    border-top: 1px solid #067ef5;
    font-size: 0.9rem;
    color: #ffffff; /* لون النص */
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
    background-color: #2994ff; /* خلفية خفيفة */
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* ظل خفيف */
    font-weight: 500;
}

.meta-item i {
    color: #ff6347; /* لون الأيقونات */
    font-size: 1.1rem;
}

.exam-card-footer {
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f7f7f7; /* خلفية فاتحة */
    border-top: 1px solid #eee;
}

.exam-card-footer .btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.exam-card-footer .btn-primary {
    background-color: #ff6347; /* لون برتقالي */
    color: white;
    border: none;
}
.exams-container {
    max-height: 400px; /* ارتفاع ثابت للحاوية */
    overflow-y: auto; /* تمكين التمرير العمودي */
    border: 5px dashed #2994ff; /* إضافة حدود اختيارية */
    border-radius: 8px; /* حواف مستديرة */
    padding: 10px; /* مسافة داخلية */
    background-color: #ffffff; /* لون خلفية خفيف */
    box-shadow: 0 4px 6px #ffffff; /* ظل خفيف */
}

.exams-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* تصميم الشبكة */
    gap: 20px; /* مسافة بين العناصر */
}

.exams-container::-webkit-scrollbar {
    width: 8px; /* عرض شريط التمرير */
}

.exams-container::-webkit-scrollbar-thumb {
    background-color: #ffffff; /* لون شريط التمرير */
    border-radius: 4px; /* حواف مستديرة */
}

.exams-container::-webkit-scrollbar-track {
    background-color: #f1f1f1; /* لون خلفية شريط التمرير */
}
.exam-card-footer .btn-primary:hover {
    background-color: #e5533d; /* لون برتقالي أغمق */
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.exam-card-footer .btn-outline {
    background-color: transparent;
    border: 2px solid #ff6347; /* لون برتقالي */
    color: #ff6347;
}

.exam-card-footer .btn-outline:hover {
    background-color: #ff6347;
    color: white;
}
.btn-primary {
    background-color: var(--primary);
    box-shadow: 0 4px 6px rgba(93, 156, 236, 0.2);
}

.btn-primary:hover {
    background-color: #4A89DC;
    transform: translateY(-2px);
    box-shadow: 0 7px 14px rgba(93, 156, 236, 0.25);
}

.btn-outline {
    border: 2px solid var(--primary);
    color: var(--primary);
    background: transparent;
}

.btn-outline:hover {
    background-color: var(--primary);
    color: white;
}

.sidebar {
    background-color: var(--card-bg);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.sidebar-menu a:hover, .sidebar-menu a.active {
    background-color: rgba(93, 156, 236, 0.1);
    color: var(--primary);
}

.content-area {
    background-color: var(--card-bg);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.page-title {
    color: var(--dark);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    padding-bottom: 0.75rem;
}

.alert-success {
    background-color: rgba(72, 207, 173, 0.1);
    border-color: var(--success);
    color: #37BC9B;
}

.alert-danger {
    background-color: rgba(252, 92, 101, 0.1);
    border-color: var(--danger);
    color: #f82606;
}
@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideInLeft {
    from {
        transform: translateX(-100px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
/* تحسينات للشرائح */
.slide-card-body {
    padding: 1.25rem;
    color: var(--text);
    line-height: 1.8;
}

.slide-card-footer {
    background-color: rgba(245, 247, 250, 0.7);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    color: var(--gray);
}

/* تحسينات للأزرار */
.btn {
    font-weight: 600;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

/* تحسينات للجدول */
.grades-table th {
    background-color: rgba(245, 247, 250, 0.7);
    color: var(--dark);
}

.grades-table tr:hover {
    background-color: rgba(255, 255, 255, 0.5);
}

/* تحسينات للشريط الجانبي */
.sidebar-menu a {
    padding: 0.75rem 1rem;
    color: var(--text);
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

/* تحسينات للوقت المتبقي في الاختبار */
#timeRemaining {
    font-weight: 700;
    color: var(--primary);
}

/* تحسينات للنتائج */
.results-score {
    color: var(--primary);
    text-shadow: 0 3px 6px rgba(93, 156, 236, 0.2);
}

/* تحسينات للخيارات في الاختبار */
.option-label:hover {
    border-color: var(--primary);
    background-color: rgba(93, 156, 236, 0.05);
}

.option-label.selected {
    background-color: rgba(93, 156, 236, 0.1);
    border-color: var(--primary);
}

/* تحسينات للشعار */
.logo {
font-family: "Lalezar", system-ui;
font-weight: 400;
font-style: normal;
font-size: 1.8rem; /* حجم الخط */
font-weight: 700; /* وزن الخط */
color: rgb(255, 255, 255); /* لون النص */
}

.logo i {
    color: var(--accent);
}

/* تحسينات للشكل العام */
.container {
    max-width: 1200px;
    padding: 0 20px;
}
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.3s ease-in-out;
}

.modal-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #ff4444;
    margin-bottom: 15px;
}

.modal-message {
    font-size: 1rem;
    margin-bottom: 20px;
    color: #333;
}

.modal-footer .btn {
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 5px;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.modal-footer .btn:hover {
    background-color: #0056b3;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
/* تحسينات للهواتف */
@media (max-width: 768px) {
    .exams-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .exam-card, .slide-card {
        border-radius: 10px;
    }
}

        body {
    font-family: 'Tajawal', sans-serif;
    font-size: 16px;
    line-height: 1.7;
    color: #555;
}

h1, h2, h3, h4 {
    font-weight: 600;
    color: #2C3E50;
}
.btn.btn-primary.dropdown-toggle { 
    color:#008dc5;
    background-color: #ffffff; /* Added background color */
}
    
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notice {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #14ee88; /* لون أخضر */
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  font-size: 1rem;
  font-weight: bold;
  z-index: 1000;
  transition: opacity 0.5s ease, transform 0.3s ease;
}

.notice.notice-success {
  background-color: #14ee88; /* لون أخضر */
}

.notice.notice-error {
  background-color: #fc5c65; /* لون أحمر */
}
.btn-download {
    background: linear-gradient(90deg, #ff2600, #ff2600);
    color: #fff !important;
    border: none;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.08);
    transition: background 0.3s, transform 0.2s;
}
.btn-download:hover {
    background: linear-gradient(90deg, #ff6347, #ff9800);
    color: #fff !important;
    transform: translateY(-2px) scale(1.04);
}
.notice:hover {
  transform: scale(1.05);
}
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-left: 10px;
            color: var(--accent);
        }

        .auth-buttons .btn {
            margin-right: 10px;
        }

        .btn {
            display: inline-block;
            padding: 0.6rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;

            box-shadow: 0 4px 6px rgba(255, 255, 255, 0.1);
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 8px 12px rgba(255, 255, 255, 0.2);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        /* Main Content */
        main {
            padding-top: 80px;
            padding-bottom: 40px;
            min-height: calc(100vh - 120px);
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        /* تصميم الأزرار في قسم إدارة الطلاب */
.students-table td {
    display: flex;
    flex-direction: column; /* جعل الأزرار تحت بعضها */
    gap: 10px; /* مسافة بين الأزرار */
    align-items: center; /* محاذاة الأزرار في المنتصف */
}

.students-table td button {
    width: 100%; /* جعل الأزرار بعرض كامل */
    max-width: 200px; /* تحديد عرض أقصى للأزرار */
    padding: 10px; /* تحسين المساحة الداخلية */
    font-size: 0.9rem; /* حجم النص */
    border-radius: 5px; /* حواف مستديرة */
}

/* تحسين التصميم على الشاشات الصغيرة */
@media (max-width: 768px) {
    .students-table td button {
        max-width: 100%; /* جعل الأزرار بعرض كامل على الشاشات الصغيرة */
    }
}
        .alert {
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    font-weight: bold;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
/* تصميم حاوية الإشعارات */
.notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 300px;
}

/* تصميم الإشعار */
.notification {
    background-color: #ffffff;
    border-radius: 8px;
    padding: 15px 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: slideDown 0.5s ease forwards;
    opacity: 0;
    transform: translateY(-20px);
}

/* ألوان الإشعارات */
.notification.success {
    border-left: 5px solid var(--success);
}

.notification.error {
    border-left: 5px solid var(--danger);
}

.notification.info {
    border-left: 5px solid var(--primary);
}

/* نص الإشعار */
.notification-text {
    font-size: 1rem;
    color: var(--dark);
    flex: 1;
    margin-right: 10px;
}
/* اجعل عمود الإجراءات في جدول الطلاب يحتوي على أزرار في سطر واحد مع تمرير أفقي فقط للأزرار */
#studentsPage .grades-table td:last-child {
    display: flex !important;
    flex-direction: row !important;
    gap: 8px;
    align-items: center;
    overflow-x: auto;
    overflow-y: visible;
    max-width: 100vw;
    padding-bottom: 8px;
    scrollbar-width: thin;
    scrollbar-color: #0a70ff #f5f7fa;
}

/* تحسين شكل شريط التمرير للأزرار */
#studentsPage .grades-table td:last-child::-webkit-scrollbar {
    height: 8px;
}
#studentsPage .grades-table td:last-child::-webkit-scrollbar-thumb {
    background: #0a70ff;
    border-radius: 4px;
}
#studentsPage .grades-table td:last-child::-webkit-scrollbar-track {
    background: #f5f7fa;
}

/* الأزرار نفسها */
#studentsPage .grades-table td:last-child button {
    min-width: 120px;
    max-width: 180px;
    white-space: nowrap;
    font-size: 0.95rem;
    border-radius: 7px;
    padding: 10px 12px;
    margin-bottom: 0;
    margin-top: 0;
    box-shadow: 0 2px 8px rgba(10,112,255,0.04);
    border: none;
    font-weight: 600;
    transition: background 0.25s, color 0.25s, box-shadow 0.25s;
}

/* تناسق الألوان مع بقية الأزرار */
#studentsPage .btn-primary { background: linear-gradient(90deg,#0a70ff,#14ee88); color: #fff; }
#studentsPage .btn-danger { background: linear-gradient(90deg,#FC5C65,#e74c3c); color: #fff; }
#studentsPage .btn-warning { background: linear-gradient(90deg,#FFC107,#FF9800); color: #333; }
#studentsPage .btn-success { background: linear-gradient(90deg,#14ee88,#0a70ff); color: #fff; }
#studentsPage .grades-table td:last-child button:hover {
    filter: brightness(1.08);
    box-shadow: 0 4px 16px rgba(10,112,255,0.09);
    transform: translateY(-2px) scale(1.03);
}

/* استجابة للجوال */
@media (max-width: 700px) {
    #studentsPage .grades-table td:last-child {
        max-width: 98vw;
    }
    #studentsPage .grades-table td:last-child button {
        min-width: 100px;
        font-size: 0.92rem;
        padding: 9px 8px;
    }
}
/* زر إغلاق الإشعار */
.notification-close {
    background: none;
    border: none;
    color: var(--gray);
    font-size: 1.2rem;
    cursor: pointer;
    transition: color 0.3s ease;
}

.notification-close:hover {
    color: var(--dark);
}

/* حركة الإشعار */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.alert-success {
    background-color: rgba(46, 204, 113, 0.1);
    border: 1px solid var(--success);
    color: var(--success);
}

.alert-danger {
    background-color: rgba(231, 76, 60, 0.1);
    border: 1px solid var(--danger);
    color: var(--danger);
}
        /* Sidebar */
        .sidebar {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            height: fit-content;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: var(--dark);
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .sidebar-menu a i {
            margin-left: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content Area */
        .content-area {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
/* تصميم قسم التعريف */
.about-container {
    background: linear-gradient(135deg, #0f76fd, #4a89dc);
    color: white;
    margin-top: 30px;
    padding: 50px 20px;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
    text-align: center;
}

.about-content {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 30px;
    animation: fadeIn 1.5s ease-in-out; /* إضافة أنيميشن عند التحميل */
}

.about-text {
    max-width: 600px;
    font-size: 1.2rem;
    line-height: 1.8;
    text-align: center;
    animation: slideInLeft 1.5s ease-in-out; /* حركة من اليسار */
}

.about-text h1 {
    font-size: 2.5rem;
    margin-bottom: 20px;
    font-weight: bold;
    color: #fff;
}

.about-text p {
    margin-bottom: 15px;
}

.about-image {
    flex-shrink: 0;
    animation: slideInRight 1.5s ease-in-out; /* حركة من اليمين */
}
/* توسيط عناوين الأقسام الرئيسية مع الأيقونات */
.page-title {
    display: flex;
    align-items: center;
    justify-content: center; /* توسيط أفقي */
    gap: 12px;
    text-align: center;
    margin-bottom: 30px;
    margin-top: 30px;
    font-size: 2rem !important;
    font-weight: bold;
    letter-spacing: 1px;
}

.page-title i {
    font-size: 2.1rem;
    color: #282828;
    margin-left: 10px;
    margin-right: 0;
    vertical-align: middle;
}
.teacher-image {
    width: 640px;
    height: 360px;
    border-radius: 0%;
    border: 5px solid white;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease-in-out;
}

.teacher-image:hover {
    transform: scale(1.1); /* تكبير الصورة عند التمرير */
}

.about-footer {
    margin-top: 20px;
    font-size: 1.1rem;
    font-style: italic;
    color: #dfe6e9;
}

/* تحسين التصميم على الشاشات الصغيرة */
@media (max-width: 768px) {
    .about-content {
        flex-direction: column;
    }

    .about-text h1 {
        font-size: 2rem;
    }

    .teacher-image {
        width: 400px;
        height: 300px;
    }
}

/* تحسين التصميم على الشاشات الصغيرة جدًا */
@media (max-width: 480px) {
    .about-text {
        font-size: 1rem;
    }

    .about-text h1 {
        font-size: 1.8rem;
    }

    .teacher-image {
        width: 250px;
        height: 150px;
    }

    .about-container {
        padding: 30px 15px;
    }
}
#progressBarContainer {
    width: 100%;
    background-color: #f3f3f3;
    border-radius: 5px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#progressBar {
    height: 20px;
    background-color: #008a8f;
    border-radius: 5px;
    transition: width 0.3s ease-in-out;
}

.toast-message {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #14ee88; /* لون أخضر */
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1rem;
    font-weight: bold;
    z-index: 1000;
    animation: fadeIn 0.5s ease forwards;
}

.toast-message i {
    font-size: 1.5rem;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(20px);
    }
}
        .page-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
        }

        .page-title i {
            margin-left: 10px;
            color: var(--primary);
        }

        /* Exams Grid */
        .exams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .exam-card {
    background-color: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border: 1px solid #eee;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.exam-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}
/* تصميم السؤال */
.question-card {
  background-color: #f8f9fa;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* تصميم النص */
.question-text {
  font-size: 1.5rem;
  margin-bottom: 15px;
  font-weight: bold;
  color: #333;
}

/* تصميم الصورة */
.question-image-container {
  text-align: center;
  margin: 20px 0;
}

.question-image {
  max-width: 100%;
  max-height: 300px;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
}

.question-image:hover {
  transform: scale(1.05);
}

/* تصميم الخيارات */
.options-list {
  list-style: none;
  padding: 0;
}

.option-label {
  display: block;
  padding: 12px 15px;
  margin-bottom: 10px;
  background-color: white;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid #ddd;
}

.option-label:hover {
  border-color: #0a70ff;
  background-color: rgba(10, 112, 255, 0.05);
}

.option-label.selected {
  background-color: rgba(10, 112, 255, 0.1);
  border-color: #0a70ff;
}

.option-input {
  margin-right: 10px;
}
.exam-card-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 20px;
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
}

.exam-card-body {
    padding: 20px;
    color: var(--dark);
    font-size: 1rem;
    line-height: 1.6;
    text-align: justify;
}

.exam-card-meta {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 0.9rem;
    color: var(--gray);
}

.exam-card-footer {
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f8f9fa;
    font-size: 0.9rem;
    color: var(--gray);
}

.exam-card-footer button {
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.exam-card-footer .btn-primary {
    background-color: var(--primary);
    color: white;
    border: none;
}

.exam-card-footer .btn-primary:hover {
    background-color: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.exam-card-footer .btn-outline {
    background-color: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.exam-card-footer .btn-outline:hover {
    background-color: var(--primary);
    color: white;
}
        .exam-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid #eee;
        }

        .exam-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .exam-card-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 15px;
        }
        #searchSelfTestsInput {
    width: 100%;
    padding: 10px;
    border: 1px solid #ffffff;
    border-radius: 5px;
    font-size: 1rem;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

#searchSelfTestsInput:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 5px rgba(67, 97, 238, 0.5);
}
        .exam-card-title {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .exam-card-body {
            padding: 15px;
        }

        .exam-card-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .exam-card-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        /* Exam Form */
        .exam-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.modal-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 15px;
    color: var(--primary);
}

.modal-message {
    font-size: 1rem;
    margin-bottom: 20px;
    color: var(--text);
}

.modal-actions {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.modal-actions .btn {
    flex: 1;
    padding: 10px;
    font-size: 1rem;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.user-dropdown-menu {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(10,112,255,0.10);
    min-width: 180px;
    padding: 10px 0;
    right: 0;
    left: auto;
    top: 110%;
    position: absolute;
    animation: fadeIn 0.3s;
}
.user-dropdown-menu .dropdown-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #ffffff;
    background: none;
    border: none;
    width: 100%;
    padding: 12px 22px;
    font-size: 1.05rem;
    font-weight: 500;
    transition: background 0.2s, color 0.2s;
    border-radius: 0;
    text-align: right;
}
.user-dropdown-menu .dropdown-item i {
    font-size: 1.2rem;
    color: #ffffff;
    margin-left: 8px;
}
.user-dropdown-menu .dropdown-item:hover {
    background: #ffffff;
    color: #ff6347;
}
.modal-actions .btn-danger {
    background-color: var(--danger);
    color: white;
    border: none;
}

.modal-actions .btn-danger:hover {
    background-color: #c0392b;
}

.modal-actions .btn-outline {
    background-color: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.modal-actions .btn-outline:hover {
    background-color: var(--primary);
    color: white;
}
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .question-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px dashed #ddd;
        }
        .self-test-card {
    background-color: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border: 1px solid #eee;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 20px;
}

.self-test-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.self-test-card-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 15px;
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
    border-radius: 10px 10px 0 0;
}

.self-test-card-body {
    padding: 15px;
    color: var(--dark);
    font-size: 1rem;
    line-height: 1.6;
    text-align: justify;
}

.self-test-card-footer {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 15px;
}

.self-test-card-footer button {
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.self-test-card-footer .btn-primary {
    background-color: var(--primary);
    color: white;
    border: none;
}

.self-test-card-footer .btn-primary:hover {
    background-color: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
        .option-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .option-item input[type="radio"] {
            margin-left: 10px;
        }

        .option-item input[type="text"] {
            flex: 1;
            margin-right: 10px;
        }
/* تحسين تصميم البطاقات */
.card {
    background-color: var(--card-bg);
    border-radius: 15px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.card-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 20px;
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
}

.card-body {
    padding: 20px;
    color: var(--text);
    font-size: 1rem;
    line-height: 1.6;
    text-align: justify;
}

.card-footer {
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f8f9fa;
    font-size: 0.9rem;
    color: var(--gray);
}
/* تصميم النافذة المنبثقة */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
    box-sizing: border-box;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    width: 100%;
    max-width: 600px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.3s ease-in-out;
    display: flex;
    flex-direction: column;
}
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.3s ease-in-out;
}

.modal-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #ff4444;
    margin-bottom: 15px;
}

.modal-message {
    font-size: 1rem;
    margin-bottom: 20px;
    color: #333;
}

.modal-actions .btn {
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-actions .btn-success {
    background-color: #28a745;
    color: white;
    border: none;
}

.modal-actions .btn-success:hover {
    background-color: #218838;
}

.modal-actions .btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
}

.modal-actions .btn-danger:hover {
    background-color: #c82333;
}
#coursesContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.exam-card {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.exam-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.exam-card-header {
    background-color: #4caf50;
    color: white;
    padding: 15px;
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
}

.exam-card-body {
    padding: 15px;
    color: #333;
    font-size: 1rem;
    line-height: 1.6;
}
/* أضف هذا الكود إلى ملف الـ CSS أو داخل <style> في رأس الصفحة */

#studentProgressChart {
    max-height: 320px;
    overflow-y: auto;
    padding-left: 5px;
    padding-right: 5px;
    background: #f8f9fa;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(10,112,255,0.06);
    margin-bottom: 20px;
    direction: rtl;
}

/* تحسين شكل شريط التمرير */
#studentProgressChart::-webkit-scrollbar {
    width: 8px;
}
#studentProgressChart::-webkit-scrollbar-thumb {
    background: #0a70ff;
    border-radius: 4px;
}
#studentProgressChart::-webkit-scrollbar-track {
    background: #eaeaea;
}
.exam-card-footer {
    padding: 15px;
    text-align: center;
    background-color: #f8f9fa;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary);
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #aaa;
    cursor: pointer;
    transition: color 0.3s ease;
}

.modal-close:hover {
    color: var(--danger);
}

.modal-body {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px 0;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-top: 1px solid #ddd;
    padding-top: 10px;
    margin-top: 15px;
}
#manageSelfTestPage {
    padding: 20px;
}

.question-container {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px dashed #ddd;
}

.option-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.option-item input[type="radio"] {
    margin-left: 10px;
}

.option-item input[type="text"] {
    flex: 1;
    margin-right: 10px;
}
.modal-footer .btn {
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-footer .btn-danger {
    background-color: var(--danger);
    color: white;
    border: none;
}

.modal-footer .btn-danger:hover {
    background-color: #c0392b;
}

/* حركة عند ظهور النافذة */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 300px;
}

.toast {
    background-color: #14ee88; /* لون أخضر */
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: slideDown 0.5s ease forwards;
    opacity: 0;
    transform: translateY(-20px);
}

.toast i {
    margin-right: 10px;
    font-size: 1.2rem;
}

.toast-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    transition: color 0.3s ease;
}

.toast-close:hover {
    color: #0cbf6b;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-20px);
    }
}
/* تحسين التمرير داخل النافذة */
.modal-body::-webkit-scrollbar {
    width: 8px;
}

.modal-body::-webkit-scrollbar-thumb {
    background-color: var(--primary);
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-track {
    background-color: #f1f1f1;
}
        .add-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .remove-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .footer {
    background-color: #0a70ff; /* لون الخلفية */
    color: white; /* لون النص */
    padding: 20px 0;
    text-align: center;
    margin-top: 30px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

.footer .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

.footer p {
    margin: 0;
    font-size: 1rem;
    font-weight: bold;
}

.footer .social-links {
    list-style: none;
    padding: 0;
    margin: 10px 0 0;
    display: flex;
    justify-content: center;
    gap: 15px;
}
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.3s ease-in-out;
}

.modal-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #ff4444;
    margin-bottom: 15px;
}

.modal-message {
    font-size: 1rem;
    margin-bottom: 20px;
    color: #333;
}

.modal-content .btn {
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 5px;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.modal-content .btn:hover {
    background-color: #0056b3;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
.self-test-card-footer button {
    margin-left: 10px; /* مسافة بين الأزرار */
}
.footer .social-links li {
    display: inline-block;
}
.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: #0a70ff;
    border: 1px solid #0a70ff;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    min-width: 150px;
    padding: 10px 0;
}

.dropdown-item {
    padding: 10px 15px;
    background-color: transparent;
    border: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.dropdown-item:hover {
    background-color: #0a70ff;
}
.footer .social-links a {
    color: rgb(0, 170, 255);
    font-size: 1.5rem;
    transition: color 0.3s ease;
}

.footer .social-links a:hover {
    color: #ff6347; /* لون عند التحويم */
}
        /* Exam Taking */
        .exam-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .exam-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .exam-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .exam-meta {
            display: flex;
            justify-content: center;
            gap: 20px;
            color: var(--gray);
            margin-bottom: 20px;
        }
/* تغيير لون زر تسجيل الدخول */
#loginBtn {
    background-color: #ffffff; /* اللون الأخضر */
    color: rgb(0, 0, 0);
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
}
#loginBtn:hover {
    background-color: #ffffff; /* لون أخضر أغمق قليلاً */
    cursor: pointer;
}
/* إزالة تأثير hover */
#loginBtn:hover {
    cursor: pointer;
}
        .question-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .options-list {
            list-style: none;
        }

        .option-label {
            display: block;
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #ddd;
        }
        .toast-message {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #14ee88; /* لون أخضر */
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1rem;
    font-weight: bold;
    z-index: 1000;
    animation: fadeIn 0.5s ease forwards;
}

.toast-message i {
    font-size: 1.5rem;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(20px);
    }
}
        .option-label:hover {
            border-color: var(--primary);
        }

        .option-label.selected {
            background-color: rgba(67, 97, 238, 0.1);
            border-color: var(--primary);
        }

        .option-input {
            margin-left: 10px;
        }

        .exam-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .exam-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    font-size: 0.9rem;
    color: var(--gray);
    margin-top: 10px;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
    background-color: #f8f9fa;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    font-weight: 500;
}

.meta-item i {
    color: var(--primary);
    font-size: 1.1rem;
}
        /* Results */
        .results-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .results-score {
            font-size: 3rem;
            color: var(--primary);
            margin: 20px 0;
            font-weight: 700;
        }

        .results-meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .results-meta-item {
            background-color: #f8f9fa;
            padding: 15px 25px;
            border-radius: 8px;
        }

        .results-meta-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .results-questions {
            margin-top: 30px;
            text-align: right;
        }

        .result-question {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .correct-answer {
            color: var(--success);
            font-weight: 500;
        }

        .wrong-answer {
            color: var(--danger);
            font-weight: 500;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 500px;
            margin: 50px auto;
            background-color: white;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .auth-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .auth-form .form-group {
            margin-bottom: 25px;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            color: var(--gray);
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
        }
/* أنماط جديدة لتحسين واجهة رفع الملفات وعرض الصور */
.question-image-preview {
    max-width: 100%;
    max-height: 200px;
    margin-top: 10px;
    display: none;
}

.bulk-upload-instructions {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-top: 10px;
    border: 1px dashed #ddd;
}

#selfTestPage {
    text-align: center;
}

#selfTestContainer {
    margin-top: 20px;
}

.question-card {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.question-card h3 {
    font-size: 1.5rem;
    margin-bottom: 15px;
}

.options-list {
    list-style: none;
    padding: 0;
}

.option-label {
    display: block;
    padding: 12px 15px;
    margin-bottom: 10px;
    background-color: white;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid #ddd;
}

.option-label:hover {
    border-color: var(--primary);
}
#whatsappBtn {
  position: fixed;
  bottom: 30px;
  left: 30px;
  background: #25d366;
  color: #fff;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 2.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 16px rgba(37,211,102,0.18);
  z-index: 2000;
  transition: background 0.2s, transform 0.2s;
  text-decoration: none;
}
#whatsappBtn:hover {
  background: #128c7e;
  transform: scale(1.08);
}
.option-label.selected {
    background-color: rgba(67, 97, 238, 0.1);
    border-color: var(--primary);
}
.export-btn {
    margin-bottom: 20px;
}
.feedback-container {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-size: 1.2rem;
    font-weight: bold;
    animation: fadeIn 0.5s ease-in-out;
}

.feedback-container.success {
    background-color: rgba(46, 204, 113, 0.1); /* أخضر فاتح */
    color: #2ecc71; /* أخضر */
    border: 2px solid #2ecc71;
}

.feedback-container.error {
    background-color: rgba(231, 76, 60, 0.1); /* أحمر فاتح */
    color: #e74c3c; /* أحمر */
    border: 2px solid #e74c3c;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .alert-success {
            background-color: rgba(76, 201, 240, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-danger {
            background-color: rgba(239, 35, 60, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .alert i {
            margin-left: 10px;
            font-size: 1.2rem;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(67, 97, 238, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Student Grades */
        .grades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .grades-table th, .grades-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        .grades-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .grades-table tr:hover {
            background-color: #f5f7fa;
        }

        .grade-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .grade-excellent {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .grade-good {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .grade-average {
            background-color: rgba(255, 158, 0, 0.1);
            color: var(--warning);
        }

        .grade-poor {
            background-color: rgba(239, 35, 60, 0.1);
            color: var(--danger);
        }

        /* Progress Chart */
        .progress-chart {
            width: 100%;
            height: 300px;
            margin-top: 30px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            .sidebar {
    background-color: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
}
.slide-card {
    position: relative;
    overflow: hidden;
}

.slide-card:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
}
.form-control {
    border: 1px solid #E6E9ED;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(93, 156, 236, 0.2);
}
/* تأثيرات حركية عند التمرير */
.exam-card, .slide-card {
    animation: fadeInUp 0.6s ease forwards;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* تأثيرات عند التحويم */
.btn {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* تأثيرات النقر */
.btn:active {
    transform: scale(0.98);
}
.form-label {
    font-weight: 500;
    color: var(--dark);
    margin-bottom: 0.5rem;
}
.sidebar-menu a {
    display: flex;
    align-items: center;
    padding: 0.75rem 1.25rem;
    margin-bottom: 0.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.sidebar-menu a i {
    margin-left: 0.75rem;
    width: 20px;
    text-align: center;
    color: var(--primary);
}     
            .auth-buttons {
                width: 100%;
                display: flex;
                justify-content: center;
            }
            
            .exams-grid {
                grid-template-columns: 1fr;
            }
            
            .results-meta {
                flex-direction: column;
                gap: 15px;
            }
        }
      
/* تحسين تصميم بطاقات الشرائح */
.slide-card {
    background-color: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border: 1px solid #eee;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
/* تصميم النافذة المنبثقة */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.modal-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 15px;
    color: var(--primary);
}

.modal-message {
    font-size: 1rem;
    margin-bottom: 20px;
    color: var(--text);
}

.modal-actions {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.modal-actions .btn {
    flex: 1;
    padding: 10px;
    font-size: 1rem;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-actions .btn-success {
    background-color: var(--success);
    color: white;
    border: none;
}

.modal-actions .btn-success:hover {
    background-color: #12c874;
}

.modal-actions .btn-danger {
    background-color: var(--danger);
    color: white;
    border: none;
}

.modal-actions .btn-danger:hover {
    background-color: #c0392b;
}
.slide-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.slide-card-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 20px;
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
}

.slide-card-body {
    padding: 20px;
    color: var(--dark);
    font-size: 1rem;
    line-height: 1.6;
    text-align: justify;
}

.slide-card-footer {
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f8f9fa;
    font-size: 0.9rem;
    color: var(--gray);
}

.slide-card-footer i {
    margin-right: 5px;
    color: var(--primary);
}
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: white;
    border-radius: 15px;
    padding: 30px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.5s ease-in-out;
}

.modal-title {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 15px;
}

.modal-message {
    font-size: 1.2rem;
    margin-bottom: 20px;
    color: var(--text);
}

.result-details p {
    font-size: 1rem;
    margin: 10px 0;
    color: var(--dark);
}

.result-details strong {
    color: var(--primary);
}

.btn-primary {
    background-color: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background-color: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
/* اجعل كل شريحة تأخذ ارتفاعها الطبيعي فقط */
.exams-grid, #slidesGrid {
    align-items: flex-start;
}

.slide-card {
    height: auto !important;
}
    </style>
</head>
<body>
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 class="modal-title">تأكيد تسليم الاختبار</h3>
            <p class="modal-message">هل أنت متأكد أنك تريد تسليم الاختبار؟</p>
            <div class="modal-actions">
                <button id="confirmYes" class="btn btn-success">نعم</button>
                <button id="confirmNo" class="btn btn-danger">إلغاء</button>
            </div>
        </div>
    </div>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-graduation-cap"></i>
                    <span><span class="text-primary">مـنـصـة  </span>    الطــــب الطلابيه<span>
                </div>
                
                <div class="auth-buttons" id="authButtons">
                    <button class="btn btn-outline" id="loginBtn">تسجيل الدخول</button>                    <button class="btn btn-primary" id="registerBtn">حساب جديد</button>
                </div>

                <div class="user-menu" id="userMenu" style="display: none;">
                    <span id="userName"></span>
           <div class="dropdown">
    <button class="btn btn-primary dropdown-toggle" id="userMenuDropdown" onclick="toggleDropdown()">
        <i class="fas fa-user-circle"></i>
        <span style="margin-right:8px;"></span>
        <i class="fas fa-chevron-down"></i>
    </button>
    <div class="dropdown-menu user-dropdown-menu" id="dropdownMenu" style="display: none;">
        <button class="dropdown-item" id="reloadHomeBtn">
        </button>
        <button class="dropdown-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
        </button>
    </div>
</div>
                </div>
            </div>
        </div>
    </header>
<br>
    <main>
        <div class="container">
            <!-- Loading Screen -->
            <div id="loadingScreen" class="loading">
                <div class="spinner"></div>
            </div>

            <!-- Auth Screens -->
            <div id="aboutSection" class="about-container" style="display: none;">
                <div class="about-content">
                    <div class="about-text">
                        <h1>مرحباً بك في منصة   الطـــب الـطـلابــيه</h1>
                        <p>
                            منصة تعليمية تهدف إلى تبسيط مفاهيم  الطب  من خلال دروس تفاعلية واختبارات إلكترونية.
                            بتطوير برمجي من   <strong>  د/اسماعيل فرج   </strong>، الذي يمتلك خبرة تزيد عن 5 سنوات في خدمة الطب بالبرمجه .
                        </p>
                        <p>
                            انضم إلينا الآن واستمتع بتجربة تعليمية ممتعة ومفيدة!
                        </p>
                    </div>
                    <div class="about-image">
                        <img src="https://l.top4top.io/p_3395ur3na1.jpg" alt="صورة الأستاذ" class="teacher-image">
                    </div>
                </div>
                <div class="about-footer">
                    <p>تعلم  بطريقة جديدة وممتعة مع مناظر طبيعية ملهمة.</p>
                </div>
            </div>
            </div>
            <div id="authScreens" style="display: none;">
                <!-- Login Form -->
                <div id="loginForm" class="auth-container">
    <h2 class="auth-title">تسجيل الدخول</h2>
    <div id="loginError" class="alert alert-danger" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span id="loginErrorText"></span>
    </div>
    <form class="auth-form" id="loginFormFields">
        <div class="form-group">
            <label for="loginEmail" class="form-label">البريد الإلكتروني</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="أدخل بريدك الإلكتروني" required>
        </div>
        <div class="form-group">
            <label for="loginPassword" class="form-label">كلمة المرور</label>
            <input type="password" id="loginPassword" class="form-control" placeholder="أدخل كلمة المرور" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">تسجيل الدخول</button>
    </form>
    <div class="auth-footer">
        ليس لديك حساب؟ <a href="#" id="showRegister">سجل الآن</a>
    </div>
</div>


                <!-- Register Form -->
                <div id="registerForm" class="auth-container" style="display: none;">
                    <h2 class="auth-title">إنشاء حساب جديد</h2>
                    <div id="registerError" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="registerErrorText"></span>
                    </div>
                    <form class="auth-form" id="registerFormFields">
                        <div class="form-group">
                            <label for="registerName" class="form-label">الاسم الكامل</label>
                            <input type="text" id="registerName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="registerEmail" class="form-label">البريد الإلكتروني</label>
                            <input type="email" id="registerEmail" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="registerPassword" class="form-label">كلمة المرور</label>
                            <input type="password" id="registerPassword" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="registerConfirmPassword" class="form-label">تأكيد كلمة المرور</label>
                            <input type="password" id="registerConfirmPassword" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">نوع الحساب</label>
                            <select id="registerRole" class="form-control" required>
                                <option value="student">طالب</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">إنشاء الحساب</button>
                    </form>
                    <div class="auth-footer">
                        لديك حساب بالفعل؟ <a href="#" id="showLogin">سجل الدخول</a>
                    </div>
                </div>
            </div>

            <!-- Main App -->
            <div id="appContent" style="display: none;">
                <div class="dashboard">
                    <div class="sidebar">
                        <ul class="sidebar-menu">
                            <li><a href="#" class="active" id="menuDashboard"><i class="fas fa-home"></i> الرئيسية </a></li>
                            <li><a href="#" id="menuExams"><i class="fas fa-clipboard-list"></i> الاختبارات</a></li>
                            <li><a href="#" id="menuCreateExam"><i class="fas fa-plus-circle"></i>   إنشاء امتحان </a></li>
                            <li><a href="#" id="menuCreateSlide"><i class="fas fa-chalkboard-teacher"></i> إنشاء مقرر</a></li>
                            <li id="liSendNotification" style="display:none;">
  <a href="#" id="menuSendNotification">
    <i class="fas fa-bell"></i> إرسال إشعار
  </a>
</li>
<!-- أضف هذا الزر في القائمة الجانبية مع بقية عناصر الـ sidebar-menu -->
<li id="liQuestionBank" style="display:none;">
  <a href="#" id="menuQuestionBank"><i class="fas fa-database"></i> بنك الأسئلة</a>
</li>
                            <li><a href="#" id="menuManageSelfTest" style="display: none;"><i class="fas fa-brain"></i> إدارة واجب </a></li>
                            <li><a href="#" id="menuSelfTestResults"><i class="fas fa-chart-bar"></i> درجات الواجب </a></li>
                            <li><a href="#" id="menuResults"><i class="fas fa-chart-bar"></i> النتائج</a></li>
                            <li><a href="#" id="menuGrades"><i class="fas fa-star"></i> دردجات الامتحانات</a></li>
                            <li><a href="#" id="menuStudents"><i class="fas fa-users"></i> الطلاب</a></li>
                            <li id="menuStudentsStatisticsLi" style="display:none;">
  <a href="#" id="menuStudentsStatistics"><i class="fas fa-chart-line"></i> إحصائيات الطلاب</a>
</li>
                            <li><a href="#" id="menuProfile"><i class="fas fa-user"></i> الملف الشخصي</a></li>
                            <li><a href="#" id="menuTeacher"><i class="fas fa-chalkboard-teacher"></i> المعلم</a></li>
                        </ul>
                    </div>
                    <div id="selfTestPage" style="display: none;">
                        <h2 class="page-title"><i class="fas fa-brain"></i>  الواجبات المنزليه </h2>
                        <div id="selfTestContainer" class="exam-container">
                            <div id="progressBarContainer" style="margin-bottom: 20px;">
                                <div id="progressBar" style="width: 0%; height: 20px; background-color: #4caf50; border-radius: 5px; transition: width 0.3s; text-align: center; color: white; line-height: 20px;">
                                    0%
                                </div>
                            </div>
                            <div id="selfTestQuestion" class="question-card">
                                <!-- سيتم تحميل السؤال هنا -->
                            </div>
                            <div id="feedbackContainer" class="feedback-container" style="display: none;">
                                <!-- التغذية الراجعة تظهر هنا -->
                            </div>
                            <div class="exam-footer">
                                <button class="btn btn-primary" id="prevSelfTestQuestionBtn" style="display: none;">السابق</button>
                                <button class="btn btn-danger" id="exitSelfTestBtn" style="display: inline-block;">الخروج</button>

                                <button class="btn btn-primary" id="nextSelfTestQuestionBtn">التالــــي</button>

                                <button class="btn btn-success" id="finishSelfTestBtn" style="display: none;">إنهاء الاختبار</button>
                            </div>
                        </div>
                    </div>
                    <div id="deleteSelfTestModal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <h3 class="modal-title">تأكيد الحذف</h3>
                            <p class="modal-message">هل أنت متأكد أنك تريد حذف هذا الاختبار؟</p>
                            <div class="modal-actions">
                                <button id="confirmDeleteSelfTestBtn" class="btn btn-danger">حذف</button>
                                <button id="cancelDeleteSelfTestBtn" class="btn btn-outline">إلغاء</button>
                            </div>
                        </div>
                    </div>
                    <div class="content-area">

<!-- ضع هذا القسم في المكان المناسب داخل content-area أو بعد <div class="content-area"> -->
<div id="selfTestResultsPage" style="display: none;">
    <div class="results-container" style="margin-bottom: 30px; background: linear-gradient(135deg, #0a70ff 60%, #0a70ff 100%); color: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(10,112,255,0.08); padding: 35px 25px 25px 25px; text-align: center;">
        <h2 style="font-size:2.2rem; margin-bottom: 10px; font-weight: bold;">
            <i class="fas fa-chart-bar"></i> درجات الواجبات المنزليه  
        </h2>
       
    </div>
    <button class="btn btn-danger" id="deleteAllSelfTestResultsBtn" style="margin-bottom: 20px;">
    <i class="fas fa-trash"></i> حذف جميع النتائج
</button>
    <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(10,112,255,0.07); padding: 20px;">
        <table class="grades-table" style="margin-bottom:0;">
            <thead>
                <tr>
                    <th>اسم الطالب</th>
                    <th>عنوان الاختبار</th>
                    <th>الدرجة المحصلة</th>
                    <th>النسبة المئوية</th>
                    <th>التاريخ</th>
                </tr>
            </thead>
            <tbody id="selfTestResultsTable">
                <!-- سيتم تحميل النتائج هنا -->
            </tbody>
        </table>
    </div>
</div>


                        <!-- Dashboard -->
                        <div id="dashboardPage">
<br><br>

                                                                                   <h3 class="page-title"><i class="fas fa-clipboard-list"></i> الاختبارات</h3>

                                                                                                             <div class="exams-container">


    <div class="exams-grid" id="recentExams">
        <!-- سيتم تحميل الاختبارات هنا -->
    </div>
    
</div>                 
<br><br>

                            <div id="selfTestsDashboard" style="margin-top: 30px;">
                                <h3 class="page-title"><i class="fas fa-brain"></i>  الواجبات المنزليه</h3>
                              
                                <div class="exams-container">

                             
                                <p> </p>
                              

                                  
                                   
                                <div class="exams-grid" id="selfTestsGrid">
                                    <!-- سيتم تحميل اختبارات "اختبر نفسك" هنا -->
                                </div>
                                  </div>
                            </div>
     
                                                   <div id="slidesContainer" style="margin-top: 30px;" style="margin-top: 30px;" style="margin-top: 30px;" style="margin-top: 30px;">

                            <p></p>
                            <br>
                                <h3 class="page-title"><i class="fas fa-chalkboard-teacher"></i> المقررات</h3>
    <p>   </p> 
                                    <div class="exams-container">

 <div class="exams-grid" id="slidesGrid">
        <!-- الشرائح سيتم تحميلها هنا -->
    </div>
</div>
</div>
                            <div id="teacherDashboard" style="display: none;">
                                
                                <h3 class="page-title" style="margin-top: 30px;"><i class="fas fa-chart-line"></i> إحصائيات الطلاب</h3>
                                <!-- زر تفاصيل الطلاب حسب المستوى (للمعلم فقط) -->

                                <div class="prgreshart" id="studentsProgressChart">
                                    <!-- Progress chart will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <div id="studentsStatisticsPage" style="display:none;">
  <h2 class="page-title"><i class="fas fa-chart-line"></i> إحصائيات الطلاب</h2>
  <div style="margin-bottom:30px;">
    <canvas id="examAverageChart" height="120"></canvas>
    <div style="margin-bottom:18px;font-weight:bold;color:#0a70ff;">متوسط درجات الطلاب في كل امتحان</div>
  </div>
  <div style="margin-bottom:30px;">
    <canvas id="studentGeneralChart" height="120"></canvas>
    <div style="margin-bottom:18px;font-weight:bold;color:#14ee88;">المستوى العام لكل طالب</div>
  </div>
  <div style="margin-bottom:30px;">
    <canvas id="studentsCompareChart" height="120"></canvas>
    <div style="margin-bottom:18px;font-weight:bold;color:#0a70ff;">مقارنة مستويات الطلاب ببعضهم البعض</div>
  </div>
</div>
<div id="questionBankPage" style="display:none;">
  <h2 class="page-title"><i class="fas fa-database"></i> بنك الأسئلة</h2>
  <div style="margin-bottom:18px;">
    <label for="questionBankCategory" class="form-label">الفئة</label>

    <select id="questionBankCategory" class="form-control" style="max-width:300px;display:inline-block;"></select>
    <button type="button" class="btn btn-success" id="addCategoryBtn" style="margin-right:10px;">
      <i class="fas fa-plus"></i> إضافة فئة جديدة
    </button>
    <!-- أضف هذا داخل نافذة إضافة الفئة -->
<!-- أضف هذا الكود في أي مكان داخل <body> (يفضل بعد قسم بنك الأسئلة مباشرة) -->
<div id="addCategoryModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3 class="modal-title">إضافة فئة جديدة</h3>
    <form id="addCategoryForm">
      <div class="form-group">
        <label>اسم الفئة</label>
        <input type="text" id="categoryNameInput" class="form-control" required>
      </div>
      <div class="form-group">
        <label>الفئة الرئيسية (اختياري)</label>
        <select id="parentCategorySelect" class="form-control">
          <option value="">بدون فئة رئيسية</option>
          <!-- سيتم تحميل الفئات الرئيسية هنا -->
        </select>
      </div>
      <!-- أضف هذا العنصر في المكان الذي تريد عرض شجرة الفئات فيه (مثلاً تحت قائمة اختيار الفئة) -->
      <div class="modal-actions">
        <button type="submit" class="btn btn-success">إضافة</button>
        <button type="button" class="btn btn-danger" id="cancelAddCategoryBtn">إلغاء</button>
      </div>
    </form>
  </div>
</div>
    <!-- أضف هذا الزر تحت قائمة اختيار الفئة في بنك الأسئلة -->
<button type="button" class="btn btn-danger" id="deleteAllQuestionsInCategoryBtn" style="margin-bottom:15px;display:block;">
  <i class="fas fa-trash"></i> حذف جميع أسئلة الفئة المحددة
</button>
  </div>
  <button class="btn btn-primary" id="addQuestionBankBtn" style="margin-bottom:15px;">
    <i class="fas fa-plus"></i> إضافة سؤال جديد
  </button>
  
  <!-- أضف هذا الكود داخل قسم بنك الأسئلة (داخل <div id="questionBankPage"> فوق أو تحت زر إضافة سؤال جديد) -->
<div class="form-group">
  <button type="button" class="btn btn-primary" id="bulkUploadQuestionBankBtn" style="margin-bottom:15px;">
    <i class="fas fa-upload"></i> رفع أسئلة بنك الأسئلة (CSV/Excel)
  </button>
  <input type="file" id="bulkUploadQuestionBankInput" accept=".csv,.xlsx,.xls" style="display: none;">
  <small class="text-muted">يمكنك رفع ملف يحتوي على جميع الأسئلة دفعة واحدة</small>
</div>
  <div id="questionBankContainer"></div>
</div>
<div id="addQuestionBankModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3 class="modal-title">إضافة سؤال لبنك الأسئلة</h3>
    <form id="addQuestionBankForm">
      <div class="form-group">
        <label>نص السؤال</label>
        <input type="text" class="form-control" id="questionBankText" required>
      </div>
      <div class="form-group">
        <label>الخيارات</label>
        <input type="text" class="form-control" id="option1" placeholder="الخيار 1" required>
        <input type="text" class="form-control" id="option2" placeholder="الخيار 2" required>
        <input type="text" class="form-control" id="option3" placeholder="الخيار 3">
        <input type="text" class="form-control" id="option4" placeholder="الخيار 4">
      </div>
      <div class="form-group">
        <label>رقم الإجابة الصحيحة (1-4)</label>
        <input type="number" class="form-control" id="correctOption" min="1" max="4" required>
      </div>
      <div class="form-group">
        <label>رابط صورة (اختياري)</label>
        <input type="text" class="form-control" id="questionBankImageUrl">
      </div>
      <div class="form-group">
        <label>الفئة</label>
        <select id="questionBankCategoryAdd" class="form-control"></select>
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn btn-success">حفظ</button>
        <button type="button" class="btn btn-danger" id="cancelAddQuestionBankBtn">إلغاء</button>
      </div>
    </form>
  </div>
</div>
                        <!-- Exams List -->
                        <div id="examsPage" style="display: none;">
                            <h2 class="page-title"><i class="fas fa-clipboard-list"></i> الاختبارات المتاحة</h2>
                           
                            <div class="exams-grid" id="allExams">
                                <!-- All exams will be loaded here -->
                            </div>
                        </div>
                        <div id="manageSelfTestPage" style="display: none;">
                            <h2 class="page-title"><i class="fas fa-brain"></i>   ادارة الواجبات المنزليه</h2>
                            <div id="selfTestCreationSuccess" class="alert alert-success" style="display: none;">
                                <i class="fas fa-check-circle"></i>
                                <span>تم إنشاء الاختبار بنجاح!</span>
                            </div>
                            <form id="selfTestForm" class="exam-form">
                                <div class="form-group">
                                    <label for="selfTestTitle" class="form-label">عنوان الاختبار</label>
                                    <input type="text" id="selfTestTitle" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="selfTestDescription" class="form-label">وصف الاختبار</label>
                                    <textarea id="selfTestDescription" class="form-control" placeholder="أدخل وصفًا للاختبار"></textarea>
                                </div>
                                <div id="selfTestQuestionsContainer">
                                    <!-- سيتم إضافة الأسئلة هنا -->
                                </div>
                                <button type="button" class="btn btn-primary" id="addSelfTestQuestionBtn">
                                    <i class="fas fa-plus"></i> إضافة سؤال
                                </button>

                                <br><br>
                                <div class="form-group">
                                    <button type="button" class="btn btn-primary" id="bulkUploadSelfTestBtn">
                                        <i class="fas fa-upload"></i> رفع أسئلة " الواجب" (CSV/Excel)
                                    </button>
                                    <input type="file" id="bulkUploadSelfTestInput" accept=".csv,.xlsx,.xls" style="display: none;">
                                    <small class="text-muted">يمكنك رفع ملف يحتوي على جميع الأسئلة دفعة واحدة</small>
                                </div>
                                <div class="form-group" style="margin-top: 30px;">
                                    <button type="submit" class="btn btn-success" style="width: 100%; padding: 12px;">
                                        <i class="fas fa-save"></i> حفظ الاختبار
                                    </button>
                                    <br> <br> <br>
                                   

                                <div class="form-group">
                                  <!-- أزرار التحديد السريع حسب الرقم في الاسم -->
<div style="margin-bottom:10px;display:flex;gap:8px;">
  <button type="button" class="btn btn-outline" onclick="selectStudentsByNumber('allowedSelfTestStudents', '1')">  1</button>
  <button type="button" class="btn btn-outline" onclick="selectStudentsByNumber('allowedSelfTestStudents', '2')">   2</button>
  <button type="button" class="btn btn-outline" onclick="selectStudentsByNumber('allowedSelfTestStudents', '3')">  3</button>
</div>
    <label for="allowedSelfTestStudents" class="form-label">الطلاب المسموح لهم برؤية الاختبار</label>
    <select id="allowedSelfTestStudents" class="form-control" multiple>
        <!-- سيتم تحميل قائمة الطلاب هنا -->
    </select>
    <small class="text-muted">اترك هذا الحقل فارغًا إذا كنت تريد أن يكون الاختبار متاحًا لجميع الطلاب.</small>
</div>
                                 
                                </div>
                            </form>
                        </div>
                        
                        <!-- Create Exam -->
                        <div id="createExamPage" style="display: none;">
                            <h2 class="page-title"><i class="fas fa-plus-circle"></i> إنشاء اختبار جديد</h2>
                            <div id="examCreationSuccess" class="alert alert-success" style="display: none;">
                                <i class="fas fa-check-circle"></i>
                                <span>تم إنشاء الاختبار بنجاح!</span>
                            </div>
                            <form id="examForm" class="exam-form">
                                <div class="form-group">
                                    <label for="examTitle" class="form-label">عنوان الاختبار</label>
                                    <input type="text" id="examTitle" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="examDescription" class="form-label">وصف الاختبار</label>
                                    <textarea id="examDescription" class="form-control"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="examDuration" class="form-label">مدة الاختبار (دقائق)</label>
                                    <input type="number" id="examDuration" class="form-control" min="1" value="30" required>
                                </div>

                                <div class="form-group">
                                    <label for="examTotalMarks" class="form-label">الدرجة الكلية للاختبار</label>
                                    <input type="number" id="examTotalMarks" class="form-control" min="1" value="100" required>
                                </div>
                                <!-- أضف هذه الحقول داخل <form id="examForm" class="exam-form"> قبل أو بعد مدة الاختبار -->
<div class="form-group">
    <label for="examStartTime" class="form-label">وقت بداية الاختبار (توقيت عالمي UTC)</label>
    <input type="datetime-local" id="examStartTime" class="form-control" >
</div>
<div class="form-group">
    <label for="examEndTime" class="form-label">وقت نهاية الاختبار (توقيت عالمي UTC)</label>
    <input type="datetime-local" id="examEndTime" class="form-control" >
</div>
                                
                                <div id="questionsContainer">
                                    <!-- Questions will be added here -->
                                </div>
                                
                                <button type="button" class="btn btn-primary" id="addQuestionBtn">
                                    <i class="fas fa-plus"></i> إضافة سؤال
                                </button>
                                <br>
                                <br>
                                <button type="button" class="btn btn-outline" id="importFromQuestionBankBtn" style="margin-bottom:15px;">
  <i class="fas fa-database"></i> استيراد من بنك الأسئلة
</button>
                                 <br>
<div class="form-group">
    <button type="button" class="btn btn-primary" id="bulkUploadBtn">
        <i class="fas fa-upload"></i> رفع امتحان كامل (CSV/Excel)
    </button>
    <input type="file" id="bulkUploadInput" accept=".csv,.xlsx,.xls" style="display: none;">
    <small class="text-muted">يمكنك رفع ملف يحتوي على جميع الأسئلة دفعة واحدة</small>
</div>
                                <div class="form-group" style="margin-top: 30px;">
                                    <button type="submit" class="btn btn-success" style="width: 100%; padding: 12px;">
                                        <i class="fas fa-save"></i> حفظ الاختبار
                                    </button>
                                </div>
                            </form>

                            <div class="form-group">
                              <div style="margin-bottom:10px;display:flex;gap:8px;">
  <button type="button" class="btn btn-outline" onclick="selectStudentsByNumber('allowedStudents', '1')">  1</button>
  <button type="button" class="btn btn-outline" onclick="selectStudentsByNumber('allowedStudents', '2')">  2</button>
  <button type="button" class="btn btn-outline" onclick="selectStudentsByNumber('allowedStudents', '3')">    3</button>
</div>
                                <label for="allowedStudents" class="form-label">الطلاب المسموح لهم برؤية الاختبار</label>
                                <select id="allowedStudents" class="form-control" multiple>
                                    <!-- سيتم تحميل قائمة الطلاب هنا -->
                                </select>
                                <small class="text-muted">اترك هذا الحقل فارغًا إذا كنت تريد أن يكون الاختبار متاحًا لجميع الطلاب.</small>
                            </div>

                        </div>
                        <div id="deleteExamModal" class="modal" style="display: none;">
                            <div class="modal-content">
                                <h3 class="modal-title">تأكيد الحذف</h3>
                                <p class="modal-message">هل أنت متأكد أنك تريد حذف هذا الاختبار؟</p>
                                <div class="modal-actions">
                                    <button id="confirmDeleteBtn" class="btn btn-danger">حذف</button>
                                    <button id="cancelDeleteBtn" class="btn btn-outline">إلغاء</button>
                                </div>
                            </div>
                        </div>
                        <div id="deleteSlideModal" class="modal" style="display: none;">
                            <div class="modal-content">
                                <h3 class="modal-title">تأكيد الحذف</h3>
                                <p class="modal-message">هل أنت متأكد أنك تريد حذف هذا المقرر؟</p>
                                <div class="modal-actions">
                                    <button id="confirmDeleteSlideBtn" class="btn btn-danger">حذف</button>
                                    <button id="cancelDeleteSlideBtn" class="btn btn-outline">إلغاء</button>
                                </div>
                            </div>
                        </div>
                        <div id="toastMessage" class="toast-message" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <span id="toastText">تم حذف المقرر بنجاح!</span>
                        </div>
                        <div id="importQuestionsModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:700px;">
    <h3 class="modal-title">استيراد أسئلة من بنك الأسئلة</h3>
    <div style="margin-bottom:15px;">
      <label>اختر الفئة:</label>
      <!-- أضف هذا الكود أعلى جدول الأسئلة في نافذة الاستيراد (قبل <table ...>) -->
<div style="margin-bottom:10px;">
  <label>
    <input type="checkbox" id="selectAllImportQuestions">
    تحديد الكل
  </label>
</div>
      <select id="importBankCategory" class="form-control" style="max-width:300px;display:inline-block;"></select>
    </div>
    <div id="importQuestionsList" style="max-height:350px;overflow-y:auto;margin-bottom:15px;"></div>
    <div class="modal-actions">
      <button class="btn btn-success" id="addSelectedQuestionsBtn">إضافة للأسئلة المختارة</button>
      <button class="btn btn-danger" onclick="document.getElementById('importQuestionsModal').style.display='none'">إلغاء</button>
    </div>
  </div>
</div>
                        <!-- Create Slide -->
                        <div id="createSlidePage" style="display: none;">
                            <h2 class="page-title"><i class="fas fa-chalkboard-teacher"></i> إنشاء مقرر جديد</h2>
                            <div id="slideCreationSuccess" class="alert alert-success" style="display: none;">
                                <i class="fas fa-check-circle"></i>
                                <span>تم إنشاء مقرر بنجاح!</span>
                            </div>
                            <form id="slideForm" class="exam-form">
                                <div class="form-group">
                                    <label for="slideTitle" class="form-label">عنوان المقرر</label>
                                    <input type="text" id="slideTitle" class="form-control" required>
                                </div>
                                <div class="form-group">
  <label class="form-label">الفصول</label>
  <div id="chaptersContainer"></div>
  <button type="button" class="btn btn-primary" id="addChapterBtn" style="margin-top:10px;">
    <i class="fas fa-plus"></i> إضافة فصل
  </button>
</div>
                           
                                <div class="form-group" style="margin-top: 30px;">
                                    <button type="submit" class="btn btn-success" style="width: 100%; padding: 12px;">
                                        <i class="fas fa-save"></i> حفظ المقرر
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div id="gradesModal" class="modal" style="display: none;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">درجات الطالب</h3>
                                    <button class="modal-close" onclick="document.getElementById('gradesModal').style.display='none'">&times;</button>
                                </div>
                                <div class="modal-body" id="gradesModalContent">
                                    <!-- سيتم تحميل الدرجات هنا -->
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-danger" onclick="document.getElementById('gradesModal').style.display='none'">إغلاق</button>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Take Exam -->
                        <div id="takeExamPage" style="display: none;">
                            <div class="exam-container">
                                <div class="exam-header">
                                    <h1 class="exam-title" id="examViewTitle">عنوان الاختبار</h1>
                                    <div class="exam-meta">
                                        <span><i class="fas fa-clock"></i> الوقت المتبقي: <span id="timeRemaining">30:00</span></span>
                                        <span><i class="fas fa-question-circle"></i> الأسئلة: <span id="questionCount">0</span></span>
                                        <span><i class="fas fa-star"></i> الدرجة الكلية: <span id="totalMarks">100</span></span>
                                    </div>
                                </div>
                              
                                <div id="examQuestionsContainer">
                                    <!-- Exam questions will be loaded here -->
                                </div>
                                
                                <div class="exam-footer">
                                    <button class="btn btn-primary" id="prevQuestionBtn" disabled>السابق</button>
                                    <button class="btn btn-primary" id="nextQuestionBtn">التالي</button>
                                    <button class="btn btn-success" id="submitExamBtn">تسليم الاختبار</button>
                                </div>
                            </div>
                        </div>
                        <div id="coursesPage" style="display: none;">
                            <h2 class="page-title"><i class="fas fa-book"></i> المقررات الدراسية</h2>
                            <div id="coursesContainer" class="exams-grid">
                                <!-- سيتم تحميل المقررات هنا -->
                            </div>
                            <button class="btn btn-primary" id="addCourseBtn" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> إضافة مقرر دراسي
                            </button>
                        </div>
                        
                        <div id="courseDetailsPage" style="display: none;">
                            <h2 class="page-title"><i class="fas fa-info-circle"></i> تفاصيل المقرر</h2>
                            <div id="courseContent">
                                <!-- سيتم تحميل محتوى المقرر هنا -->
                            </div>
                            <button class="btn btn-primary" id="backToCoursesBtn" style="margin-top: 20px;">العودة إلى المقررات</button>
                        </div>
                        <!-- Exam Results -->
                        <div id="resultsPage" style="display: none;">
                            <div class="results-container">
                                <h2>نتيجة الاختبار</h2>
                                <div class="results-score" id="finalScore">0%</div>
                                
                                <div class="results-meta">
                                    <div class="results-meta-item">
                                        <div class="results-meta-value" id="correctAnswers">0</div>
                                        <div>إجابات صحيحة</div>
                                    </div>
                                    <div class="results-meta-item">
                                        <div class="results-meta-value" id="wrongAnswers">0</div>
                                        <div>إجابات خاطئة</div>
                                    </div>
                                    <div class="results-meta-item">
                                        <div class="results-meta-value" id="timeTaken">0</div>
                                        <div>دقيقة</div>
                                    </div>
                                    <div class="results-meta-item">
                                        <div class="results-meta-value" id="obtainedMarks">0</div>
                                        <div>الدرجة المحصلة</div>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" id="backToExamsBtn">العودة إلى الاختبارات</button>
                                
                                <div class="results-questions" id="resultsDetails">
                                    <!-- Results details will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <div id="toastContainer" class="toast-container"></div>
                        <!-- Grades Page -->
                        <div id="gradesPage" style="display: none;">
                            <h2 class="page-title"><i class="fas fa-star"></i> سجل الدرجات</h2>
                                <!-- زر حذف النتائج -->
                              <!-- أضف الأزرار في قسم سجل الدرجات (gradesPage)، تحت عنوان الصفحة مباشرة -->
<div style="margin-bottom: 18px;">
  <button class="btn btn-danger" id="deleteExamGradesBtn" style="margin-left:10px;display:inline-block;">
    <i class="fas fa-trash"></i> حذف درجات اختبار محدد
  </button>
  <button class="btn btn-danger" id="deleteAllStudentGradesBtn" style="display:inline-block;">
    <i class="fas fa-trash"></i> حذف جميع درجات الطالب
  </button>
</div>
                            <div id="studentGradesView">
                                <h3>درجاتي في الاختبارات</h3>
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>اسم الاختبار</th>
                                            <th>التاريخ</th>
                                            <th>الدرجة المحصلة</th>
                                            <th>النسبة المئوية</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentGradesTable">
                                        <!-- Student grades will be loaded here -->
                                    </tbody>
                                </table>
                                
                                <div class="progress-chart" id="studentProgressChart">
                                    <!-- Progress chart will be loaded here -->
                                </div>
                            </div>
                            
                            <div id="teacherGradesView" style="display: none;">
                                <h3>درجات الطلاب</h3>
                                <div class="form-group">
                                    <label for="gradeExamFilter" class="form-label">تصفية حسب الاختبار</label>
                                    <select id="gradeExamFilter" class="form-control">
                                        <option value="">جميع الاختبارات</option>
                                        <!-- Exam options will be loaded here -->
                                    </select>
                                </div>
                                
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>اسم الطالب</th>
                                            <th>اسم الاختبار</th>
                                            <th>التاريخ</th>
                                            <th>الدرجة المحصلة</th>
                                            <th>النسبة المئوية</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allGradesTable">
                                        <!-- All grades will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="feedbackContainer" class="feedback-container" style="display: none;">
                            <!-- سيتم عرض التقييم هنا -->
                        </div>
                        <!-- Students Page -->
                        <div id="studentsPage" style="display: none;">
                            <h2 class="page-title"><i class="fas fa-users"></i> إدارة الطلاب</h2>
                            <button class="btn btn-danger" id="disableAllStudentsBtn" style="margin-bottom: 20px;">
                                تعطيل الكل
                            </button>
                            
                            <button class="btn btn-success" id="enableAllStudentsBtn" style="margin-bottom: 20px;">
                                تفعيل الكل
                            </button>
                            <div style="margin-bottom: 20px;">
  <button class="btn btn-warning" id="lockAllStudentsBtn">
    <i class="fas fa-lock"></i> قفل الكل
  </button>
  <button class="btn btn-success" id="unlockAllStudentsBtn">
    <i class="fas fa-unlock"></i> إلغاء قفل الكل
  </button>
  <br><br>
  <!-- أضف هذا الكود أعلى جدول الطلاب مباشرة في قسم إدارة الطلاب -->
<div style="margin-bottom: 18px;">
  <input type="text" id="searchStudentsInput" class="form-control" placeholder="ابحث عن طالب بالاسم...">
</div>
</div>
                            <table class="grades-table">
                                <thead>
                                    <tr>
                                        <th>اسم الطالب</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>عدد الاختبارات</th>
                                        <th>متوسط الدرجات</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTable">
                                    <!-- Students list will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- User Profile -->
                        <div id="profilePage" style="display: none;">
                            <h2 class="page-title"><i class="fas fa-user"></i> الملف الشخصي</h2>
                            <div class="exam-form">
                                <div class="form-group">
                                    <label class="form-label">الاسم الكامل</label>
                                    <input type="text" id="profileName" class="form-control" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">البريد الإلكتروني</label>
                                    <input type="email" id="profileEmail" class="form-control" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">نوع الحساب</label>
                                    <input type="text" id="profileRole" class="form-control" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">عدد الاختبارات التي أنشأتها</label>
                                    <input type="text" id="profileExamsCreated" class="form-control" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">عدد الاختبارات التي أجريتها</label>
                                    <input type="text" id="profileExamsTaken" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
  
    </main>
    <footer class="footer">
        <div class="container">
            <footer class="footer">
                    <p>Made with ❤️ by <strong> dr-Ismail Farag</strong></p>
                                                            <p> <strong>------------------</strong></p>
                                                           

                                        <p> <strong>platform v9.5  edition 1</strong></p>

                    <ul class="social-links">
                        <li><a href="https://www.facebook.com" target="_blank"><i class="fab fa-facebook"></i></a></li>
                        <li><a href="https://www.twitter.com" target="_blank"><i class="fab fa-twitter"></i></a></li>
                        <li><a href="https://www.linkedin.com" target="_blank"><i class="fab fa-linkedin"></i></a></li>
                        <li><a href="https://www.github.com" target="_blank"><i class="fab fa-github"></i></a></li>
                    </ul>
                </div>
            </footer>           
        </div>
    </footer>
    <script>
// ضع هذا الكود في أول ملف <script> أو بعد تحميل الصفحة مباشرة

const firebaseConfig = {
  'apiKey': "AIzaSyCzPLk76EWLfx7X4Wo-d5zDMNmG6WY69Xs",
  'authDomain': "webb-e9fff.firebaseapp.com",
  'projectId': 'webb-e9fff',
  'storageBucket': "webb-e9fff.firebasestorage.app",
  'messagingSenderId': "725475534624",
  'appId': "1:725475534624:web:95b07a4d838f55b55f5945",
  'measurementId': 'G-00T9C8CF3C'
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const loadingScreen = document.getElementById("loadingScreen");
const authScreens = document.getElementById("authScreens");
const appContent = document.getElementById("appContent");
const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const loginBtn = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");
const showLogin = document.getElementById("showLogin");
const showRegister = document.getElementById('showRegister');
const authButtons = document.getElementById("authButtons");
const userMenu = document.getElementById("userMenu");
const userName = document.getElementById("userName");
const logoutBtn = document.getElementById("logoutBtn");
const dashboardPage = document.getElementById("dashboardPage");
const examsPage = document.getElementById('examsPage');
const createExamPage = document.getElementById("createExamPage");
const createSlidePage = document.getElementById("createSlidePage");
const takeExamPage = document.getElementById("takeExamPage");
const resultsPage = document.getElementById('resultsPage');
const gradesPage = document.getElementById("gradesPage");
const studentsPage = document.getElementById("studentsPage");
const profilePage = document.getElementById('profilePage');
const menuDashboard = document.getElementById("menuDashboard");

const menuExams = document.getElementById('menuExams');
const menuCreateExam = document.getElementById("menuCreateExam");
const menuCreateSlide = document.getElementById("menuCreateSlide");
const menuResults = document.getElementById("menuResults");
const menuGrades = document.getElementById('menuGrades');
const menuStudents = document.getElementById("menuStudents");
const menuProfile = document.getElementById("menuProfile");
let currentUser = null;
let currentUserData = null;
let currentExam = null;
let currentQuestionIndex = 0x0;
let userAnswers = {};
let timerInterval = null;
let timeLeft = 0x0;
let userRole = "student";
function initApp() {
  auth.onAuthStateChanged(async _0x285e50 => {
    if (_0x285e50) {
      db.collection("users").doc(_0x285e50.uid).onSnapshot(_0x4ad2fb => {
        if (_0x4ad2fb.exists && _0x4ad2fb.data().disabled) {
          _0x32b54d();
        }
      });
      const _0x2c4c18 = await db.collection("users").doc(_0x285e50.uid).get();
      if (_0x2c4c18.exists && _0x2c4c18.data().disabled) {
        _0x32b54d();
        return;
      }
      currentUser = _0x285e50;
      currentUserData = _0x2c4c18.data();
      userRole = currentUserData.role || 'student';
      setupAuthenticatedUI();
      loadDashboard();
    } else {
      currentUser = null;
      currentUserData = null;
      setupUnauthenticatedUI();
    }
    loadingScreen.style.display = 'none';
  });

  function _0x32b54d() {
    const _0x28ab01 = document.getElementById("accountDisabledModal");
    _0x28ab01.style.display = 'flex';
    setTimeout(() => {
      auth.signOut();
    }, 0xbb8);
  }
}

function deleteSelfTest(_0x1df913) {
  db.collection("selfTests").doc(_0x1df913)["delete"]().then(() => {
    showToast("تم حذف الاختبار بنجاح!", "success");
    loadSelfTests();
  })["catch"](_0x5ea457 => {
    showToast("حدث خطأ أثناء حذف الاختبار: " + _0x5ea457.message, "error");
  });
}
function showToast(_0x227b6c, _0x31f9ee = "success") {
  const _0xf0d5fa = document.getElementById("toastContainer");
  const _0x1193b2 = document.createElement("div");
  _0x1193b2.className = "toast " + _0x31f9ee;
  _0x1193b2.innerHTML = "\n        <i class=\"fas fa-check-circle\"></i>\n        <span>" + _0x227b6c + "</span>\n        <button class=\"toast-close\">&times;</button>\n    ";
  _0xf0d5fa.appendChild(_0x1193b2);
  setTimeout(() => {
    _0x1193b2.style.animation = "fadeOut 0.5s ease forwards";
    setTimeout(() => _0x1193b2.remove(), 0x1f4);
  }, 0xbb8);
  _0x1193b2.querySelector(".toast-close").addEventListener('click', () => {
    _0x1193b2.style.animation = "fadeOut 0.5s ease forwards";
    setTimeout(() => _0x1193b2.remove(), 0x1f4);
  });
}
// أضف هذا الكود بعد تحميل الاختبارات في loadRecentExams أو بعد تعريف recentExams في الصفحة الرئيسية

// 1. أضف حقل البحث في HTML أعلى قائمة الاختبارات (ضعه فوق <div class="exams-container"> الخاصة بالاختبارات)
const examsSearchBox = document.createElement("div");
examsSearchBox.innerHTML = `
    <input type="text" id="searchExamsInput" class="form-control" placeholder="ابحث عن اختبار..." style="margin-bottom: 20px;">
`;
const examsContainer = document.querySelector("#recentExams").parentElement;
examsContainer.insertBefore(examsSearchBox, examsContainer.firstChild);

// 2. دالة البحث في الاختبارات
document.getElementById("searchExamsInput").addEventListener("input", function () {
    const query = this.value.trim().toLowerCase();
    const examsGrid = document.getElementById("recentExams");
    const examCards = examsGrid.querySelectorAll(".exam-card");
    let found = false;
    examCards.forEach(card => {
        const title = card.querySelector(".exam-card-header")?.textContent?.toLowerCase() || "";
        const desc = card.querySelector(".exam-card-body")?.textContent?.toLowerCase() || "";
        if (title.includes(query) || desc.includes(query)) {
            card.style.display = "block";
            found = true;
        } else {
            card.style.display = "none";
        }
    });
    if (!found && query.length > 0) {
        examsGrid.innerHTML = "<p>لا توجد اختبارات مطابقة لبحثك.</p>";
    } else if (query.length === 0) {
        // إعادة تحميل الاختبارات إذا تم مسح البحث
        loadRecentExams();
    }
});
  document.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('toggleSidebarBtn');
        const sidebar = document.querySelector('.sidebar'); // Ensure this selector correctly targets your sidebar element

        if (toggleBtn && sidebar) {
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('show');
            });
        } else {
            if (!toggleBtn) {
                console.error('Sidebar toggle button #toggleSidebarBtn not found.');
            }
            if (!sidebar) {
                console.error('Sidebar element .sidebar not found.');
            }
        }
    });
function finishSelfTest() {
    let correctAnswers = 0;
    currentExam.questions.forEach((question, index) => {
        if (userAnswers[index] === question.correctAnswer) {
            correctAnswers++;
        }
    });

    const totalQuestions = currentExam.questions.length;
    const scorePercentage = Math.round((correctAnswers / totalQuestions) * 100);
    const wrongAnswers = totalQuestions - correctAnswers;

    // حفظ النتيجة في قاعدة البيانات (selfTestResults)
    db.collection("selfTestResults").add({
        userId: currentUser.uid,
        userName: currentUserData?.["name"] || currentUser.email,
        selfTestId: currentExam.id,
        selfTestTitle: currentExam.title,
        scorePercentage: scorePercentage,
        correctAnswers: correctAnswers,
        wrongAnswers: wrongAnswers,
        answers: userAnswers,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
    });

    // تحديث النتيجة في النافذة المنبثقة
    document.getElementById('selfTestResultScore').textContent = scorePercentage + '%';
    document.getElementById("selfTestCorrectAnswers").textContent = correctAnswers;
    document.getElementById("selfTestWrongAnswers").textContent = wrongAnswers;

    // عرض النافذة المنبثقة
    const resultModal = document.getElementById('selfTestResultModal');
    resultModal.style.display = 'flex';

    // إعادة تعيين الاختبار
    currentExam = null;
    currentQuestionIndex = 0;
    userAnswers = {};

    // إغلاق النافذة عند النقر على زر الإغلاق
    document.getElementById('closeSelfTestResultModal').onclick = function () {
        document.getElementById('selfTestResultModal').style.display = 'none';
        // يمكنك هنا إعادة المستخدم لقسم "اختبر نفسك" أو أي صفحة أخرى إذا أردت
        // مثال: showPage(dashboardPage);
    };
}
document.getElementById("finishSelfTestBtn").addEventListener("click", finishSelfTest);
document.getElementById("bulkUploadSelfTestBtn").addEventListener("click", () => {
  document.getElementById('bulkUploadSelfTestInput').click();
});
document.getElementById("bulkUploadSelfTestInput").addEventListener('change', _0x1aa80a => {
  const _0x1f579e = _0x1aa80a.target.files[0x0];
  if (!_0x1f579e) {
    return;
  }
  const _0x3e9264 = _0x1f579e.name.split('.').pop().toLowerCase();
  if (_0x3e9264 === "csv") {
    Papa.parse(_0x1f579e, {
      'header': true,
      'complete': function (_0x3cc389) {
        processSelfTestQuestions(_0x3cc389.data);
      },
      'error': function (_0x200074) {
        alert("حدث خطأ أثناء قراءة الملف: " + _0x200074.message);
      }
    });
  } else {
    if (["xlsx", "xls"].includes(_0x3e9264)) {
      const _0x3ea614 = new FileReader();
      _0x3ea614.onload = function (_0x42bf4a) {
        const _0x4cd627 = new Uint8Array(_0x42bf4a.target.result);
        const _0x558b38 = XLSX.read(_0x4cd627, {
          'type': 'array'
        });
        const _0x3f4742 = _0x558b38.SheetNames[0x0];
        const _0x2b28e2 = _0x558b38.Sheets[_0x3f4742];
        const _0x1daf44 = XLSX.utils.sheet_to_json(_0x2b28e2);
        processSelfTestQuestions(_0x1daf44);
      };
      _0x3ea614.readAsArrayBuffer(_0x1f579e);
    } else {
      alert("يرجى رفع ملف بصيغة CSV أو Excel فقط.");
    }
  }
});

function loadSelfTestResults() {
    const table = document.getElementById("selfTestResultsTable");
    table.innerHTML = "<tr><td colspan='5'>جاري تحميل النتائج...</td></tr>";
    let query = db.collection("selfTestResults").orderBy("submittedAt", "desc");
    if (userRole !== "teacher") {
        query = query.where("userId", "==", currentUser.uid);
    }
    query.get().then(snapshot => {
        if (snapshot.empty) {
            table.innerHTML = "<tr><td colspan='5'>لا توجد نتائج بعد</td></tr>";
            return;
        }
        table.innerHTML = "";
        snapshot.forEach(doc => {
            const result = doc.data();
            const date = result.submittedAt?.toDate().toLocaleString() || "";
            table.innerHTML += `
                <tr>
                    <td>${result.userName || ""}</td>
                    <td>${result.selfTestTitle || ""}</td>
                    <td>${result.correctAnswers + " / " + (result.correctAnswers + result.wrongAnswers)}</td>
                    <td>${result.scorePercentage}%</td>
                    <td>${date}</td>
                </tr>
            `;
        });
    }).catch(error => {
        table.innerHTML = `<tr><td colspan='5'>حدث خطأ: ${error.message}</td></tr>`;
    });
}
document.getElementById("menuSelfTestResults")?.addEventListener("click", e => {
    e.preventDefault();
    setActiveMenuItem(document.getElementById("menuSelfTestResults"));
    showPage(document.getElementById("selfTestResultsPage"));
    loadSelfTestResults();
});
function loadAllExams() {
  const examsGrid = document.getElementById("allExams");
  examsGrid.innerHTML = "<p>جاري تحميل الاختبارات...</p>";
  db.collection("exams").orderBy("createdAt", "desc").get().then(snapshot => {
    if (snapshot.empty) {
      examsGrid.innerHTML = "<p>لا توجد اختبارات متاحة حالياً</p>";
      return;
    }
    examsGrid.innerHTML = '';
    snapshot.forEach(doc => {
      const exam = doc.data();
      // ✅ المعلم يرى كل الاختبارات، الطالب يرى فقط المسموح له
      if (
        userRole === "teacher" ||
        !exam.allowedStudents ||
        exam.allowedStudents.length === 0 ||
        (currentUser && exam.allowedStudents.includes(currentUser.uid))
      ) {
        examsGrid.appendChild(createExamCard(exam, doc.id));
      }
    });
    // إذا لم يظهر أي اختبار
    if (!examsGrid.hasChildNodes()) {
      examsGrid.innerHTML = "<p>لا توجد اختبارات متاحة لك حالياً.</p>";
    }
  }).catch(error => {
    examsGrid.innerHTML = "<p>حدث خطأ أثناء تحميل الاختبارات: " + error.message + "</p>";
  });
}
function processSelfTestQuestions(_0x331202) {
  const _0x3c07de = document.getElementById('selfTestQuestionsContainer');
  _0x3c07de.innerHTML = '';
  _0x331202.forEach((_0x178022, _0x31e72c) => {
    const _0xa88c82 = Date.now() + _0x31e72c;
    const _0x1b842d = document.createElement('div');
    _0x1b842d.className = "question-container";
    _0x1b842d.id = 'question-' + _0xa88c82;
    _0x1b842d.innerHTML = `
            <div class="form-group">
                <label class="form-label">نص السؤال</label>
                <input type="text" class="form-control question-text" value="${_0x178022.السؤال || ''}" required>
            </div>
            <div class="form-group">
                <label class="form-label">رابط الصورة (اختياري)</label>
                <input type="text" class="form-control question-image-url" value="${_0x178022['رابط الصورة'] || ''}" placeholder="أدخل رابط الصورة (اختياري)">
            </div>
            <div class="form-group">
                <label class="form-label">خيارات الإجابة</label>
                <div id="options-${_0xa88c82}">
                    ${[1, 2, 3, 4].map(_0x47318d => `
                        <div class="option-item">
                            <input type="radio" name="correct-${_0xa88c82}" value="${_0x47318d - 1}" ${_0x178022["الإجابة الصحيحة"] == _0x47318d ? "checked" : ''} required>
                            <input type="text" class="form-control option-text" value="${_0x178022["الخيار " + _0x47318d] || ''}" required>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    _0x3c07de.appendChild(_0x1b842d);
  });
  alert("تم تحميل الأسئلة بنجاح!");
}

document.getElementById("nextSelfTestQuestionBtn").addEventListener("click", () => {
  if (currentQuestionIndex < currentExam.questions.length - 0x1) {
    currentQuestionIndex++;
    loadSelfTestQuestion(currentQuestionIndex);
  }
});
// ...existing code...
// ...existing code...
// ...existing code...
// ...existing code...

// ...existing code...

// ...existing code...

function showLessonVideoModal(url) {
    let embed = "";
    if (url.includes("youtube.com") || url.includes("youtu.be")) {
        // استخراج ID الفيديو
        let videoId = "";
        try {
            const urlObj = new URL(url);
            if (urlObj.hostname.includes("youtube.com")) {
                videoId = urlObj.searchParams.get("v");
            } else if (urlObj.hostname.includes("youtu.be")) {
                videoId = urlObj.pathname.slice(1);
            }
        } catch (e) {}
        embed = `
            <iframe 
                width="100%" 
                height="400" 
                src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&disablekb=1&fs=0&iv_load_policy=3&showinfo=0&controls=1"
                frameborder="0"
                allow="autoplay; encrypted-media"
                allowfullscreen
                sandbox="allow-scripts allow-same-origin"
                style="pointer-events:auto; user-select: none;"
                oncontextmenu="return false"
            ></iframe>
            <div style="color:#d00;font-size:0.95rem;margin-top:10px;">
                لا يمكنك فتح الفيديو في يوتيوب أو مشاركة أو تنزيل الفيديو من هنا.
            </div>
        `;
    } else {
        embed = `
            <video controls style="width:100%;max-height:400px;pointer-events:auto;user-select:none;" 
                oncontextmenu="return false" 
                ondragstart="return false" 
                onmousedown="return false"
                onselectstart="return false"
                controlsList="nodownload noremoteplayback nofullscreen"
                disablePictureInPicture
                controlsList="nodownload"
            >
                <source src="${url}" type="video/mp4">
                متصفحك لا يدعم تشغيل الفيديو.
            </video>
            <div style="color:#d00;font-size:0.95rem;margin-top:10px;">
                لا يمكنك تنزيل الفيديو أو حفظه من هنا.
            </div>
        `;
    }
    showLessonModal(embed);

    // منع النسخ واللصق وزر الفأرة الأيمن داخل نافذة الفيديو
    setTimeout(() => {
        const modal = document.getElementById("lessonModal");
        if (modal) {
            modal.oncontextmenu = () => false;
            modal.oncopy = () => false;
            modal.oncut = () => false;
            modal.onpaste = () => false;
            modal.onselectstart = () => false;
        }
    }, 100);
}

// ...existing code...
// ...existing code...
// ...existing code...
// ...existing code...
// ...existing code...
// ...existing code...

function showLessonFileModal(url) {
    showLessonModal(`<iframe src="${url}" style="width:100%;height:400px;" frameborder="0"></iframe>`);
}

function showLessonModal(content) {
    const modal = document.getElementById("lessonModal");
    const body = document.getElementById("lessonModalBody");
    body.innerHTML = content;

    // زر إغلاق أحمر وجميل
    let closeBtn = document.getElementById("closeLessonModalBtn");
    if (!closeBtn) {
        closeBtn = document.createElement("button");
        closeBtn.id = "closeLessonModalBtn";
        closeBtn.innerHTML = '<i class="fas fa-times"></i> إغلاق';
        closeBtn.className = "btn btn-danger";
        closeBtn.style.cssText = "position:;top:18px;left:18px;font-size:1.1rem;padding:8px 22px;z-index:10;";
        closeBtn.onclick = function () {
            modal.style.display = "none";
            body.innerHTML = "";
        };
        modal.querySelector(".modal-content").prepend(closeBtn);
    } else {
        closeBtn.style.display = "inline-block";
    }

    modal.style.display = "flex";
}
// ...existing code...

// إخفاء قسم درجات اختبر نفسك من القائمة الجانبية ومن الصفحة للطالب
// ...existing code...

// اجعل اسم الطالب في الهيدر يظهر بشكل احترافي مع أيقونة وصياغة لطيفة
// ...existing code...

function setupAuthenticatedUI() {
  authScreens.style.display = "none";
  appContent.style.display = "block";
  authButtons.style.display = "none";
  userMenu.style.display = "block";

  // اسم المستخدم بشكل احترافي
  let displayName = currentUserData?.["name"] || currentUser.email;
  userName.innerHTML = `<i class="fas fa-user-graduate" style="color:#ffffff;margin-left:7px;"></i> مرحباً، <span style="font-weight:bold;color:#ffffff;">${displayName}</span>`;

  // إظهار أو إخفاء عناصر القائمة حسب الدور
  if (userRole === "teacher") {
    menuCreateExam.style.display = "block";
    menuCreateSlide.style.display = "block";
    menuStudents.style.display = "block";
    menuManageSelfTest.style.display = "block";
    document.getElementById("teacherDashboard").style.display = "block";
    document.getElementById("teacherGradesView").style.display = "block";
    document.getElementById("studentGradesView").style.display = "none";
    document.getElementById("menuSelfTestResults").style.display = "block";
    document.getElementById("selfTestResultsPage").style.display = "none";
    // إظهار زر بنك الأسئلة للمعلم فقط
    const liQuestionBank = document.getElementById("liQuestionBank");
    if (liQuestionBank) liQuestionBank.style.display = "block";
    // إظهار زر إحصائيات الطلاب للمعلم فقط
    const menuStudentsStatisticsLi = document.getElementById("menuStudentsStatisticsLi");
    if (menuStudentsStatisticsLi) menuStudentsStatisticsLi.style.display = "block";
  } else {
    menuCreateExam.style.display = 'none';
    menuCreateSlide.style.display = "none";
    menuStudents.style.display = "none";
    menuManageSelfTest.style.display = "none";
    document.getElementById("teacherDashboard").style.display = 'none';
    document.getElementById("teacherGradesView").style.display = "none";
    document.getElementById("studentGradesView").style.display = 'block';
    document.getElementById("menuSelfTestResults").style.display = "none";
    document.getElementById("selfTestResultsPage").style.display = "none";
    // إخفاء زر بنك الأسئلة للطالب
    const liQuestionBank = document.getElementById("liQuestionBank");
    if (liQuestionBank) liQuestionBank.style.display = "none";
    // إخفاء زر إحصائيات الطلاب للطالب
    const menuStudentsStatisticsLi = document.getElementById("menuStudentsStatisticsLi");
    if (menuStudentsStatisticsLi) menuStudentsStatisticsLi.style.display = "none";
  }
  setActiveMenuItem(menuDashboard);
  showNotificationMenuForTeacher();
  listenForStudentNotifications();
  listenForAccountDelete();
  listenForStudentLock();
}

// ...existing code...
// دالة إظهار زر "إرسال إشعار" للمعلم فقط

// ...existing code...

// ...existing code...

menuManageSelfTest.addEventListener("click", _0x29018b => {
  _0x29018b.preventDefault();
  setActiveMenuItem(menuManageSelfTest);
  showPage(manageSelfTestPage);
});
// ...existing code...

function showAuthForm(formType) {
  const aboutSection = document.getElementById('aboutSection');
  if (formType === "login") {
    loginForm.style.display = "block";
    registerForm.style.display = "none";
    if (aboutSection) aboutSection.style.display = "block";
  } else {
    loginForm.style.display = "none";
    registerForm.style.display = "block";
    if (aboutSection) aboutSection.style.display = "none";
  }
}

// ...existing code...
// ...existing code...

// اجعل زر "الرئيسية" في القائمة المنسدلة لا يعمل reload بل يحول للرئيسية فقط
document.getElementById("reloadHomeBtn").addEventListener("click", function(e) {
  e.preventDefault();
  setActiveMenuItem(menuDashboard);
  showPage(dashboardPage);
  loadDashboard(); // إذا كنت تريد تحديث بيانات الرئيسية فقط
});

// ...existing code...
function showPage(pageElement) {
    const allPages = [
        dashboardPage, examsPage, createExamPage, createSlidePage, takeExamPage,
        resultsPage, gradesPage, studentsPage, profilePage, manageSelfTestPage, selfTestPage,
        document.getElementById("selfTestResultsPage"),
        document.getElementById("questionBankPage"), // أضف بنك الأسئلة هنا
        document.getElementById("studentsStatisticsPage") // أضف هذا السطر هنا

    ];
    allPages.forEach(p => p && (p.style.display = "none"));
    if (takeExamPage && takeExamPage.style.display === "block" && pageElement !== takeExamPage) {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }
    // إذا انتقلت من صفحة درجات اختبر نفسك إلى صفحة أخرى، أخفِ صفحة الدرجات
    if (
        document.getElementById("selfTestResultsPage") &&
        document.getElementById("selfTestResultsPage").style.display === "block" &&
        pageElement !== document.getElementById("selfTestResultsPage")
    ) {
        document.getElementById("selfTestResultsPage").style.display = "none";
    }

    // إذا انتقلت من selfTestPage إلى صفحة أخرى، أعد تعيين بيانات اختبر نفسك
    if (selfTestPage && selfTestPage.style.display === "block" && pageElement !== selfTestPage) {
        selfTestPage.style.display = "none";
        currentExam = null;
        currentQuestionIndex = 0;
        userAnswers = {};
        const selfTestResultModal = document.getElementById("selfTestResultModal");
        if (selfTestResultModal) selfTestResultModal.style.display = "none";
    }

    // إذا انتقلت من بنك الأسئلة إلى صفحة أخرى، أخفِ بنك الأسئلة
    if (
        document.getElementById("questionBankPage") &&
        document.getElementById("questionBankPage").style.display === "block" &&
        pageElement !== document.getElementById("questionBankPage")
    ) {
        document.getElementById("questionBankPage").style.display = "none";
    }

    pageElement.style.display = "block";
}
function setupUnauthenticatedUI() {
  authScreens.style.display = 'block';
  appContent.style.display = "none";
  authButtons.style.display = 'block';
  userMenu.style.display = 'none';
  showAuthForm("login");
}
function showAuthForm(_0x58aa31) {
  if (_0x58aa31 === "login") {
    loginForm.style.display = "block";
    registerForm.style.display = "none";
  } else {
    loginForm.style.display = "none";
    registerForm.style.display = "block";
  }
}
// ...existing code...

// اجعل زر تسجيل الدخول لا يعمل reload بل يظهر نموذج تسجيل الدخول فقط
document.getElementById('loginBtn').addEventListener("click", function(e) {
  e.preventDefault(); // منع إعادة تحميل الصفحة
  showAuthForm('login');
  // تمرير الصفحة إلى نموذج تسجيل الدخول إذا أردت:
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.scrollIntoView({ behavior: "smooth", block: "center" });
  }
});

// ...existing code...
// عدل دالة loadStudentsForExam ليظهر حساب المعلم أيضاً في قائمة الطلاب المسموح لهم
function loadStudentsForExam() {
  const select = document.getElementById("allowedStudents");
  select.innerHTML = "<option value=\"\">جاري تحميل الطلاب...</option>";
  // جلب جميع الطلاب والمعلمين
  db.collection('users').where("role", "in", ["student", "teacher"]).get().then(snapshot => {
    select.innerHTML = '';
    snapshot.forEach(doc => {
      const user = doc.data();
      select.innerHTML += `<option value="${doc.id}">${user.name} (${user.email})${user.role === "teacher" ? " - معلم" : ""}</option>`;
    });
  }).catch(error => {
    select.innerHTML = `<option value="">حدث خطأ أثناء تحميل الطلاب: ${error.message}</option>`;
  });
}
menuCreateExam.addEventListener("click", _0x3fc6d1 => {
  _0x3fc6d1.preventDefault();
  if (userRole !== "teacher") {
    alert("عذرًا، فقط المعلم يمكنه إنشاء الاختبارات.");
    return;
  }
  setActiveMenuItem(menuCreateExam);
  showPage(createExamPage);
});
function saveExam(_0x4c120c) {
  _0x4c120c.preventDefault();
  if (userRole !== "teacher") {
    alert("عذرًا، فقط المعلم يمكنه حفظ الاختبارات.");
    return;
  }
  const _0x3ea7af = document.getElementById("examTitle").value.trim();
  const _0x2b8241 = document.getElementById("examDescription").value.trim();
  const _0x1683ed = parseInt(document.getElementById("examDuration").value);
  const _0x1ce5c0 = parseInt(document.getElementById('examTotalMarks').value);
  const _0x1ea828 = Array.from(document.getElementById('allowedStudents').selectedOptions).map(_0x3b1db8 => _0x3b1db8.value);

  // الحقول الجديدة لوقت البداية والنهاية (اختياري)
  const startTimeInput = document.getElementById("examStartTime").value;
  const endTimeInput = document.getElementById("examEndTime").value;
  const startTime = startTimeInput ? new Date(startTimeInput).toISOString() : null;
  const endTime = endTimeInput ? new Date(endTimeInput).toISOString() : null;

  // اجعل وقت البداية والنهاية اختياري وليس إجباري
  if (!_0x3ea7af || isNaN(_0x1683ed) || isNaN(_0x1ce5c0)) {
    alert("يرجى ملء جميع الحقول المطلوبة.");
    return;
  }

  if (_0x1ea828.length === 0x0) {
    const _0x36271e = confirm("لم يتم تحديد أي طالب. هل تريد جعل الاختبار متاحًا لجميع الطلاب؟");
    if (!_0x36271e) {
      return;
    }
  }

  const _0x38acda = [];
  const _0x618a6f = document.querySelectorAll(".question-container");
  _0x618a6f.forEach(_0x3676c1 => {
    const _0x5c175c = _0x3676c1.querySelector(".question-text").value.trim();
    const _0x3eb169 = _0x3676c1.querySelectorAll(".option-text");
    const _0x2de399 = parseInt(_0x3676c1.querySelector("input[name^=\"correct-\"]:checked")?.["value"]);
    const _0x4b2e3b = _0x3676c1.querySelector(".question-image-url")?.value.trim();

    if (!_0x5c175c || isNaN(_0x2de399)) {
      alert("يرجى ملء جميع الحقول الخاصة بالأسئلة.");
      return;
    }

    const _0x2b1271 = Array.from(_0x3eb169).map(_0x586515 => ({
      'text': _0x586515.value.trim()
    }));

    _0x38acda.push({
      'text': _0x5c175c,
      'imageUrl': _0x4b2e3b || null,
      'options': _0x2b1271,
      'correctAnswer': _0x2de399
    });
  });

  db.collection('exams').add({
    'title': _0x3ea7af,
    'description': _0x2b8241 || null,
    'duration': _0x1683ed,
    'totalMarks': _0x1ce5c0,
    'questions': _0x38acda,
    'allowedStudents': _0x1ea828,
    'startTime': startTime, // اختياري
    'endTime': endTime,     // اختياري
    'createdBy': currentUserData?.["name"] || currentUser.email,
    'createdAt': firebase.firestore.FieldValue.serverTimestamp(),
    'userId': currentUser.uid
  }).then(() => {
    alert("تم حفظ الاختبار بنجاح!");
    document.getElementById("examForm").reset();
    document.getElementById('questionsContainer').innerHTML = '';
  })["catch"](_0x3f2ec5 => {
    alert("حدث خطأ أثناء حفظ الاختبار: " + _0x3f2ec5.message);
  });
}
function deleteSlide(_0xba5003) {
  db.collection("slides").doc(_0xba5003)["delete"]().then(() => {
    showToast("تم حذف الشريحة بنجاح!");
    loadSlides();
  })["catch"](_0x433cdb => {
    showToast("حدث خطأ أثناء حذف الشريحة: " + _0x433cdb.message, "error");
  });
}
function showAccountDisabledModal() {
  const modal = document.getElementById('accountDisabledModal');
  modal.innerHTML = `
    <div class="modal-content" style="max-width:420px;text-align:center;">
      <div style="margin-bottom:18px;">
        <i class="fas fa-user-slash" style="font-size:3rem;color:#FC5C65;"></i>
      </div>
      <h2 class="modal-title" style="color:#FC5C65;">🚫 حساب معطل</h2>
      <p class="modal-message" style="font-size:1.15rem;color:#333;margin-bottom:18px;">
        عذرًا، تم تعطيل حسابك. يرجى التواصل مع الإدارة للحصول على المزيد من التفاصيل.<br>
        إذا كان لديك أي استفسار أو ترغب في التواصل مع الإدارة، اضغط الزر بالأسفل.
      </p>
      <a href="https://wa.me/201060911093" target="_blank" id="whatsappContactBtn"
         style="display:inline-block;background:#25d366;color:#fff;font-size:1.2rem;padding:12px 32px;border-radius:8px;text-decoration:none;font-weight:bold;margin-bottom:10px;">
        <i class="fab fa-whatsapp" style="margin-left:8px;font-size:1.5rem;"></i> تواصل مع الإدارة عبر واتساب
      </a>
      <br>
      <button class="btn btn-primary" onclick="closeAccountDisabledModal()" style="margin-top:10px;">إغلاق</button>
    </div>
  `;
  modal.style.display = 'flex';
  setTimeout(() => {
    auth.signOut();
  }, 3000);
}
function closeAccountDisabledModal() {
  const _0x1d0492 = document.getElementById("accountDisabledModal");
  _0x1d0492.style.display = "none";
}
function showToast(_0x44c405, _0x1d4ab7 = "success") {
  const _0x3cbc38 = document.getElementById("toastMessage");
  const _0x2bb076 = document.getElementById("toastText");
  _0x2bb076.textContent = _0x44c405;
  _0x3cbc38.style.backgroundColor = _0x1d4ab7 === 'success' ? "#14ee88" : "#FC5C65";
  _0x3cbc38.style.display = 'flex';
  setTimeout(() => {
    _0x3cbc38.style.animation = "fadeOut 0.5s ease forwards";
    setTimeout(() => {
      _0x3cbc38.style.display = "none";
      _0x3cbc38.style.animation = "fadeIn 0.5s ease forwards";
    }, 0x1f4);
  }, 0xbb8);
}
// عند تحميل قائمة الاختبارات (loadRecentExams و loadAllExams) يجب أن يظهر فقط للطلاب المسموح لهم
function loadRecentExams() {
  const examsGrid = document.getElementById("recentExams");
  examsGrid.innerHTML = "<p>جاري تحميل الاختبارات...</p>";
  db.collection("exams").orderBy("createdAt", "desc").limit(900).get().then(snapshot => {
    if (snapshot.empty) {
      examsGrid.innerHTML = "<p>لا توجد اختبارات متاحة حالياً</p>";
      return;
    }
    examsGrid.innerHTML = '';
    snapshot.forEach(doc => {
      const exam = doc.data();
      // ✅ فقط الطلاب المسموح لهم أو منشئ الاختبار
      const isOwner = currentUser && exam.userId === currentUser.uid;
      if (
        !exam.allowedStudents || 
        exam.allowedStudents.length === 0 || 
        (currentUser && exam.allowedStudents.includes(currentUser.uid)) ||
        isOwner
      ) {
        examsGrid.appendChild(createExamCard(exam, doc.id));
      }
    });
    // إذا لم يظهر أي اختبار
    if (!examsGrid.hasChildNodes()) {
      examsGrid.innerHTML = "<p>لا توجد اختبارات متاحة لك حالياً.</p>";
    }
  }).catch(error => {
    examsGrid.innerHTML = "<p>حدث خطأ أثناء تحميل الاختبارات: " + error.message + "</p>";
  });
}

function showExamTimeNotice(message, type = "error") {
    // إذا كانت الرسالة موجودة مسبقاً، احذفها
    const oldNotice = document.getElementById("examTimeNotice");
    if (oldNotice) oldNotice.remove();

    const notice = document.createElement("div");
    notice.id = "examTimeNotice";
    notice.className = `notice notice-${type}`;
    notice.style.position = "fixed";
    notice.style.top = "30px";
    notice.style.right = "30px";
    notice.style.zIndex = "2000";
    notice.style.background = type === "error" ? "#FC5C65" : "#14ee88";
    notice.style.color = "#fff";
    notice.style.padding = "18px 30px";
    notice.style.borderRadius = "10px";
    notice.style.fontSize = "1.2rem";
    notice.style.fontWeight = "bold";
    notice.style.boxShadow = "0 4px 12px rgba(0,0,0,0.12)";
    notice.style.display = "flex";
    notice.style.alignItems = "center";
    notice.style.gap = "12px";
    notice.innerHTML = `
        <i class="fas fa-exclamation-triangle" style="font-size:1.5rem;"></i>
        <span>${message}</span>
        <button style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;margin-right:10px;" onclick="this.parentElement.remove()">&times;</button>
    `;
    document.body.appendChild(notice);

    setTimeout(() => {
        if (notice.parentElement) notice.remove();
    }, 4000);
}
function setActiveMenuItem(_0x1a7133) {
  const _0x7b902d = [menuDashboard, menuExams, menuCreateExam, menuCreateSlide, menuResults, menuGrades, menuStudents, menuProfile];
  _0x7b902d.forEach(_0x52b867 => {
    _0x52b867.classList.remove('active');
  });
  _0x1a7133.classList.add("active");
}
function showAuthForm(_0x73933a) {
  const _0x596957 = document.getElementById('aboutSection');
  if (_0x73933a === "login") {
    loginForm.style.display = "block";
    registerForm.style.display = "none";
    _0x596957.style.display = 'block';
  } else {
    loginForm.style.display = "none";
    registerForm.style.display = "block";
    _0x596957.style.display = "none";
  }
}
function confirmDeleteExam(_0xb07129) {
  const _0x50cb84 = document.getElementById('deleteExamModal');
  _0x50cb84.style.display = "flex";
  const _0x13f5ed = document.getElementById('confirmDeleteBtn');
  const _0x2f5160 = document.getElementById("cancelDeleteBtn");
  _0x13f5ed.replaceWith(_0x13f5ed.cloneNode(true));
  _0x2f5160.replaceWith(_0x2f5160.cloneNode(true));
  document.getElementById('confirmDeleteBtn').addEventListener("click", () => {
    _0x50cb84.style.display = "none";
    deleteExam(_0xb07129);
  });
  document.getElementById("cancelDeleteBtn").addEventListener("click", () => {
    _0x50cb84.style.display = "none";
  });
}
function deleteExam(examId) {
  db.collection('exams').doc(examId).delete().then(() => {
    showNotice("تم حذف الاختبار بنجاح!", "success");
    loadAllExams(); // إعادة تحميل قائمة الاختبارات
  }).catch(error => {
    showNotice("حدث خطأ أثناء حذف الاختبار: " + error.message, "error");
  });
}
document.getElementById("nextSelfTestQuestionBtn").addEventListener("click", () => {
  if (selfTestCurrentIndex < selfTestQuestions.length - 0x1) {
    selfTestCurrentIndex++;
    loadSelfTestQuestion(selfTestCurrentIndex);
  }
});
function showNotice(message, type = "success") {
  const noticeContainer = document.createElement("div");
  noticeContainer.className = `notice notice-${type}`;
  noticeContainer.textContent = message;

  // إضافة الإشعار إلى الصفحة
  document.body.appendChild(noticeContainer);

  // إزالة الإشعار بعد 3 ثوانٍ
  setTimeout(() => {
    noticeContainer.style.opacity = "0";
    setTimeout(() => noticeContainer.remove(), 500);
  }, 3000);
}
document.getElementById("finishSelfTestBtn").addEventListener("click", finishSelfTest);

function loadDashboard() {
  showPage(dashboardPage);
  loadRecentExams();
  loadSlides();
  if (userRole === 'teacher') {
    loadStudentsProgress();
  } else {
    loadStudentProgress();
  }
}
function loadRecentExams() {
  const examsGrid = document.getElementById("recentExams");
  examsGrid.innerHTML = "<p>جاري تحميل الاختبارات...</p>";
  db.collection("exams").orderBy("createdAt", "desc").limit(900).get().then(snapshot => {
    if (snapshot.empty) {
      examsGrid.innerHTML = "<p>لا توجد اختبارات متاحة حالياً</p>";
      return;
    }
    examsGrid.innerHTML = '';
    snapshot.forEach(doc => {
      const exam = doc.data();
      // ✅ فقط الطلاب المسموح لهم أو منشئ الاختبار
      const isOwner = currentUser && exam.userId === currentUser.uid;
      if (
        !exam.allowedStudents || 
        exam.allowedStudents.length === 0 || 
        (currentUser && exam.allowedStudents.includes(currentUser.uid)) ||
        isOwner
      ) {
        examsGrid.appendChild(createExamCard(exam, doc.id));
      }
    });
    // إذا لم يظهر أي اختبار
    if (!examsGrid.hasChildNodes()) {
      examsGrid.innerHTML = "<p>لا توجد اختبارات متاحة لك حالياً.</p>";
    }
  }).catch(error => {
    examsGrid.innerHTML = "<p>حدث خطأ أثناء تحميل الاختبارات: " + error.message + "</p>";
  });
}
document.getElementById('bulkUploadBtn').addEventListener("click", () => {
  document.getElementById("bulkUploadInput").click();
});
document.getElementById('bulkUploadInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const fileExtension = file.name.split('.').pop().toLowerCase();

    if (fileExtension === 'csv') {
        // معالجة ملف CSV
        Papa.parse(file, {
            header: true,
            complete: function (results) {
                processQuestions(results.data);
            },
            error: function (error) {
                alert(`حدث خطأ أثناء قراءة الملف: ${error.message}`);
            }
        });
    } else if (['xlsx', 'xls'].includes(fileExtension)) {
        // معالجة ملف Excel
        const reader = new FileReader();
        reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            processQuestions(jsonData);
        };
        reader.readAsArrayBuffer(file);
    } else {
        alert('يرجى رفع ملف بصيغة CSV أو Excel فقط.');
    }
});
function loadCourses() {
    const coursesContainer = document.getElementById("coursesContainer");
    coursesContainer.innerHTML = "<p>جاري تحميل المقررات...</p>";
    db.collection("courses").orderBy("createdAt", "desc").get().then(snapshot => {
        if (snapshot.empty) {
            coursesContainer.innerHTML = "<p>لا توجد مقررات متاحة حالياً</p>";
            return;
        }
        coursesContainer.innerHTML = '';
        snapshot.forEach(doc => {
            const course = doc.data();
            const courseCard = document.createElement("div");
            courseCard.className = "exam-card";
            courseCard.innerHTML = `
                <div class="exam-card-header">${course.title}</div>
                <div class="exam-card-body">
                    <p>${course.description}</p>
                </div>
                <div class="exam-card-footer">
                    <button class="btn btn-primary" onclick="viewCourse('${doc.id}')">عرض</button>
                </div>
            `;
            coursesContainer.appendChild(courseCard);
        });
    }).catch(error => {
        coursesContainer.innerHTML = `<p>حدث خطأ أثناء تحميل المقررات: ${error.message}</p>`;
    });
}
function viewCourse(courseId) {
    const courseDetailsPage = document.getElementById("courseDetailsPage");
    const courseContent = document.getElementById("courseContent");
    courseContent.innerHTML = "<p>جاري تحميل تفاصيل المقرر...</p>";
    db.collection("courses").doc(courseId).get().then(doc => {
        if (!doc.exists) {
            courseContent.innerHTML = "<p>لم يتم العثور على المقرر.</p>";
            return;
        }
        const course = doc.data();
        courseContent.innerHTML = `
            <h3>${course.title}</h3>
            <p>${course.description}</p>
            <h4>الفيديوهات:</h4>
            <ul>
                ${course.videos.map(video => `<li><a href="${video.url}" target="_blank">${video.title}</a></li>`).join('')}
            </ul>
            <h4>الاختبارات:</h4>
            <ul>
                ${course.exams.map(exam => `<li>${exam.title}</li>`).join('')}
            </ul>
            <h4>اختبر نفسك:</h4>
            <ul>
                ${course.selfTests.map(test => `<li>${test.title}</li>`).join('')}
            </ul>
        `;
    }).catch(error => {
        courseContent.innerHTML = `<p>حدث خطأ أثناء تحميل تفاصيل المقرر: ${error.message}</p>`;
    });
    showPage(courseDetailsPage);
}
document.getElementById("addCourseBtn").addEventListener("click", () => {
    const title = prompt("أدخل عنوان المقرر:");
    const description = prompt("أدخل وصف المقرر:");
    if (!title || !description) {
        alert("يرجى إدخال جميع البيانات.");
        return;
    }
    db.collection("courses").add({
        title,
        description,
        videos: [],
        exams: [],
        selfTests: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        alert("تم إضافة المقرر بنجاح!");
        loadCourses();
    }).catch(error => {
        alert("حدث خطأ أثناء إضافة المقرر: " + error.message);
    });
});
document.getElementById("backToCoursesBtn").addEventListener("click", () => {
    showPage(document.getElementById("coursesPage"));
});
function confirmDeleteSelfTest(_0x1e1f1d) {
  const _0x5bae17 = document.getElementById('deleteSelfTestModal');
  _0x5bae17.style.display = "flex";
  const _0x5af9f8 = document.getElementById("confirmDeleteSelfTestBtn");
  const _0x588071 = document.getElementById("cancelDeleteSelfTestBtn");
  _0x5af9f8.replaceWith(_0x5af9f8.cloneNode(true));
  _0x588071.replaceWith(_0x588071.cloneNode(true));
  document.getElementById("confirmDeleteSelfTestBtn").addEventListener("click", () => {
    _0x5bae17.style.display = "none";
    deleteSelfTest(_0x1e1f1d);
  });
  document.getElementById('cancelDeleteSelfTestBtn').addEventListener("click", () => {
    _0x5bae17.style.display = "none";
  });
}
function toggleDropdown() {
  const _0x2a6597 = document.getElementById("dropdownMenu");
  _0x2a6597.style.display = _0x2a6597.style.display === 'block' ? "none" : "block";
}
document.addEventListener("click", _0x45b349 => {
  const _0x13063e = document.getElementById("userMenuDropdown");
  const _0x29cb3e = document.getElementById('dropdownMenu');
  if (!_0x13063e.contains(_0x45b349.target)) {
    _0x29cb3e.style.display = 'none';
  }
});
document.getElementById('submitExamBtn').addEventListener("click", () => {
  const _0x3badc3 = document.getElementById("confirmModal");
  _0x3badc3.style.display = "flex";
  const _0x42dbe0 = document.getElementById('confirmYes');
  const _0x265d7f = document.getElementById('confirmNo');
  _0x42dbe0.replaceWith(_0x42dbe0.cloneNode(true));
  _0x265d7f.replaceWith(_0x265d7f.cloneNode(true));
  document.getElementById("confirmYes").addEventListener("click", () => {
    _0x3badc3.style.display = "none";
    submitExam();
  });
  document.getElementById('confirmNo').addEventListener("click", () => {
    _0x3badc3.style.display = "none";
  });
});

function processQuestions(data) {
    const questionsContainer = document.getElementById("questionsContainer");
    questionsContainer.innerHTML = ''; // تفريغ الحاوية قبل إضافة الأسئلة

    data.forEach((row, index) => {
        const questionId = `question-${Date.now()}-${index}`;
        const questionText = row['السؤال']?.trim();
        const correctAnswer = parseInt(row['الإجابة الصحيحة']);
        const imageUrl = row['رابط الصورة']?.trim(); // قراءة رابط الصورة
        const options = [];

        for (let i = 1; i <= 4; i++) {
            const optionText = row[`الخيار ${i}`]?.trim();
            if (optionText) {
                options.push({ text: optionText });
            }
        }

        // إنشاء عنصر السؤال
        const questionElement = document.createElement("div");
        questionElement.className = "question-container";
        questionElement.id = questionId;

        questionElement.innerHTML = `
            <div class="form-group">
                <label class="form-label">نص السؤال</label>
                <input type="text" class="form-control question-text" value="${questionText}" required>
            </div>
            <div class="form-group">
                <label class="form-label">رابط الصورة (اختياري)</label>
                <input type="text" class="form-control question-image-url" value="${imageUrl || ''}" placeholder="أدخل رابط الصورة">
            </div>
            <div class="form-group">
                <label class="form-label">خيارات الإجابة</label>
                <div id="options-${questionId}">
                    ${options.map((option, optionIndex) => `
                        <div class="option-item">
                            <input type="radio" name="correct-${questionId}" value="${optionIndex}" ${correctAnswer === optionIndex ? "checked" : ""} required>
                            <input type="text" class="form-control option-text" value="${option.text}" required>
                        </div>
                    `).join('')}
                </div>
                <button type="button" class="add-btn" onclick="addOption('${questionId}')">
                    <i class="fas fa-plus"></i> إضافة خيار
                </button>
                <button type="button" class="remove-btn" onclick="removeQuestion('${questionId}')">
                    <i class="fas fa-trash"></i> حذف السؤال
                </button>
            </div>
        `;

        questionsContainer.appendChild(questionElement);
    });

    alert('تم تحميل الأسئلة بنجاح!');
}




function createExamCard(exam, examId) {
  const card = document.createElement('div');
  card.className = "exam-card";
  const header = document.createElement("div");
  header.className = "exam-card-header";
  header.innerHTML = `<i class="fas fa-clipboard-list"></i> ${exam.title}`;
  const body = document.createElement("div");
  body.className = "exam-card-body";
  body.innerHTML = `<p>${exam.description || ''}</p>`;
  const meta = document.createElement("div");
  meta.className = "exam-card-meta";
  meta.innerHTML = `
    <div class="meta-item"><i class="fas fa-user"></i> <span>${exam.createdBy || "مجهول"}</span></div>
    <div class="meta-item"><i class="fas fa-clock"></i> <span>${exam.duration} دقيقة</span></div>
    <div class="meta-item"><i class="fas fa-star"></i> <span>${exam.totalMarks || 100} درجة</span></div>
  `;
  const footer = document.createElement('div');
  footer.className = "exam-card-footer";
  const startBtn = document.createElement("button");
  startBtn.className = "btn btn-primary";
  startBtn.textContent = "بدء الاختبار";
  startBtn.addEventListener("click", () => {
    showExamConfirmModal(() => startExam(exam, examId));
  });
  footer.appendChild(startBtn);

  if (userRole === "teacher") {
    const editBtn = document.createElement("button");
    editBtn.className = "btn btn-outline";
    editBtn.textContent = "تعديل";
    editBtn.addEventListener("click", () => editExam(exam, examId));
    footer.appendChild(editBtn);
    const delBtn = document.createElement("button");
    delBtn.className = "btn btn-danger";
    delBtn.textContent = 'حذف';
    delBtn.addEventListener("click", () => confirmDeleteExam(examId));
    footer.appendChild(delBtn);
  }
  card.appendChild(header);
  card.appendChild(meta);
  card.appendChild(body);
  card.appendChild(footer);
  return card;
}

function closeAccountDisabledModal() {
  const _0x38acde = document.getElementById('accountDisabledModal');
  _0x38acde.style.display = "none";
}
function loadSelfTests() {
    const selfTestsGrid = document.getElementById("selfTestsGrid");
    selfTestsGrid.innerHTML = "<p>جاري تحميل اختبارات \"اختبر نفسك\"...</p>";
    db.collection('selfTests').orderBy("createdAt", "desc").get().then(snapshot => {
        if (snapshot.empty) {
            selfTestsGrid.innerHTML = "<p>لا توجد اختبارات \"اختبر نفسك\" متاحة حالياً</p>";
            return;
        }
        selfTestsGrid.innerHTML = '';
        snapshot.forEach(doc => {
            const selfTest = doc.data();
            let allowed = Array.isArray(selfTest.allowedStudents) ? selfTest.allowedStudents : [];
            const isOwner = currentUser && selfTest.userId === currentUser.uid;
            const isAllowed = allowed.length === 0 || (currentUser && allowed.includes(currentUser.uid)) || isOwner;
            // ✅ فقط الطلاب المسموح لهم أو منشئ الاختبار
            if (isAllowed) {
                selfTestsGrid.appendChild(createSelfTestCard(selfTest, doc.id));
            }
        });
        // إذا لم يظهر أي اختبار
        if (!selfTestsGrid.hasChildNodes()) {
            selfTestsGrid.innerHTML = "<p>لا توجد اختبارات متاحة لك حالياً.</p>";
        }
    })["catch"](error => {
        selfTestsGrid.innerHTML = "<p>حدث خطأ أثناء تحميل اختبارات \"اختبر نفسك\": " + error.message + '</p>';
    });
}
function showExamConfirmModal(onConfirm) {
    // إذا كانت النافذة موجودة مسبقاً، لا تنشئها من جديد
    let modal = document.getElementById("examConfirmModal");
    if (!modal) {
        modal = document.createElement("div");
        modal.id = "examConfirmModal";
        modal.className = "modal";
        modal.innerHTML = `
            <div class="modal-content">
                <h2 class="modal-title">هل أنت مستعد؟</h2>
                <p class="modal-message">هل أنت متأكد أنك تريد بدء الاختبار الآن؟<br>تأكد أنك مستعد ولن تتمكن من العودة بعد البدء.</p>
                <div class="modal-actions">
                    <button id="confirmStartExamBtn" class="btn btn-success">نعم، ابدأ</button>
                    <button id="cancelStartExamBtn" class="btn btn-danger">إلغاء</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    modal.style.display = "flex";
    document.getElementById("confirmStartExamBtn").onclick = () => {
        modal.style.display = "none";
        onConfirm();
    };
    document.getElementById("cancelStartExamBtn").onclick = () => {
        modal.style.display = "none";
    };
}
function searchRecentExams() {
    const searchQuery = document.getElementById("searchInput").value.toLowerCase();
    const examsContainer = document.getElementById("recentExams");
    const examCards = examsContainer.querySelectorAll(".exam-card");
    let hasResults = false;

    examCards.forEach(card => {
        const title = card.querySelector(".exam-card-header").textContent.toLowerCase();
        const description = card.querySelector(".exam-card-body").textContent.toLowerCase();

        if (title.includes(searchQuery) || description.includes(searchQuery)) {
            card.style.display = "block"; // عرض البطاقة إذا تطابق النص
            hasResults = true;
        } else {
            card.style.display = "none"; // إخفاء البطاقة إذا لم تتطابق
        }
    });

    if (!hasResults) {
        examsContainer.innerHTML = "<p>لا توجد اختبارات مطابقة لبحثك.</p>";
    }
}
// عدل دالة createSelfTestCard ليظهر زر "تعديل" للمعلم أو منشئ الاختبار
function createSelfTestCard(selfTest, selfTestId) {
  const card = document.createElement("div");
  card.className = "self-test-card";
  const header = document.createElement("div");
  header.className = "self-test-card-header";
  header.textContent = selfTest.title;
  const body = document.createElement('div');
  body.className = "self-test-card-body";
  body.innerHTML = `
        <p>${selfTest.description || "لا يوجد وصف للاختبار"}</p>
        <p><strong>عدد الأسئلة:</strong> ${selfTest.questions.length}</p>
    `;
  const footer = document.createElement("div");
  footer.className = 'self-test-card-footer';

  // زر بدء الاختبار
  const startBtn = document.createElement("button");
  startBtn.className = "btn btn-primary";
  startBtn.textContent = "بدء الاختبار";
  startBtn.style.marginRight = "10px";
  startBtn.addEventListener("click", () => startSelfTest(selfTest, selfTestId));
  footer.appendChild(startBtn);

  // زر تعديل يظهر للمعلم أو منشئ الاختبار فقط
  if (userRole === 'teacher' || (currentUser && selfTest.userId === currentUser.uid)) {
    const editBtn = document.createElement("button");
    editBtn.className = "btn btn-outline";
    editBtn.textContent = "تعديل";
    editBtn.style.marginRight = "10px";
    editBtn.addEventListener("click", () => editSelfTest(selfTest, selfTestId));
    footer.appendChild(editBtn);
  }

  // زر حذف للمعلم فقط
  if (userRole === 'teacher') {
    const delBtn = document.createElement('button');
    delBtn.className = "btn btn-danger";
    delBtn.textContent = "حذف";
    delBtn.addEventListener("click", () => confirmDeleteSelfTest(selfTestId));
    footer.appendChild(delBtn);
  }

  card.appendChild(header);
  card.appendChild(body);
  card.appendChild(footer);
  return card;
}
let editingSelfTestId = null;

// أضف دالة editSelfTest لفتح صفحة التعديل وتعبئة البيانات
function editSelfTest(selfTest, selfTestId) {
      editingSelfTestId = selfTestId;

  setActiveMenuItem(menuManageSelfTest);
  showPage(manageSelfTestPage);

  // تعبئة بيانات الاختبار
  document.getElementById("selfTestTitle").value = selfTest.title || "";
  document.getElementById("selfTestDescription").value = selfTest.description || "";

  // تعبئة الأسئلة
  const questionsContainer = document.getElementById("selfTestQuestionsContainer");
  questionsContainer.innerHTML = '';
  selfTest.questions.forEach((question, index) => {
    const questionId = `question-${Date.now()}-${index}`;
    const questionElement = document.createElement("div");
    questionElement.className = "question-container";
    questionElement.id = questionId;
    questionElement.innerHTML = `
      <div class="form-group">
        <label class="form-label">نص السؤال</label>
        <input type="text" class="form-control question-text" value="${question.text}" required>
      </div>
      <div class="form-group">
        <label class="form-label">رابط الصورة (اختياري)</label>
        <input type="text" class="form-control question-image-url" value="${question.imageUrl || ''}" placeholder="أدخل رابط الصورة">
      </div>
      <div class="form-group">
        <label class="form-label">خيارات الإجابة</label>
        <div id="options-${questionId}">
          ${question.options.map((option, optionIndex) => `
            <div class="option-item">
              <input type="radio" name="correct-${questionId}" value="${optionIndex}" ${question.correctAnswer === optionIndex ? "checked" : ""} required>
              <input type="text" class="form-control option-text" value="${option.text}" required>
            </div>
          `).join('')}
        </div>
        <button type="button" class="add-btn" onclick="addOption('${questionId}')">
          <i class="fas fa-plus"></i> إضافة خيار
        </button>
        <button type="button" class="remove-btn" onclick="removeQuestion('${questionId}')">
          <i class="fas fa-trash"></i> حذف السؤال
        </button>
      </div>
    `;
    questionsContainer.appendChild(questionElement);
  });

  // تعبئة الطلاب المسموح لهم
  loadStudentsForSelfTest(selfTest.allowedStudents || []);

  // تغيير زر الحفظ ليقوم بالتحديث بدلاً من الإضافة
  const selfTestForm = document.getElementById('selfTestForm');
  selfTestForm.onsubmit = function (event) {
    event.preventDefault();
    // نفس منطق الحفظ، لكن استخدم update بدلاً من add
    const title = document.getElementById("selfTestTitle").value;
    const description = document.getElementById("selfTestDescription").value;
    const questions = [];
    const questionDivs = document.querySelectorAll(".question-container");
    questionDivs.forEach(div => {
      const text = div.querySelector(".question-text").value;
      const imageUrl = div.querySelector(".question-image-url").value;
      const options = Array.from(div.querySelectorAll(".option-text")).map(opt => ({ text: opt.value }));
      const correctAnswer = parseInt(div.querySelector("input[name^='correct-']:checked").value);
      questions.push({
        text,
        imageUrl: imageUrl || null,
        options,
        correctAnswer
      });
    });
    // الطلاب المسموح لهم
    let allowedStudents = [];
    const allowedSelect = document.getElementById('allowedSelfTestStudents');
    if (allowedSelect) {
      allowedStudents = Array.from(allowedSelect.selectedOptions).map(opt => opt.value);
    }
    db.collection('selfTests').doc(selfTestId).update({
      title,
      description,
      questions,
      allowedStudents,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      alert("تم تحديث الاختبار بنجاح!");
      location.reload();
    }).catch(error => {
      alert("حدث خطأ أثناء تحديث الاختبار: " + error.message);
    });
  };
}
function startSelfTest(selfTest, selfTestId) {
    const allowed = Array.isArray(selfTest.allowedStudents) ? selfTest.allowedStudents : [];
    const isOwner = currentUser && selfTest.userId === currentUser.uid;
    if (
        allowed.length > 0 &&
        (!currentUser || (!allowed.includes(currentUser.uid) && !isOwner))
    ) {
        showNotice("عذرًا، لا يمكنك أداء هذا الاختبار. لم يتم منحك الإذن.", "error");
        return;
    }
    currentExam = {
        ...selfTest,
        'id': selfTestId
    };
    currentQuestionIndex = 0;
    userAnswers = {};
    loadSelfTestQuestion(currentQuestionIndex);
    showPage(selfTestPage);
}
// استبدل دالة loadSelfTestQuestion القديمة بهذا الكود (تأكد أن لديك دالة واحدة فقط بهذا الاسم)

// إنشاء نافذة منبثقة
// ...existing code...

// إنشاء نافذة تأكيد الخروج مع زر "عودة للرئيسية" بدون reload

// استبدل زر الخروج في اختبار "اختبر نفسك" بهذا:
// ...existing code...

// إنشاء نافذة تأكيد الخروج مع زر "عودة للرئيسية" بدون reload
function createExitModal() {
    // إنشاء العناصر
    const modal = document.createElement("div");
    modal.id = "exitModal";
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;

    const modalContent = document.createElement("div");
    modalContent.style.cssText = `
        background-color: white;
        border-radius: 10px;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.3s ease-in-out;
    `;

    const title = document.createElement("h2");
    title.textContent = "⚠️ تأكيد الخروج";
    title.style.cssText = `
        font-size: 1.8rem;
        font-weight: bold;
        color: #ff4444;
        margin-bottom: 15px;
    `;

    const message = document.createElement("p");
    message.textContent = "هل أنت متأكد أنك تريد الخروج من الاختبار؟ سيتم فقدان تقدمك الحالي.";
    message.style.cssText = `
        font-size: 1rem;
        margin-bottom: 20px;
        color: #333;
    `;

    const actions = document.createElement("div");
    actions.style.cssText = `
        display: flex;
        justify-content: space-between;
        gap: 10px;
    `;

    // زر العودة للرئيسية
    const homeButton = document.createElement("button");
    homeButton.textContent = "العودة للرئيسية";
    homeButton.style.cssText = `
        flex: 1;
        padding: 10px;
        font-size: 1rem;
        border-radius: 5px;
        background-color: #0a70ff;
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    `;
    homeButton.addEventListener("click", () => {
        // إزالة الرسالة والانتقال للرئيسية
        modal.remove();
        setActiveMenuItem(menuDashboard);
        showPage(dashboardPage);
        loadDashboard();
    });

    // زر إلغاء
    const cancelButton = document.createElement("button");
    cancelButton.textContent = "إلغاء";
    cancelButton.style.cssText = `
        flex: 1;
        padding: 10px;
        font-size: 1rem;
        border-radius: 5px;
        background-color: transparent;
        border: 2px solid #3498db;
        color: #3498db;
        cursor: pointer;
        transition: all 0.3s ease;
    `;
    cancelButton.addEventListener("click", () => {
        modal.remove();
    });

    // تجميع العناصر
    actions.appendChild(homeButton);
    actions.appendChild(cancelButton);
    modalContent.appendChild(title);
    modalContent.appendChild(message);
    modalContent.appendChild(actions);
    modal.appendChild(modalContent);

    // إضافة النافذة إلى الصفحة
    document.body.appendChild(modal);
}

// استبدل زر الخروج في اختبار "اختبر نفسك" بهذا:
document.getElementById("exitSelfTestBtn").addEventListener("click", () => {
    createExitModal();
});

// ...existing code...
// ...existing code...

// استبدال نافذة التأكيد الافتراضية بزر الخروج
document.getElementById("exitSelfTestBtn").addEventListener("click", () => {
    createExitModal();
});
function searchSelfTests() {
    const searchQuery = document.getElementById("searchSelfTestsInput").value.toLowerCase();
    const selfTestsContainer = document.getElementById("selfTestsGrid");
    const selfTestCards = selfTestsContainer.querySelectorAll(".self-test-card");

    if (searchQuery.trim() === "") {
        // إذا كان النص فارغًا، عرض جميع الاختبارات
        selfTestCards.forEach(card => {
            card.style.display = "block";
        });
        return;
    }

    let hasResults = false;

    selfTestCards.forEach(card => {
        const title = card.querySelector(".self-test-card-header").textContent.toLowerCase();
        const description = card.querySelector(".self-test-card-body").textContent.toLowerCase();

        if (title.includes(searchQuery) || description.includes(searchQuery)) {
            card.style.display = "block"; // عرض البطاقة إذا تطابق النص
            hasResults = true;
        } else {
            card.style.display = "none"; // إخفاء البطاقة إذا لم تتطابق
        }
    });

}
document.getElementById("menuSelfTestResults")?.addEventListener("click", e => {
    e.preventDefault();
    setActiveMenuItem(document.getElementById("menuSelfTestResults"));
    showPage(document.getElementById("selfTestResultsPage"));
    loadSelfTestResults();
});
function showFeedback(_0x2e824c) {
  const _0x32e831 = currentExam.questions[_0x2e824c];
  const _0x5aa6ac = userAnswers[_0x2e824c];
  const _0x1ea34b = document.getElementById("feedbackContainer");
  _0x1ea34b.style.display = 'block';
  if (_0x5aa6ac === _0x32e831.correctAnswer) {
    _0x1ea34b.className = "feedback-container success";
    _0x1ea34b.innerHTML = "\n            <i class=\"fas fa-check-circle\"></i> إجابة صحيحة! أحسنت!\n        ";
  } else {
    _0x1ea34b.className = "feedback-container error";
    _0x1ea34b.innerHTML = "\n            <i class=\"fas fa-times-circle\"></i> إجابة خاطئة. الإجابة الصحيحة هي:\n            <strong>" + _0x32e831.options[_0x32e831.correctAnswer].text + "</strong>\n        ";
  }
  document.getElementById('nextSelfTestQuestionBtn').style.display = _0x2e824c < currentExam.questions.length - 0x1 ? "inline-block" : "none";
  document.getElementById('finishSelfTestBtn').style.display = _0x2e824c === currentExam.questions.length - 0x1 ? "inline-block" : "none";
}
// أضف هذا الكود بعد تحميل صفحة teacherDashboard أو بعد loadStudentsProgress()

function loadDashboard() {
  showPage(dashboardPage);
  loadRecentExams();
  loadSlides();
  loadSelfTests();
  if (userRole === "teacher") {
    loadStudentsProgress();
  } else {
    loadStudentProgress();
  }
}
document.getElementById("menuManageSelfTest").addEventListener("click", _0x2dd3d1 => {
  _0x2dd3d1.preventDefault();
  setActiveMenuItem(menuManageSelfTest);
  showPage(manageSelfTestPage);
});

document.getElementById("addSelfTestQuestionBtn").addEventListener("click", () => {
  const _0x3c0222 = document.getElementById("selfTestQuestionsContainer");
  const _0x5485bb = Date.now();
  const _0x20fed5 = document.createElement("div");
  _0x20fed5.className = "question-container";
  _0x20fed5.id = "question-" + _0x5485bb;
  _0x20fed5.innerHTML = `
        <div class="form-group">
            <label class="form-label">نص السؤال</label>
            <input type="text" class="form-control question-text" required>
        </div>
        <div class="form-group">
            <label class="form-label">رابط الصورة (اختياري)</label>
            <input type="text" class="form-control question-image-url" placeholder="أدخل رابط الصورة (اختياري)">
        </div>
        <div class="form-group">
            <label class="form-label">خيارات الإجابة</label>
            <div id="options-${_0x5485bb}">
                <div class="option-item">
                    <input type="radio" name="correct-${_0x5485bb}" value="0" required>
                    <input type="text" class="form-control option-text" placeholder="الخيار الأول" required>
                </div>
                <div class="option-item">
                    <input type="radio" name="correct-${_0x5485bb}" value="1" required>
                    <input type="text" class="form-control option-text" placeholder="الخيار الثاني" required>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addOption('${_0x5485bb}')">
                <i class="fas fa-plus"></i> إضافة خيار
            </button>
            <button type="button" class="remove-btn" onclick="removeQuestion('${_0x5485bb}')">
                <i class="fas fa-trash"></i> حذف السؤال
            </button>
        </div>
    `;
  _0x3c0222.appendChild(_0x20fed5);
});

// عدل دالة addOption ليتم عرض رسالة جميلة بدلاً من alert
function addOption(questionId) {
  const optionsContainer = document.getElementById("options-" + questionId);
  const optionCount = optionsContainer.children.length;
  if (optionCount >= 5) {
    showNotice("الحد الأقصى للخيارات هو 5", "error");
    return;
  }
  const optionDiv = document.createElement("div");
  optionDiv.className = 'option-item';
  optionDiv.innerHTML = `
        <input type="radio" name="correct-${questionId}" value="${optionCount}" required>
        <input type="text" class="form-control option-text" placeholder="الخيار ${optionCount + 1}" required>
    `;
  optionsContainer.appendChild(optionDiv);
}
function removeQuestion(questionId) {
    const questionElement = document.getElementById(questionId);
    if (questionElement && confirm("هل أنت متأكد من حذف هذا السؤال؟")) {
        questionElement.remove();
    }
}
document.getElementById("enableAllStudentsBtn").addEventListener("click", () => {
    if (!confirm("هل أنت متأكد أنك تريد تفعيل جميع الطلاب؟")) {
        return;
    }

    db.collection("users")
        .where("role", "==", "student")
        .get()
        .then((querySnapshot) => {
            const batch = db.batch(); // استخدام batch لتحديث جميع الطلاب دفعة واحدة
            querySnapshot.forEach((doc) => {
                batch.update(doc.ref, { disabled: false });
            });

            return batch.commit(); // تنفيذ التحديثات
        })
        .then(() => {
            alert("تم تفعيل جميع الطلاب بنجاح!");
            loadStudents(); // إعادة تحميل قائمة الطلاب
        })
        .catch((error) => {
            alert("حدث خطأ أثناء تفعيل الطلاب: " + error.message);
        });
});

function searchExams() {
    const searchQuery = document.getElementById("searchInput").value.toLowerCase();
    const examsContainer = document.getElementById("allExams");
    const examCards = examsContainer.querySelectorAll(".exam-card");

    if (searchQuery.trim() === "") {
        // إذا كان النص فارغًا، عرض جميع الاختبارات
        examCards.forEach(card => {
            card.style.display = "block";
        });
        return;
    }

    let hasResults = false;

    examCards.forEach(card => {
        const title = card.querySelector(".exam-card-header").textContent.toLowerCase();
        const description = card.querySelector(".exam-card-body").textContent.toLowerCase();

        if (title.includes(searchQuery) || description.includes(searchQuery)) {
            card.style.display = "block"; // عرض البطاقة إذا تطابق النص
            hasResults = true;
        } else {
            card.style.display = "none"; // إخفاء البطاقة إذا لم تتطابق
        }
    });

    if (!hasResults) {
        examsContainer.innerHTML = "<p>لا توجد اختبارات مطابقة لبحثك.</p>";
    }
}
// أضف هذا الكود بعد تحميل اختبارات "اختبر نفسك" أو بعد تعريف selfTestsGrid

// 1. أضف حقل البحث في HTML أعلى قائمة اختبر نفسك (ضعه فوق <div class="exams-container"> الخاصة باختبر نفسك)
const selfTestsSearchBox = document.createElement("div");
selfTestsSearchBox.innerHTML = `
    <input type="text" id="searchSelfTestsInput" class="form-control" placeholder="ابحث في اختبر نفسك...">
`;
const selfTestsContainer = document.querySelector("#selfTestsGrid").parentElement;
selfTestsContainer.insertBefore(selfTestsSearchBox, selfTestsContainer.firstChild);

// 2. دالة البحث في اختبر نفسك
document.getElementById("searchSelfTestsInput").addEventListener("input", function () {
    const query = this.value.trim().toLowerCase();
    const selfTestsGrid = document.getElementById("selfTestsGrid");
    const selfTestCards = selfTestsGrid.querySelectorAll(".self-test-card");
    let found = false;
    selfTestCards.forEach(card => {
        const title = card.querySelector(".self-test-card-header")?.textContent?.toLowerCase() || "";
        const desc = card.querySelector(".self-test-card-body")?.textContent?.toLowerCase() || "";
        if (title.includes(query) || desc.includes(query)) {
            card.style.display = "block";
            found = true;
        } else {
            card.style.display = "none";
        }
    });
    if (!found && query.length > 0) {
        selfTestsGrid.innerHTML = "<p>لا توجد اختبارات مطابقة لبحثك.</p>";
    } else if (query.length === 0) {
        // إعادة تحميل اختبر نفسك إذا تم مسح البحث
        loadSelfTests();
    }
});
// ...existing code...

// زر حذف درجات اختبار معين
document.getElementById("deleteExamGradesBtn").onclick = async function () {
  const examId = document.getElementById("gradeExamFilter").value;
  if (!examId) {
    showToast("اختر اختباراً أولاً من القائمة!", "error");
    return;
  }
  if (!confirm("هل أنت متأكد أنك تريد حذف جميع درجات هذا الاختبار؟ لا يمكن التراجع عن هذا الإجراء!")) return;

  let query = db.collection("results").where("examId", "==", examId);
  // إذا كان الطالب، احذف فقط درجاته في هذا الاختبار
  if (userRole !== "teacher") {
    query = query.where("userId", "==", currentUser.uid);
  }
  const snapshot = await query.get();
  if (snapshot.empty) {
    showToast("لا توجد درجات لهذا الاختبار.", "error");
    return;
  }
  const batch = db.batch();
  snapshot.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  showToast("تم حذف درجات الاختبار بنجاح!", "success");
  if (userRole === "teacher") {
    loadAllGrades();
  } else {
    loadStudentGrades();
    loadStudentProgress();
  }
};

// زر حذف جميع درجات الطالب
document.getElementById("deleteAllStudentGradesBtn").onclick = async function () {
  if (!confirm("هل أنت متأكد أنك تريد حذف جميع درجات الطالب؟ لا يمكن التراجع عن هذا الإجراء!")) return;
  let query = db.collection("results").where("userId", "==", currentUser.uid);
  if (userRole === "teacher") {
    // للمعلم: حذف كل الدرجات لكل الطلاب
    if (!confirm("أنت معلم، هل تريد حذف جميع الدرجات لكل الطلاب؟")) return;
    query = db.collection("results");
  }
  const snapshot = await query.get();
  if (snapshot.empty) {
    showToast("لا توجد درجات لحذفها.", "error");
    return;
  }
  const batch = db.batch();
  snapshot.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  showToast("تم حذف جميع الدرجات بنجاح!", "success");
  if (userRole === "teacher") {
    loadAllGrades();
  } else {
    loadStudentGrades();
    loadStudentProgress();
  }
};

// ...existing code...
function confirmDeleteSlide(_0x4dc90a) {
  const _0x263548 = document.getElementById("deleteSlideModal");
  _0x263548.style.display = "flex";
  const _0x396cac = document.getElementById("confirmDeleteSlideBtn");
  const _0x43b5d0 = document.getElementById("cancelDeleteSlideBtn");
  _0x396cac.replaceWith(_0x396cac.cloneNode(true));
  _0x43b5d0.replaceWith(_0x43b5d0.cloneNode(true));
  document.getElementById('confirmDeleteSlideBtn').addEventListener("click", () => {
    _0x263548.style.display = "none";
    deleteSlide(_0x4dc90a);
  });
  document.getElementById("cancelDeleteSlideBtn").addEventListener("click", () => {
    _0x263548.style.display = 'none';
  });
}
// ...existing code...
// عدل دالة حفظ اختبار "اختبر نفسك" لتتأكد من جلب الطلاب المسموح لهم بشكل صحيح
document.getElementById('selfTestForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const title = document.getElementById("selfTestTitle").value;
  const description = document.getElementById('selfTestDescription').value;
  const questions = [];
  document.querySelectorAll(".question-container").forEach(div => {
    const text = div.querySelector(".question-text").value;
    const imageUrl = div.querySelector(".question-image-url") ? div.querySelector(".question-image-url").value.trim() : "";
    const options = Array.from(div.querySelectorAll('.option-text')).map(opt => ({ text: opt.value }));
    const correctAnswer = parseInt(div.querySelector("input[name^='correct-']:checked").value);
    questions.push({
      text,
      imageUrl: imageUrl || null,
      options,
      correctAnswer
    });
  });
  let allowedStudents = [];
  const allowedSelect = document.getElementById('allowedSelfTestStudents');
  if (allowedSelect) {
    allowedStudents = Array.from(allowedSelect.selectedOptions).map(opt => opt.value);
  }

  // إذا كنت في وضع التعديل، استخدم update، وإلا استخدم add
  if (editingSelfTestId) {
    db.collection('selfTests').doc(editingSelfTestId).update({
      title,
      description,
      questions,
      allowedStudents,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      alert("تم تحديث الاختبار بنجاح!");
      location.reload();
    }).catch(error => {
      alert("حدث خطأ أثناء تحديث الاختبار: " + error.message);
    });
  } else {
    db.collection('selfTests').add({
      title,
      description,
      questions,
      allowedStudents,
      createdBy: currentUserData?.["name"] || currentUser.email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      userId: currentUser.uid
    }).then(() => {
      alert("تم حفظ الاختبار بنجاح!");
      location.reload();
    }).catch(error => {
      alert("حدث خطأ أثناء حفظ الاختبار: " + error.message);
    });
  }
});

// ...existing code...
// عدل دالة editExam ليتم تحميل الطلاب وتحديد المسموح لهم تلقائياً
function editExam(exam, examId) {
    setActiveMenuItem(menuCreateExam);
    showPage(createExamPage);

    // تعبئة بيانات الاختبار
    document.getElementById("examTitle").value = exam.title;
    document.getElementById("examDescription").value = exam.description;
    document.getElementById("examDuration").value = exam.duration;
    document.getElementById("examTotalMarks").value = exam.totalMarks;

    // تعبئة وقت البداية والنهاية إذا كان موجوداً
    document.getElementById("examStartTime").value = exam.startTime ? new Date(exam.startTime).toISOString().slice(0,16) : "";
    document.getElementById("examEndTime").value = exam.endTime ? new Date(exam.endTime).toISOString().slice(0,16) : "";

    // تعبئة الأسئلة
    const questionsContainer = document.getElementById("questionsContainer");
    questionsContainer.innerHTML = '';
    exam.questions.forEach((question, index) => {
        const questionId = `question-${Date.now()}-${index}`;
        const questionElement = document.createElement("div");
        questionElement.className = "question-container";
        questionElement.id = questionId;
        questionElement.innerHTML = `
            <div class="form-group">
                <label class="form-label">نص السؤال</label>
                <input type="text" class="form-control question-text" value="${question.text}" required>
            </div>
            <div class="form-group">
                <label class="form-label">رابط الصورة (اختياري)</label>
                <input type="text" class="form-control question-image-url" value="${question.imageUrl || ''}" placeholder="أدخل رابط الصورة">
            </div>
            <div class="form-group">
                <label class="form-label">خيارات الإجابة</label>
                <div id="options-${questionId}">
                    ${question.options.map((option, optionIndex) => `
                        <div class="option-item">
                            <input type="radio" name="correct-${questionId}" value="${optionIndex}" ${question.correctAnswer === optionIndex ? "checked" : ""} required>
                            <input type="text" class="form-control option-text" value="${option.text}" required>
                        </div>
                    `).join('')}
                </div>
                <button type="button" class="add-btn" onclick="addOption('${questionId}')">
                    <i class="fas fa-plus"></i> إضافة خيار
                </button>
                <button type="button" class="remove-btn" onclick="removeQuestion('${questionId}')">
                    <i class="fas fa-trash"></i> حذف السؤال
                </button>
            </div>
        `;
        questionsContainer.appendChild(questionElement);
    });

    // تحميل الطلاب وتحديد المسموح لهم تلقائياً
    const allowedStudents = exam.allowedStudents || [];
    const select = document.getElementById("allowedStudents");
    select.innerHTML = "<option value=\"\">جاري تحميل الطلاب...</option>";
    db.collection('users').where("role", '==', "student").get().then(snapshot => {
        select.innerHTML = '';
        snapshot.forEach(doc => {
            const user = doc.data();
            const selected = allowedStudents.includes(doc.id) ? "selected" : "";
            select.innerHTML += `<option value="${doc.id}" ${selected}>${user.name} (${user.email})</option>`;
        });
    });

    // تحديث دالة الحفظ لتصبح "تحديث الاختبار"
    const examForm = document.getElementById('examForm');
    examForm.onsubmit = (event) => updateExam(event, examId);
}
function updateExam(_0x355190, _0x74e1a1) {
  _0x355190.preventDefault();
  const _0x4686d3 = document.getElementById('examTitle').value;
  const _0x3a6f50 = document.getElementById("examDescription").value;
  const _0x53654f = parseInt(document.getElementById("examDuration").value);
  const _0x5b375b = parseInt(document.getElementById("examTotalMarks").value);
  const _0x17424e = [];
  const _0x4ae654 = document.querySelectorAll(".question-container");
  _0x4ae654.forEach(_0xabbdd4 => {
    const _0x5cf2e0 = _0xabbdd4.querySelector(".question-text").value;
    const _0x57d06e = _0xabbdd4.querySelectorAll(".option-text");
    const _0x341f8a = parseInt(_0xabbdd4.querySelector("input[name^=\"correct-\"]:checked").value);
    const _0x4fb8a6 = Array.from(_0x57d06e).map(_0x3af958 => ({
      'text': _0x3af958.value
    }));
    _0x17424e.push({
      'text': _0x5cf2e0,
      'options': _0x4fb8a6,
      'correctAnswer': _0x341f8a
    });
  });
  db.collection("exams").doc(_0x74e1a1).update({
    'title': _0x4686d3,
    'description': _0x3a6f50,
    'duration': _0x53654f,
    'totalMarks': _0x5b375b,
    'questions': _0x17424e,
    'updatedAt': firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    alert("تم تحديث الاختبار بنجاح!");
    loadAllExams();
  })["catch"](_0x441f4b => {
    alert("حدث خطأ أثناء تحديث الاختبار: " + _0x441f4b.message);
  });
}
document.getElementById('examForm').addEventListener('submit', async function(event) {
  event.preventDefault();
  for (const container of questionContainers) {
    const questionText = container.querySelector(".question-text").value.trim();
    const options = container.querySelectorAll(".option-text");
    const correctAnswerInput = container.querySelector(`input[name^="correct-"]:checked`);
    
    if (!questionText) {
      alert("يرجى إدخال نص السؤال.");
      return;
    }
    
    if (!correctAnswerInput) {
      alert("يرجى تحديد الإجابة الصحيحة لجميع الأسئلة.");
      return;
    }
    
    const optionsArray = Array.from(options).map(option => ({
      text: option.value.trim()
    }));
    
    const correctAnswer = parseInt(correctAnswerInput.value);
    
    questions.push({
      text: questionText,
      options: optionsArray,
      correctAnswer: correctAnswer
    });
  }
  
  try {
    await db.collection("exams").add({
      title: examTitle,
      description: examDescription,
      duration: examDuration,
      totalMarks: examTotalMarks,
      questions: questions,
      createdBy: currentUserData?.name || currentUser.email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      userId: currentUser.uid
    });
    
    alert("تم حفظ الاختبار بنجاح!");
    document.getElementById("examForm").reset();
    document.getElementById("questionsContainer").innerHTML = "";
  } catch (error) {
    alert("حدث خطأ أثناء حفظ الاختبار: " + error.message);
  }
});



// إضافة فصل جديد
document.getElementById("addChapterBtn").addEventListener("click", () => {
    const chaptersContainer = document.getElementById("chaptersContainer");
    const chapterId = Date.now();
    const chapterDiv = document.createElement("div");
    chapterDiv.className = "chapter-item";
    chapterDiv.style = "border:1px solid #0a70ff; border-radius:8px; padding:15px; margin-bottom:15px; background:#f7faff";
    chapterDiv.id = "chapter-" + chapterId;
    chapterDiv.innerHTML = `
        <div class="form-group">
            <label>عنوان الفصل</label>
            <input type="text" class="form-control chapter-title" required>
        </div>
        <div class="form-group">
            <label>دروس الفصل</label>
            <div class="lessonsContainer"></div>
            <button type="button" class="btn btn-success addLessonBtn" style="margin-top:10px;">
                <i class="fas fa-plus"></i> إضافة درس
            </button>
        </div>
        <button type="button" class="btn btn-danger remove-chapter-btn" style="margin-top:10px;">حذف الفصل</button>
    `;
    chaptersContainer.appendChild(chapterDiv);

    // إضافة درس داخل الفصل
    chapterDiv.querySelector(".addLessonBtn").onclick = () => {
        const lessonsContainer = chapterDiv.querySelector(".lessonsContainer");
        const lessonId = Date.now();
        const lessonDiv = document.createElement("div");
        lessonDiv.className = "lesson-item";
        lessonDiv.style = "border:1px solid #eee; border-radius:8px; padding:12px; margin-bottom:10px; background:#f9f9f9";
        lessonDiv.id = "lesson-" + lessonId;
        lessonDiv.innerHTML = `
            <div class="form-group">
                <label>عنوان الدرس</label>
                <input type="text" class="form-control lesson-title" required>
            </div>
            <div class="form-group">
                <label>رابط فيديو الدرس (يوتيوب أو mp4)</label>
                <input type="text" class="form-control lesson-video" placeholder="رابط فيديو الدرس">
            </div>
            <div class="form-group">
                <label>رابط تحميل ملف الدرس (اختياري)</label>
                <input type="text" class="form-control lesson-download" placeholder="رابط تحميل مباشر للملف (اختياري)">
            </div>
            <button type="button" class="btn btn-danger remove-lesson-btn">حذف الدرس</button>
        `;
        lessonsContainer.appendChild(lessonDiv);

        lessonDiv.querySelector(".remove-lesson-btn").onclick = () => {
            lessonDiv.remove();
        };
    };

    // زر حذف الفصل
    chapterDiv.querySelector(".remove-chapter-btn").onclick = () => {
        chapterDiv.remove();
    };
});

// عدل دالة startExam ليتم التحقق من الوقت الدولي قبل السماح بالدخول للاختبار
// دالة لعرض رسالة جميلة أعلى الصفحة
function showExamTimeNotice(message, type = "error") {
    // إذا كانت الرسالة موجودة مسبقاً، احذفها
    const oldNotice = document.getElementById("examTimeNotice");
    if (oldNotice) oldNotice.remove();

    const notice = document.createElement("div");
    notice.id = "examTimeNotice";
    notice.className = `notice notice-${type}`;
    notice.style.position = "fixed";
    notice.style.top = "30px";
    notice.style.right = "30px";
    notice.style.zIndex = "2000";
    notice.style.background = type === "error" ? "#FC5C65" : "#14ee88";
    notice.style.color = "#fff";
    notice.style.padding = "18px 30px";
    notice.style.borderRadius = "10px";
    notice.style.fontSize = "1.2rem";
    notice.style.fontWeight = "bold";
    notice.style.boxShadow = "0 4px 12px rgba(0,0,0,0.12)";
    notice.style.display = "flex";
    notice.style.alignItems = "center";
    notice.style.gap = "12px";
    notice.innerHTML = `
        <i class="fas fa-exclamation-triangle" style="font-size:1.5rem;"></i>
        <span>${message}</span>
        <button style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;margin-right:10px;" onclick="this.parentElement.remove()">&times;</button>
    `;
    document.body.appendChild(notice);

    setTimeout(() => {
        if (notice.parentElement) notice.remove();
    }, 4000);
}

// عدل دالة startExam:
// عدل دالة startExam ليكون منشئ الاختبار (userId) له الحق في أداء الامتحان دائماً
// ...existing code...
async function startExam(exam, examId) {
    // تحقق من صلاحية الطالب أو منشئ الاختبار
    const isAllowed =
        !exam.allowedStudents ||
        exam.allowedStudents.length === 0 ||
        (currentUser && exam.allowedStudents.includes(currentUser.uid)) ||
        (currentUser && exam.userId === currentUser.uid); // منشئ الاختبار

    if (!isAllowed) {
        showExamTimeNotice("عذرًا، لا يمكنك بدء هذا الاختبار. لم يتم منحك الإذن.", "error");
        return;
    }

    // تحقق من الوقت الدولي
    if (exam.startTime && exam.endTime) {
        const nowUTC = Date.now();
        const startUTC = new Date(exam.startTime).getTime();
        const endUTC = new Date(exam.endTime).getTime();

        if (nowUTC < startUTC) {
            showExamTimeNotice("لم يبدأ وقت الامتحان بعد.", "error");
            return;
        }
        if (nowUTC > endUTC) {
            showExamTimeNotice("انتهى وقت الامتحان.", "error");
            return;
        }
    }

    // دعم استكمال الجلسة بعد reload مع نافذة منبثقة جميلة
    let sessionData = null;
    try {
        sessionData = JSON.parse(localStorage.getItem("examSession"));
    } catch {}
    if (
        sessionData &&
        sessionData.examId === examId &&
        sessionData.userAnswers &&
        typeof sessionData.currentQuestionIndex === "number"
    ) {
        showResumeExamModal(
            // استكمال
            () => {
                userAnswers = sessionData.userAnswers;
                currentQuestionIndex = sessionData.currentQuestionIndex;
                timeLeft = typeof sessionData.timeLeft === "number" ? sessionData.timeLeft : (exam.duration * 60);
                continueStartExam();
            },
            // بدء من جديد
            () => {
                userAnswers = {};
                currentQuestionIndex = 0;
                timeLeft = exam.duration * 60;
                localStorage.removeItem("examSession");
                continueStartExam();
            }
        );
        return; // انتظر اختيار المستخدم
    } else {
        userAnswers = {};
        currentQuestionIndex = 0;
        timeLeft = exam.duration * 60;
    }

    continueStartExam();

    // دالة داخلية لتشغيل الامتحان بعد اختيار المستخدم
    function continueStartExam() {
        currentExam = {
            ...exam,
            'id': examId
        };
        updateTimerDisplay();
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            saveExamSession(); // حفظ الجلسة كل ثانية
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                finalizeExamSubmission();
            }
        }, 1000);
        loadQuestion(currentQuestionIndex);

        // تفعيل أزرار التالي/السابق/انهاء عند استكمال الجلسة
        document.getElementById("prevQuestionBtn").disabled = currentQuestionIndex === 0;
        document.getElementById("nextQuestionBtn").disabled = currentQuestionIndex === currentExam.questions.length - 1;
        document.getElementById("nextQuestionBtn").style.display = currentExam.questions.length <= 1 ? "none" : "inline-block";
        document.getElementById("prevQuestionBtn").style.display = currentExam.questions.length <= 1 ? "none" : "inline-block";
        document.getElementById("submitExamBtn").style.display = "inline-block";

        document.getElementById("examViewTitle").textContent = exam.title;
        document.getElementById("questionCount").textContent = exam.questions.length;
        document.getElementById("totalMarks").textContent = exam.totalMarks || 100;
        showPage(takeExamPage);
    }
}
// زر قفل كل الطلاب
document.getElementById("lockAllStudentsBtn").onclick = async function() {
  if (!confirm("هل أنت متأكد أنك تريد قفل جميع الطلاب؟")) return;
  const snapshot = await db.collection("users").where("role", "==", "student").get();
  if (snapshot.empty) {
    showToast("لا يوجد طلاب لقفلهم.", "error");
    return;
  }
  const batch = db.batch();
  snapshot.forEach(doc => {
    db.collection("studentLocks").doc(doc.id).set({
      locked: true,
      message: "يتم رفع امتحان انتظر قليلاً",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  });
  showToast("تم قفل جميع الطلاب بنجاح!", "success");
};

// زر إلغاء قفل كل الطلاب
document.getElementById("unlockAllStudentsBtn").onclick = async function() {
  if (!confirm("هل أنت متأكد أنك تريد إلغاء قفل جميع الطلاب؟")) return;
  const snapshot = await db.collection("users").where("role", "==", "student").get();
  if (snapshot.empty) {
    showToast("لا يوجد طلاب لإلغاء القفل عنهم.", "error");
    return;
  }
  const batch = db.batch();
  snapshot.forEach(doc => {
    db.collection("studentLocks").doc(doc.id).delete();
  });
  showToast("تم إلغاء قفل جميع الطلاب بنجاح!", "success");
};
// عند انتهاء الوقت المتبقي يتم تسليم الاختبار تلقائياً حتى لو لم يتم حل أي سؤال
// عدل دالة startExam ليتم تفعيل أزرار التالي/السابق/انهاء عند استكمال الجلسة
// ...existing code...

function showResumeExamModal(onContinue, onRestart) {
    let modal = document.getElementById("resumeExamModal");
    if (!modal) {
        modal = document.createElement("div");
        modal.id = "resumeExamModal";
        modal.className = "modal";
        modal.innerHTML = `
            <div class="modal-content">
                <h2 class="modal-title" style="color:#0a70ff;">استكمال الامتحان</h2>
                <p class="modal-message" style="font-size:1.1rem;">
                    لديك امتحان لم ينتهِ بعد.<br>
                    هل تريد <b>استكمال الامتحان</b> من حيث توقفت أم <b>البدء من جديد</b>؟
                </p>
                <div class="modal-actions" style="display:flex;gap:10px;">
                    <button id="resumeExamBtn" class="btn btn-success" style="flex:1;">استكمال</button>
                    <button id="restartExamBtn" class="btn btn-danger" style="flex:1;">بدء من جديد</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    modal.style.display = "flex";

    // تحقق من الوقت المتبقي قبل السماح بالاستكمال
    document.getElementById("resumeExamBtn").onclick = () => {
        // جلب بيانات الجلسة من localStorage
        let sessionData = null;
        try {
            sessionData = JSON.parse(localStorage.getItem("examSession"));
        } catch {}
        // إذا انتهى الوقت لا تسمح بالاستكمال
        if (sessionData && typeof sessionData.timeLeft === "number" && sessionData.timeLeft <= 0) {
            modal.style.display = "none";
            showExamTimeNotice("انتهى وقت الامتحان ولا يمكنك استكماله.", "error");
            localStorage.removeItem("examSession");
            return;
        }
        modal.style.display = "none";
        onContinue();
    };
    document.getElementById("restartExamBtn").onclick = () => {
        modal.style.display = "none";
        onRestart();
    };
}

// ...existing code...

// ...existing code...
// ...existing code...

// دالة حذف جميع نتائج اختبر نفسك
document.getElementById("deleteAllSelfTestResultsBtn").addEventListener("click", async function () {
    if (!confirm("هل أنت متأكد أنك تريد حذف جميع نتائج اختبر نفسك؟ لا يمكن التراجع عن هذا الإجراء.")) {
        return;
    }
    let query = db.collection("selfTestResults");
    // إذا كان الطالب، احذف نتائجه فقط
    if (userRole !== "teacher") {
        query = query.where("userId", "==", currentUser.uid);
    }
    const snapshot = await query.get();
    if (snapshot.empty) {
        alert("لا توجد نتائج لحذفها.");
        return;
    }
    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    alert("تم حذف جميع النتائج بنجاح!");
    loadSelfTestResults();
});
function saveExamSession() {
    if (!currentExam) return;
    const sessionData = {
        examId: currentExam.id,
        userAnswers,
        currentQuestionIndex,
        timeLeft
    };
    localStorage.setItem("examSession", JSON.stringify(sessionData));
}
// ...existing code...

function updateProgressBar() {
    const progressBar = document.getElementById("progressBar");
    const progressPercentage = Math.round(((currentQuestionIndex + 1) / currentExam.questions.length) * 100);
    progressBar.style.width = progressPercentage + "%";
    progressBar.textContent = progressPercentage + "%"; // تحديث النص داخل شريط التقدم
}

// ضع هذا الكود في ملف <script> في آخر الصفحة أو بعد تحميل الصفحة مباشرة

// دالة لعرض رسالة جميلة عند ضعف أو انقطاع الإنترنت
function showNetworkStatusMessage(isOffline) {
    // إذا كانت الرسالة موجودة مسبقاً، احذفها
    let netMsg = document.getElementById("networkStatusMessage");
    if (!netMsg) {
        netMsg = document.createElement("div");
        netMsg.id = "networkStatusMessage";
        netMsg.style.position = "fixed";
        netMsg.style.top = "30px";
        netMsg.style.right = "30px";
        netMsg.style.background = "#fc5c65";
        netMsg.style.color = "#fff";
        netMsg.style.padding = "18px 30px";
        netMsg.style.borderRadius = "10px";
        netMsg.style.fontSize = "1.1rem";
        netMsg.style.fontWeight = "bold";
        netMsg.style.boxShadow = "0 4px 12px rgba(0,0,0,0.12)";
        netMsg.style.zIndex = "3000";
        netMsg.style.display = "flex";
        netMsg.style.alignItems = "center";
        netMsg.style.gap = "12px";
        netMsg.innerHTML = `
            <i class="fas fa-wifi"></i>
            <span id="networkStatusText"></span>
            <button style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;margin-right:10px;" onclick="this.parentElement.remove()">&times;</button>
        `;
        document.body.appendChild(netMsg);
    }
    const text = document.getElementById("networkStatusText");
    if (isOffline) {
        text.textContent = "⚠️ الاتصال بالإنترنت ضعيف أو غير متوفر. يرجى التأكد من الشبكة!";
        netMsg.style.background = "#fc5c65";
        netMsg.style.display = "flex";
    } else {
        text.textContent = "✅ تم استعادة الاتصال بالإنترنت.";
        netMsg.style.background = "#14ee88";
        netMsg.style.display = "flex";
        setTimeout(() => {
            if (netMsg.parentElement) netMsg.style.display = "none";
        }, 2500);
    }
}

// مراقبة حالة الاتصال بالإنترنت
window.addEventListener('offline', () => showNetworkStatusMessage(true));
window.addEventListener('online', () => showNetworkStatusMessage(false));

// يمكنك أيضاً فحص سرعة الإنترنت بشكل بسيط (اختياري)
// إذا أردت تنبيه المستخدم عند بطء الشبكة وليس فقط الانقطاع الكامل
function checkConnectionSpeed() {
    const img = new Image();
    const start = Date.now();
    img.onload = function () {
        const duration = Date.now() - start;
        // إذا استغرق تحميل الصورة أكثر من 3 ثواني اعتبر الاتصال بطيء
        if (duration > 3000) {
            showNetworkStatusMessage(true);
        }
    };
    img.onerror = function () {
        showNetworkStatusMessage(true);
    };
    // استخدم صورة صغيرة من الإنترنت (يفضل صورة سريعة التحميل)
    img.src = "https://www.google.com/images/phd/px.gif?t=" + Math.random();
}
// افحص سرعة الاتصال كل دقيقة
setInterval(checkConnectionSpeed, 60000);

// ...existing code...
function loadSelfTestQuestion(index) {
    const question = currentExam.questions[index];
    const questionContainer = document.getElementById("selfTestQuestion");
    const feedbackContainer = document.getElementById("feedbackContainer");

    feedbackContainer.style.display = "none";
    feedbackContainer.innerHTML = '';

    // عرض صورة السؤال بشكل جميل إذا كانت موجودة
    let imageHtml = "";
    if (question.imageUrl && question.imageUrl.trim() !== "") {
        imageHtml = `
            <div class="question-image-container" style="display:flex;justify-content:center;align-items:center;margin: 20px 0;">
                <img src="${question.imageUrl}" alt="صورة السؤال" class="question-image"
                    style="display:block;max-width:100%;max-height:350px;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,0.13);border:4px solid #0a70ff;background:#fff;object-fit:contain;">
            </div>
        `;
    }

    questionContainer.innerHTML = `
        <div class="question-card">
            <h3 class="question-text">السؤال ${index + 1}: ${question.text}</h3>
            ${imageHtml}
            <ul class="options-list">
                ${question.options.map((option, i) => `
                    <li>
                        <label class="option-label">
                            <input type="radio" name="selfTestQuestion_${index}" value="${i}" class="option-input">
                            ${option.text}
                        </label>
                    </li>
                `).join('')}
            </ul>
        </div>
    `;

    document.querySelectorAll('.option-label').forEach(label => {
        label.addEventListener('click', function () {
            document.querySelectorAll(".option-label").forEach(label => label.classList.remove("selected"));
            this.classList.add("selected");
            const input = this.querySelector("input");
            input.checked = true;
            userAnswers[index] = parseInt(input.value);
            showFeedback(index);
        });
    });

    // تحديث عرض الأزرار
    document.getElementById("prevSelfTestQuestionBtn").style.display = index > 0 ? "inline-block" : "none";
    document.getElementById("nextSelfTestQuestionBtn").style.display = index < currentExam.questions.length - 1 ? "inline-block" : "none";
    document.getElementById("finishSelfTestBtn").style.display = index === currentExam.questions.length - 1 ? "inline-block" : "none";

    // تحديث شريط التقدم
    updateProgressBar();
}
// ...existing code...
document.getElementById("prevSelfTestQuestionBtn").addEventListener("click", () => {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--; // تقليل قيمة المؤشر
        loadSelfTestQuestion(currentQuestionIndex); // تحميل السؤال السابق
    }
});
function loadQuestion(_0x538241) {
  const _0x707c01 = document.getElementById("examQuestionsContainer");
  const _0x441106 = currentExam.questions[_0x538241];

  // إنشاء محتوى السؤال مع الصورة (إذا كانت موجودة)
  _0x707c01.innerHTML = `
    <div class="question-card">
      <h3 class="question-text">السؤال ${_0x538241 + 1}: ${_0x441106.text}</h3>
      ${_0x441106.imageUrl ? `<div class="question-image-container"><img src="${_0x441106.imageUrl}" alt="صورة السؤال" class="question-image"></div>` : ''}
      <ul class="options-list">
        ${_0x441106.options.map((_0x5df737, _0x344f3e) => `
          <li>
            <label class="option-label ${userAnswers[_0x538241] === _0x344f3e ? "selected" : ''}">
              <input type="radio" name="question_${_0x538241}" value="${_0x344f3e}" 
                     class="option-input" ${userAnswers[_0x538241] === _0x344f3e ? "checked" : ''}>
              ${_0x5df737.text}
            </label>
          </li>
        `).join('')}
      </ul>
    </div>
  `;

  // إضافة الأحداث لتحديد الإجابة
  document.querySelectorAll(".option-label").forEach(_0x42b4d1 => {
    _0x42b4d1.addEventListener("click", function () {
      document.querySelectorAll(".option-label").forEach(_0x15296b => {
        _0x15296b.classList.remove("selected");
      });
      this.classList.add("selected");
      const _0x4d81a3 = this.querySelector('input');
      _0x4d81a3.checked = true;
      userAnswers[_0x538241] = parseInt(_0x4d81a3.value);
      saveExamSession(); // حفظ الجلسة عند اختيار إجابة
    });
  });

  // التحكم في أزرار التنقل بين الأسئلة
  document.getElementById("prevQuestionBtn").disabled = _0x538241 === 0;
  document.getElementById("nextQuestionBtn").disabled = _0x538241 === currentExam.questions.length - 1;
  saveExamSession(); // حفظ الجلسة عند التنقل بين الأسئلة
}

function updateTimerDisplay() {
  const _0xfe0f84 = Math.floor(timeLeft / 0x3c);
  const _0x5494f4 = timeLeft % 0x3c;
  document.getElementById("timeRemaining").textContent = _0xfe0f84 + ':' + (_0x5494f4 < 0xa ? '0' : '') + _0x5494f4;
  saveExamSession(); // حفظ الوقت المتبقي
}
function submitExam() {
    // التحقق من وجود أسئلة غير مجابة
    const unansweredQuestions = [];
    currentExam.questions.forEach((question, index) => {
        if (userAnswers[index] === undefined) {
            unansweredQuestions.push(index + 1); // إضافة رقم السؤال غير المجاب
        }
    });

    if (unansweredQuestions.length > 0) {
        // عرض النافذة المنبثقة
        const modal = document.getElementById("unansweredQuestionsModal");
        const message = document.getElementById("unansweredQuestionsMessage");
        message.textContent = `هناك ${unansweredQuestions.length} سؤال/أسئلة لم يتم الإجابة عليها: ${unansweredQuestions.join(", ")}. هل تريد بالتأكيد تسليم الاختبار؟`;
        modal.style.display = "flex";

        // إضافة أحداث للأزرار
        document.getElementById("continueSubmitBtn").onclick = () => {
            modal.style.display = "none";
            finalizeExamSubmission(); // متابعة تسليم الاختبار
        };
        document.getElementById("cancelSubmitBtn").onclick = () => {
            modal.style.display = "none"; // إغلاق النافذة
        };
        return;
    }

    // إذا لم تكن هناك أسئلة غير مجابة، تابع التسليم مباشرة
    finalizeExamSubmission();
}

function finalizeExamSubmission() {
    clearInterval(timerInterval);
    localStorage.removeItem("examSession"); // حذف الجلسة بعد التسليم
    // ...باقي الكود كما هو...
    let correctAnswers = 0;
    currentExam.questions.forEach((question, index) => {
        if (userAnswers[index] === question.correctAnswer) {
            correctAnswers++;
        }
    });

    const totalQuestions = currentExam.questions.length;
    const scorePercentage = Math.round((correctAnswers / totalQuestions) * 100);
    const wrongAnswers = totalQuestions - correctAnswers;
    const timeTaken = currentExam.duration - Math.ceil(timeLeft / 60);
    const totalMarks = currentExam.totalMarks || 100;
    const obtainedMarks = Math.round((correctAnswers / totalQuestions) * totalMarks);

    let gradeStatus;
    if (scorePercentage >= 90) {
        gradeStatus = "ممتاز";
    } else if (scorePercentage >= 75) {
        gradeStatus = "جيد جداً";
    } else if (scorePercentage >= 60) {
        gradeStatus = "جيد";
    } else if (scorePercentage >= 50) {
        gradeStatus = "مقبول";
    } else {
        gradeStatus = "راسب";
    }

    // حفظ النتيجة في قاعدة البيانات
    db.collection("results").add({
        userId: currentUser.uid,
        userName: currentUserData?.["name"] || currentUser.email,
        examId: currentExam.id,
        examTitle: currentExam.title,
        totalMarks: totalMarks,
        obtainedMarks: obtainedMarks,
        scorePercentage: scorePercentage,
        correctAnswers: correctAnswers,
        wrongAnswers: wrongAnswers,
        timeTaken: timeTaken,
        gradeStatus: gradeStatus,
        answers: userAnswers,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
    });

    db.collection("users").doc(currentUser.uid).update({
        examsTaken: firebase.firestore.FieldValue.increment(1),
        lastExamTaken: firebase.firestore.FieldValue.serverTimestamp(),
    });

    showResults(scorePercentage, correctAnswers, wrongAnswers, timeTaken, obtainedMarks, totalMarks);
}
function showResults(_0x2b8ae2, _0x4afa89, _0x22af06, _0x16cabf, _0x1424a5, _0xd71135) {
  document.getElementById("finalScore").textContent = _0x2b8ae2 + '%';
  document.getElementById("correctAnswers").textContent = _0x4afa89;
  document.getElementById("wrongAnswers").textContent = _0x22af06;
  document.getElementById("timeTaken").textContent = _0x16cabf;
  document.getElementById("obtainedMarks").textContent = _0x1424a5 + " / " + _0xd71135;
  const _0x1d6448 = document.getElementById("resultsDetails");
  _0x1d6448.innerHTML = "<h3>تفاصيل الإجابات:</h3>";
  currentExam.questions.forEach((_0x2059a8, _0xaa318d) => {
    const _0x1a2432 = userAnswers[_0xaa318d];
    const _0x299730 = _0x1a2432 === _0x2059a8.correctAnswer;
    const _0x4b1aa3 = document.createElement("div");
    _0x4b1aa3.className = "result-question";
    _0x4b1aa3.innerHTML = "\n                    <p><strong>السؤال " + (_0xaa318d + 0x1) + ":</strong> " + _0x2059a8.text + "</p>\n                    <p>إجابتك: <span class=\"" + (_0x299730 ? 'correct-answer' : "wrong-answer") + "\">\n                        " + (_0x1a2432 !== undefined ? _0x2059a8.options[_0x1a2432].text : "لم تجب") + "\n                    </span></p>\n                    <p>الإجابة الصحيحة: <span class=\"correct-answer\">\n                        " + _0x2059a8.options[_0x2059a8.correctAnswer].text + "\n                    </span></p>\n                ";
    _0x1d6448.appendChild(_0x4b1aa3);
  });
  showPage(resultsPage);
}
function viewExamResults(_0x1c414d) {
  alert("عرض نتائج الاختبار سيكون هنا");
}
function loadStudentGrades() {
  const _0x535c23 = document.getElementById('studentGradesTable');
  _0x535c23.innerHTML = "<tr><td colspan=\"6\">جاري تحميل الدرجات...</td></tr>";
  db.collection("results").where('userId', '==', currentUser.uid).orderBy("submittedAt", "desc").get().then(_0xb3b970 => {
    if (_0xb3b970.empty) {
      _0x535c23.innerHTML = "<tr><td colspan=\"6\">لا توجد نتائج مسجلة بعد</td></tr>";
      return;
    }
    _0x535c23.innerHTML = '';
    _0xb3b970.forEach(_0xdc4be4 => {
      const _0x1fe8dd = _0xdc4be4.data();
      const _0x11110f = _0x1fe8dd.submittedAt?.["toDate"]() || new Date();
      const _0x5589bb = _0x11110f.toLocaleDateString() + " " + _0x11110f.toLocaleTimeString();
      let _0x3a8940 = "grade-poor";
      if (_0x1fe8dd.scorePercentage >= 0x5a) {
        _0x3a8940 = "grade-excellent";
      } else {
        if (_0x1fe8dd.scorePercentage >= 0x4b) {
          _0x3a8940 = "grade-good";
        } else {
          if (_0x1fe8dd.scorePercentage >= 0x3c) {
            _0x3a8940 = "grade-average";
          }
        }
      }
      _0x535c23.innerHTML += "\n                    <tr>\n                        <td>" + _0x1fe8dd.examTitle + "</td>\n                        <td>" + _0x5589bb + "</td>\n                        <td>" + _0x1fe8dd.obtainedMarks + " / " + _0x1fe8dd.totalMarks + "</td>\n                        <td>" + _0x1fe8dd.scorePercentage + "%</td>\n                        <td><span class=\"grade-badge " + _0x3a8940 + "\">" + _0x1fe8dd.gradeStatus + "</span></td>\n                    </tr>\n                ";
    });
  })["catch"](_0xb0786e => {
    _0x535c23.innerHTML = "<tr><td colspan=\"6\">حدث خطأ: " + _0xb0786e.message + "</td></tr>";
  });
}
function loadAllGrades() {
  const _0x278ebd = document.getElementById("allGradesTable");
  _0x278ebd.innerHTML = "<tr><td colspan=\"6\">جاري تحميل الدرجات...</td></tr>";
  const _0x469a27 = document.getElementById('gradeExamFilter');
  _0x469a27.innerHTML = "<option value=\"\">جميع الاختبارات</option>";
  db.collection('exams').get().then(_0x1e6309 => {
    _0x1e6309.forEach(_0x185996 => {
      const _0x212a78 = _0x185996.data();
      _0x469a27.innerHTML += "<option value=\"" + _0x185996.id + "\">" + _0x212a78.title + '</option>';
    });
    return loadFilteredGrades();
  })["catch"](_0x347d4d => {
    _0x278ebd.innerHTML = "<tr><td colspan=\"6\">حدث خطأ: " + _0x347d4d.message + '</td></tr>';
  });
}
// تأكد من استدعاء هذه الدالة عند فتح صفحة إدارة "اختبر نفسك"
function loadStudentsForSelfTest(selectedStudents = []) {
    const select = document.getElementById("allowedSelfTestStudents");
    if (!select) return;
    select.innerHTML = "<option value=\"\">جاري تحميل الطلاب...</option>";
    // جلب جميع الطلاب والمعلمين
    db.collection('users').where("role", "in", ["student", "teacher"]).get().then(snapshot => {
        select.innerHTML = '';
        snapshot.forEach(doc => {
            const user = doc.data();
            const selected = selectedStudents.includes(doc.id) ? "selected" : "";
            select.innerHTML += `<option value="${doc.id}" ${selected}>${user.name} (${user.email})${user.role === "teacher" ? " - معلم" : ""}</option>`;
        });
    }).catch(error => {
        select.innerHTML = `<option value="">حدث خطأ أثناء تحميل الطلاب: ${error.message}</option>`;
    });
}

// استدعِ الدالة عند فتح صفحة إدارة اختبر نفسك
document.getElementById("menuManageSelfTest").addEventListener("click", () => {
  editingSelfTestId = null;
  loadStudentsForSelfTest();
  // ...أي كود آخر...
});

function loadFilteredGrades() {
  const _0x3d68e7 = document.getElementById("allGradesTable");
  const _0x45a810 = document.getElementById("gradeExamFilter");
  const _0x11468c = _0x45a810.value;
  _0x3d68e7.innerHTML = "<tr><td colspan=\"6\">جاري تحميل الدرجات...</td></tr>";
  let _0x4f256a = db.collection("results").orderBy("submittedAt", 'desc');
  if (_0x11468c) {
    _0x4f256a = _0x4f256a.where("examId", '==', _0x11468c);
  }
  _0x4f256a.get().then(_0x3f83d0 => {
    if (_0x3f83d0.empty) {
      _0x3d68e7.innerHTML = "<tr><td colspan=\"6\">لا توجد نتائج مسجلة بعد</td></tr>";
      return;
    }
    _0x3d68e7.innerHTML = '';
    _0x3f83d0.forEach(_0x568af2 => {
      const _0x2dd621 = _0x568af2.data();
      const _0x2174c7 = _0x2dd621.submittedAt?.["toDate"]() || new Date();
      let _0x222322 = "grade-poor";
      if (_0x2dd621.scorePercentage >= 0x5a) {
        _0x222322 = "grade-excellent";
      } else {
        if (_0x2dd621.scorePercentage >= 0x4b) {
          _0x222322 = "grade-good";
        } else {
          if (_0x2dd621.scorePercentage >= 0x3c) {
            _0x222322 = "grade-average";
          }
        }
      }
      _0x3d68e7.innerHTML += "\n                            <tr>\n                                <td>" + _0x2dd621.userName + "</td>\n                                <td>" + _0x2dd621.examTitle + "</td>\n                                <td>" + _0x2174c7.toLocaleDateString() + "</td>\n                                <td>" + _0x2dd621.obtainedMarks + " / " + _0x2dd621.totalMarks + "</td>\n                                <td>" + _0x2dd621.scorePercentage + "%</td>\n                                <td><span class=\"grade-badge " + _0x222322 + "\">" + _0x2dd621.gradeStatus + "</span></td>\n                            </tr>\n                        ";
    });
  })["catch"](_0x10d888 => {
    _0x3d68e7.innerHTML = "<tr><td colspan=\"6\">حدث خطأ: " + _0x10d888.message + "</td></tr>";
  });
}
function loadSlides() {
  const _0x38b0a0 = document.getElementById("slidesGrid");
  _0x38b0a0.innerHTML = "<p>جاري تحميل الشرائح...</p>";
  db.collection("slides").orderBy("createdAt", "desc").get().then(_0x13a84a => {
    if (_0x13a84a.empty) {
      _0x38b0a0.innerHTML = "<p>لا توجد شرائح متاحة حالياً</p>";
      return;
    }
    _0x38b0a0.innerHTML = '';
    _0x13a84a.forEach(_0x4ef1b5 => {
      const _0xe075fc = _0x4ef1b5.data();
      _0x38b0a0.appendChild(createSlideCard(_0xe075fc, _0x4ef1b5.id));
    });
  })["catch"](_0x49200f => {
    _0x38b0a0.innerHTML = "<p>حدث خطأ أثناء تحميل الشرائح: " + _0x49200f.message + "</p>";
  });
}
function createSlideCard(slide, slideId) {
    const card = document.createElement("div");
    card.className = "slide-card";
    const header = document.createElement('div');
    header.className = 'slide-card-header';
    header.innerHTML = `<i class="fas fa-chalkboard-teacher"></i> ${slide.title}`;
    const body = document.createElement('div');
    body.className = "slide-card-body";
    body.style.display = "none"; // إخفاء الفصول افتراضياً

    // عرض محتوى الشريحة (النص الرئيسي)
    if (slide.content && slide.content.trim() !== "") {
        body.innerHTML += `<div style="margin-bottom:18px; color:#222; font-size:1.1rem; line-height:2;">${slide.content}</div>`;
    }

    // عرض الفصول والدروس
    if (slide.chapters && Array.isArray(slide.chapters) && slide.chapters.length > 0) {
        slide.chapters.forEach((chapter, cIdx) => {
            const chapterId = `chapter-details-${slideId}-${cIdx}`;
            const chapterDiv = document.createElement("div");
            chapterDiv.style = "margin-bottom:18px; background:#eaf3ff; border-radius:10px; padding:0; box-shadow:0 2px 8px rgba(0,0,0,0.04);";

            // زر الفصل (ينسدل عند الضغط)
            const chapterBtn = document.createElement("button");
            chapterBtn.className = "btn btn-primary";
            chapterBtn.style = "width:100%; text-align:right; border-radius:10px 10px 0 0; font-size:1.1rem; padding:14px 18px; background:#0a70ff; color:#fff; border:none; outline:none;";
            chapterBtn.innerHTML = `<i class="fas fa-chevron-down"></i> ${chapter.title}`;
            chapterBtn.onclick = function () {
                const details = document.getElementById(chapterId);
                if (details.style.display === "none" || !details.style.display) {
                    details.style.display = "block";
                    chapterBtn.querySelector("i").className = "fas fa-chevron-up";
                } else {
                    details.style.display = "none";
                    chapterBtn.querySelector("i").className = "fas fa-chevron-down";
                }
            };

            // محتوى الفصل (الدروس)
            const chapterDetails = document.createElement("div");
            chapterDetails.id = chapterId;
            chapterDetails.style = "display:none; padding:12px; background:#f9f9f9; border-radius:0 0 10px 10px;";
            if (chapter.lessons && chapter.lessons.length > 0) {
                chapter.lessons.forEach((lesson, lIdx) => {
                    const lessonDiv = document.createElement("div");
                    lessonDiv.style = "margin-bottom:10px; background:#fff; border-radius:8px; padding:10px; box-shadow:0 1px 4px rgba(0,0,0,0.03);";
                    lessonDiv.innerHTML = `
                        <strong><i class="fas fa-play-circle"></i> ${lesson.title}</strong>
                        <div style="margin-top:8px;">
                            ${lesson.video ? `<button class="btn btn-success" style="margin-bottom:7px;" onclick="showLessonVideoModal('${lesson.video}')"><i class="fas fa-play"></i> مشاهدة الفيديو</button>` : ""}
                            ${lesson.download ? `<a class="btn btn-download" href="${lesson.download}" download style="margin-right:7px;"><i class="fas fa-download"></i> تنزيل الملف</a>` : ""}
                        </div>
                    `;
                    chapterDetails.appendChild(lessonDiv);
                });
            } else {
                chapterDetails.innerHTML = `<div style="color:#888;">لا يوجد دروس في هذا الفصل.</div>`;
            }

            chapterDiv.appendChild(chapterBtn);
            chapterDiv.appendChild(chapterDetails);
            body.appendChild(chapterDiv);
        });
    }

    // تذييل الشريحة
    const footer = document.createElement('div');
    footer.className = "slide-card-footer";
    footer.innerHTML = `
        <span><i class="fas fa-user"></i> ${slide.createdBy || "مجهول"}</span>
        <span><i class="fas fa-calendar-alt"></i> ${slide.createdAt && slide.createdAt.toDate ? new Date(slide.createdAt.toDate()).toLocaleDateString() : ""}</span>
    `;
    if (userRole === "teacher") {
        // زر تعديل الشريحة
        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-outline";
        editBtn.textContent = 'تعديل';
        editBtn.style.marginLeft = "10px";
        editBtn.addEventListener("click", () => editSlide(slide, slideId));
        footer.appendChild(editBtn);

        // زر حذف الشريحة
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger";
        delBtn.textContent = 'حذف';
        delBtn.addEventListener("click", () => confirmDeleteSlide(slideId));
        footer.appendChild(delBtn);
    }

    // عند الضغط على رأس الشريحة تظهر/تخفي الفصول وتخفي باقي الشرائح المفتوحة
    header.style.cursor = "pointer";
    header.onclick = function () {
        // إغلاق جميع الشرائح الأخرى
        document.querySelectorAll('.slide-card-body').forEach(b => {
            if (b !== body) b.style.display = "none";
        });
        // فتح/إغلاق الشريحة الحالية
        body.style.display = (body.style.display === "none" || !body.style.display) ? "block" : "none";
    };

    card.appendChild(header);
    card.appendChild(body);
    card.appendChild(footer);
    return card;
}
// دالة تعديل الشريحة
// دالة تعديل الشريحة
function editSlide(slide, slideId) {
    setActiveMenuItem(menuCreateSlide);
    showPage(createSlidePage);

    // تعبئة بيانات الشريحة
    document.getElementById("slideTitle").value = slide.title || "";

    // إذا كان لديك حقل محتوى الشريحة (نصي)، عبئه هنا
    if (document.getElementById("slideContent")) {
        document.getElementById("slideContent").value = slide.content || "";
    }

    // تفريغ الفصول القديمة
    const chaptersContainer = document.getElementById("chaptersContainer");
    chaptersContainer.innerHTML = "";

    // إعادة بناء الفصول والدروس
    if (slide.chapters && Array.isArray(slide.chapters)) {
        slide.chapters.forEach((chapter, cIdx) => {
            const chapterId = Date.now() + cIdx;
            const chapterDiv = document.createElement("div");
            chapterDiv.className = "chapter-item";
            chapterDiv.style = "border:1px solid #0a70ff; border-radius:8px; padding:15px; margin-bottom:15px; background:#f7faff";
            chapterDiv.id = "chapter-" + chapterId;
            chapterDiv.innerHTML = `
                <div class="form-group">
                    <label>عنوان الفصل</label>
                    <input type="text" class="form-control chapter-title" value="${chapter.title || ""}" required>
                </div>
                <div class="form-group">
                    <label>دروس الفصل</label>
                    <div class="lessonsContainer"></div>
                    <button type="button" class="btn btn-success addLessonBtn" style="margin-top:10px;">
                        <i class="fas fa-plus"></i> إضافة درس
                    </button>
                </div>
                <button type="button" class="btn btn-danger remove-chapter-btn" style="margin-top:10px;">حذف الفصل</button>
            `;
            chaptersContainer.appendChild(chapterDiv);

            // إضافة الدروس
            const lessonsContainer = chapterDiv.querySelector(".lessonsContainer");
            if (chapter.lessons && Array.isArray(chapter.lessons)) {
                chapter.lessons.forEach((lesson, lIdx) => {
                    const lessonId = Date.now() + lIdx;
                    const lessonDiv = document.createElement("div");
                    lessonDiv.className = "lesson-item";
                    lessonDiv.style = "border:1px solid #eee; border-radius:8px; padding:12px; margin-bottom:10px; background:#f9f9f9";
                    lessonDiv.id = "lesson-" + lessonId;
                    lessonDiv.innerHTML = `
                        <div class="form-group">
                            <label>عنوان الدرس</label>
                            <input type="text" class="form-control lesson-title" value="${lesson.title || ""}" required>
                        </div>
                        <div class="form-group">
                            <label>رابط فيديو الدرس (يوتيوب أو mp4)</label>
                            <input type="text" class="form-control lesson-video" value="${lesson.video || ""}" placeholder="رابط فيديو الدرس">
                        </div>
                        <div class="form-group">
                            <label>رابط تحميل ملف الدرس (اختياري)</label>
                            <input type="text" class="form-control lesson-download" value="${lesson.download || ""}" placeholder="رابط تحميل مباشر للملف (اختياري)">
                        </div>
                        <button type="button" class="btn btn-danger remove-lesson-btn">حذف الدرس</button>
                    `;
                    lessonsContainer.appendChild(lessonDiv);

                    lessonDiv.querySelector(".remove-lesson-btn").onclick = () => {
                        lessonDiv.remove();
                    };
                });
            }

            // زر إضافة درس جديد
            chapterDiv.querySelector(".addLessonBtn").onclick = () => {
                const lessonsContainer = chapterDiv.querySelector(".lessonsContainer");
                const lessonId = Date.now();
                const lessonDiv = document.createElement("div");
                lessonDiv.className = "lesson-item";
                lessonDiv.style = "border:1px solid #eee; border-radius:8px; padding:12px; margin-bottom:10px; background:#f9f9f9";
                lessonDiv.id = "lesson-" + lessonId;
                lessonDiv.innerHTML = `
                    <div class="form-group">
                        <label>عنوان الدرس</label>
                        <input type="text" class="form-control lesson-title" required>
                    </div>
                    <div class="form-group">
                        <label>رابط فيديو الدرس (يوتيوب أو mp4)</label>
                        <input type="text" class="form-control lesson-video" placeholder="رابط فيديو الدرس">
                    </div>
                    <div class="form-group">
                        <label>رابط تحميل ملف الدرس (اختياري)</label>
                        <input type="text" class="form-control lesson-download" placeholder="رابط تحميل مباشر للملف (اختياري)">
                    </div>
                    <button type="button" class="btn btn-danger remove-lesson-btn">حذف الدرس</button>
                `;
                lessonsContainer.appendChild(lessonDiv);

                lessonDiv.querySelector(".remove-lesson-btn").onclick = () => {
                    lessonDiv.remove();
                };
            };

            // زر حذف الفصل
            chapterDiv.querySelector(".remove-chapter-btn").onclick = () => {
                chapterDiv.remove();
            };
        });
    }

    // تغيير زر الحفظ ليقوم بالتحديث بدلاً من الإضافة
    const slideForm = document.getElementById("slideForm");
    slideForm.onsubmit = async function(e) {
        e.preventDefault();
        const chaptersContainer = document.getElementById("chaptersContainer");
        const chapterDivs = chaptersContainer.querySelectorAll(".chapter-item");
        const chaptersArr = [];
        chapterDivs.forEach(chapterDiv => {
            const lessonsArr = [];
            const lessonDivs = chapterDiv.querySelectorAll(".lesson-item");
            lessonDivs.forEach(lessonDiv => {
                lessonsArr.push({
                    title: lessonDiv.querySelector(".lesson-title").value.trim(),
                    video: lessonDiv.querySelector(".lesson-video").value.trim(),
                    download: lessonDiv.querySelector(".lesson-download") ? lessonDiv.querySelector(".lesson-download").value.trim() : ""
                });
            });
            chaptersArr.push({
                title: chapterDiv.querySelector(".chapter-title").value.trim(),
                lessons: lessonsArr
            });
        });

        await db.collection("slides").doc(slideId).update({
            title: document.getElementById("slideTitle").value.trim(),
            // إذا كان لديك حقل محتوى الشريحة
            ...(document.getElementById("slideContent") && { content: document.getElementById("slideContent").value.trim() }),
            chapters: chaptersArr,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast("تم تحديث الشريحة بنجاح!", "success");
        document.getElementById("slideForm").reset();
        document.getElementById("chaptersContainer").innerHTML = "";
        document.getElementById("slideCreationSuccess").style.display = "flex";
        setTimeout(() => {
            document.getElementById("slideCreationSuccess").style.display = "none";
        }, 2000);
        // إعادة زر الحفظ للوضع الافتراضي (إضافة شريحة)
        slideForm.onsubmit = null;
    };
}
// ...existing code...
// ...existing code...

// زر حذف جميع الأسئلة التي ليس لها فئة
const deleteNoCategoryQuestionsBtn = document.createElement("button");
deleteNoCategoryQuestionsBtn.className = "btn btn-danger";
deleteNoCategoryQuestionsBtn.style.marginBottom = "15px";
deleteNoCategoryQuestionsBtn.innerHTML = `<i class="fas fa-trash"></i> حذف جميع الأسئلة بدون فئة`;
deleteNoCategoryQuestionsBtn.id = "deleteNoCategoryQuestionsBtn";

// أضف الزر تحت قائمة الفئات في بنك الأسئلة
var questionBankCategorySelect = document.getElementById("questionBankCategory");
if (questionBankCategorySelect) {
  questionBankCategorySelect.parentElement.appendChild(deleteNoCategoryQuestionsBtn);
}

// عند الضغط على زر حذف جميع الأسئلة بدون فئة
deleteNoCategoryQuestionsBtn.onclick = async function () {
  if (!confirm("هل أنت متأكد أنك تريد حذف جميع الأسئلة التي ليس لها فئة؟ لا يمكن التراجع عن هذا الإجراء!")) return;
  const snapshot = await db.collection("questionBank").where("categoryId", "==", null).get();
  if (snapshot.empty) {
    showToast("لا يوجد أسئلة بدون فئة.", "error");
    return;
  }
  const batch = db.batch();
  snapshot.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  showToast("تم حذف جميع الأسئلة بدون فئة بنجاح!", "success");
  loadQuestionBank();
};

// ...existing code...
// زر حذف جميع الأسئلة في جميع الفئات (بدون حذف الفئات نفسها)
const deleteAllQuestionsBtn = document.createElement("button");
deleteAllQuestionsBtn.className = "btn btn-danger";
deleteAllQuestionsBtn.style.marginBottom = "15px";
deleteAllQuestionsBtn.innerHTML = `<i class="fas fa-trash"></i> حذف جميع الأسئلة في كل الفئات`;
deleteAllQuestionsBtn.id = "deleteAllQuestionsBtn";

// أضف الزر تحت قائمة الفئات في بنك الأسئلة
questionBankCategorySelect = document.getElementById("questionBankCategory");
if (questionBankCategorySelect) {
  questionBankCategorySelect.parentElement.appendChild(deleteAllQuestionsBtn);
}

// عند الضغط على زر حذف جميع الأسئلة في كل الفئات
deleteAllQuestionsBtn.onclick = async function () {
  if (!confirm("هل أنت متأكد أنك تريد حذف جميع الأسئلة في كل الفئات؟ لا يمكن التراجع عن هذا الإجراء!")) return;
  const snapshot = await db.collection("questionBank").get();
  if (snapshot.empty) {
    showToast("لا يوجد أسئلة لحذفها.", "error");
    return;
  }
  const batch = db.batch();
  snapshot.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  showToast("تم حذف جميع الأسئلة بنجاح!", "success");
  loadQuestionBank();
};

// زر حذف فئة معيّنة
const deleteCategoryBtn = document.createElement("button");
deleteCategoryBtn.className = "btn btn-danger";
deleteCategoryBtn.style.marginRight = "10px";
deleteCategoryBtn.innerHTML = `<i class="fas fa-trash"></i> حذف الفئة المحددة`;
deleteCategoryBtn.id = "deleteCategoryBtn";

// أضف الزر بجوار زر إضافة فئة جديدة
const addCategoryBtn = document.getElementById("addCategoryBtn");
if (addCategoryBtn) {
  addCategoryBtn.parentElement.appendChild(deleteCategoryBtn);
}

// عند الضغط على زر حذف الفئة المحددة
deleteCategoryBtn.onclick = async function () {
  const categoryId = document.getElementById("questionBankCategory").value;
  if (!categoryId) {
    showToast("اختر فئة أولاً!", "error");
    return;
  }
  if (!confirm("هل أنت متأكد أنك تريد حذف هذه الفئة؟ لن يتم حذف الأسئلة المرتبطة بها.")) return;
 await db.collection("questionCategories").doc(categoryId).delete();
showToast("تم حذف الفئة بنجاح!", "success");
refreshAllCategoryLabels();
loadQuestionBank();
};

// ...existing code...
function loadStudents() {
  const _0x3824cc = document.getElementById("studentsTable");
  _0x3824cc.innerHTML = "<tr><td colspan=\"5\">جاري تحميل قائمة الطلاب...</td></tr>";
  db.collection("users").where("role", '==', 'student').get().then(_0x34630e => {
    if (_0x34630e.empty) {
      _0x3824cc.innerHTML = "<tr><td colspan=\"5\">لا يوجد طلاب مسجلين بعد</td></tr>";
      return;
    }
    _0x3824cc.innerHTML = '';
    const _0x4314a2 = [];
    _0x34630e.forEach(_0x186e8d => {
      const _0x3331c6 = _0x186e8d.data();
      _0x3331c6.id = _0x186e8d.id;
      _0x4314a2.push(_0x3331c6);
    });
    const _0x1c8a7f = _0x4314a2.map(_0x4c5124 => {
      return db.collection('results').where("userId", '==', _0x4c5124.id).get().then(_0x4331a6 => {
        let _0x49c29d = 0x0;
        let _0x5c0e46 = 0x0;
        _0x4331a6.forEach(_0x74cf4f => {
          const _0x5873bf = _0x74cf4f.data();
          _0x49c29d += _0x5873bf.scorePercentage;
          _0x5c0e46++;
        });
        _0x4c5124.averageGrade = _0x5c0e46 > 0x0 ? (_0x49c29d / _0x5c0e46).toFixed(2) : null;
        return _0x4c5124;
      });
    });
    Promise.all(_0x1c8a7f).then(_0x191d81 => {
      _0x191d81.forEach(_0x336aff => {
        _0x3824cc.innerHTML += `
          <tr>
            <td>${_0x336aff.name}</td>
            <td>${_0x336aff.email}</td>
            <td>${_0x336aff.examsTaken || 0}</td>
            <td>${_0x336aff.averageGrade ? _0x336aff.averageGrade + '%' : "لا يوجد بيانات"}</td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="viewStudentGrades('${_0x336aff.id}')">
                <i class="fas fa-eye"></i> عرض الدرجات
              </button>
              <button class="btn btn-danger btn-sm" onclick="toggleStudentStatus('${_0x336aff.id}', ${_0x336aff.disabled || false})">
                ${_0x336aff.disabled ? "تفعيل" : "تعطيل"}
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteStudentAccount('${_0x336aff.id}')">
                <i class="fas fa-trash"></i> حذف الحساب
              </button>
              <button class="btn btn-warning btn-sm" onclick="lockStudent('${_0x336aff.id}')">
                <i class="fas fa-lock"></i> قفل الطالب
              </button>
              <button class="btn btn-success btn-sm" onclick="unlockStudent('${_0x336aff.id}')">
                <i class="fas fa-unlock"></i> إزالة القفل
              </button>
            </td>
          </tr>
        `;
      });
    });
  })["catch"](_0x2a218d => {
    _0x3824cc.innerHTML = "<tr><td colspan=\"5\">حدث خطأ: " + _0x2a218d.message + "</td></tr>";
  });
}

// أضف الدوال التالية في ملفك (مرة واحدة فقط):

window.lockStudent = function(studentId) {
  db.collection("studentLocks").doc(studentId).set({
    locked: true,
    message: "يتم رفع امتحان انتظر قليلاً",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    showToast("تم قفل الطالب بنجاح!", "success");
  });
};

window.unlockStudent = function(studentId) {
  db.collection("studentLocks").doc(studentId).delete().then(() => {
    showToast("تم إزالة القفل عن الطالب!", "success");
  });
};

// عند الطالب: استمع للقفل وأظهر رسالة لا يمكن إغلاقها إلا من المعلم
function listenForStudentLock() {
  if (userRole === "student" && currentUser) {
    db.collection("studentLocks").doc(currentUser.uid)
      .onSnapshot(doc => {
        let modal = document.getElementById("studentLockModal");
        if (doc.exists && doc.data().locked) {
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "studentLockModal";
            modal.className = "modal";
            modal.innerHTML = `
              <div class="modal-content" style="max-width:420px;text-align:center;">
                <div style="margin-bottom:18px;">
                  <i class="fas fa-hourglass-half" style="font-size:3rem;color:#0a70ff;"></i>
                </div>
                <h2 class="modal-title" style="color:#0a70ff;">يرجى الانتظار</h2>
                <p class="modal-message" style="font-size:1.15rem;color:#333;margin-bottom:18px;">
                  ${doc.data().message || "يتم رفع امتحان انتظر قليلاً"}
                </p>
                <div style="color:#888;font-size:1rem;"></div>
              </div>
            `;
            document.body.appendChild(modal);
          }
          modal.style.display = "flex";
        } else if (modal) {
          modal.remove();
        }
      });
  }
}

// استدعِ الدالة بعد تسجيل دخول الطالب (مثلاً في setupAuthenticatedUI)
listenForStudentLock();
function deleteStudentAccount(studentId) {
  if (!confirm("هل أنت متأكد أنك تريد حذف حساب هذا الطالب؟ لا يمكن التراجع عن هذا الإجراء.")) {
    return;
  }
  // أضف إشعار حذف الحساب في مجموعة خاصة لكل طالب
  db.collection("accountNotifications").doc(studentId).set({
    type: "deleted",
    message: "تم حذف حسابك من قبل الإدارة. إذا كان لديك استفسار تواصل مع الإدارة.",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    // بعد إرسال الإشعار، احذف الحساب فعلياً
    db.collection('users').doc(studentId).delete().then(() => {
      alert("تم حذف حساب الطالب بنجاح!");
      loadStudents();
    }).catch(error => {
      alert("حدث خطأ أثناء حذف حساب الطالب: " + error.message);
    });
  });
}
function listenForAccountDelete() {
  if (currentUser) {
    db.collection("accountNotifications").doc(currentUser.uid)
      .onSnapshot(doc => {
        if (doc.exists && doc.data().type === "deleted") {
          showAccountDeletedModal(doc.data().message || "تم حذف حسابك نهائيًا. يرجى التواصل مع الإدارة.");
        }
      });
  }
}
function showAccountDeletedModal(message) {
  // إذا كانت النافذة موجودة مسبقاً، احذفها
  let modal = document.getElementById("accountDeletedModal");
  if (modal) modal.remove();

  modal = document.createElement("div");
  modal.id = "accountDeletedModal";
  modal.className = "modal";
  modal.style.display = "flex";
  modal.innerHTML = `
    <div class="modal-content" style="max-width:420px;text-align:center;">
      <div style="margin-bottom:18px;">
        <i class="fas fa-user-slash" style="font-size:3rem;color:#FC5C65;"></i>
      </div>
      <h2 class="modal-title" style="color:#FC5C65;">تم حذف الحساب نهائيًا</h2>
      <p class="modal-message" style="font-size:1.15rem;color:#333;margin-bottom:18px;">
        ${message}<br>
        إذا كان لديك أي استفسار أو ترغب في التواصل مع الإدارة، اضغط الزر بالأسفل.
      </p>
      <a href="https://wa.me/201060911093" target="_blank" id="whatsappContactBtn"
         style="display:inline-block;background:#25d366;color:#fff;font-size:1.2rem;padding:12px 32px;border-radius:8px;text-decoration:none;font-weight:bold;margin-bottom:10px;">
        <i class="fab fa-whatsapp" style="margin-left:8px;font-size:1.5rem;"></i> تواصل مع الإدارة عبر واتساب
      </a>
      <br>
      <button class="btn btn-danger" style="margin-top:10px;" onclick="closeAccountDeletedModal()">إغلاق</button>
    </div>
  `;
  document.body.appendChild(modal);

  // عند الإغلاق، سجل الخروج وأعد تحميل الصفحة
  window.closeAccountDeletedModal = function() {
    modal.remove();
    auth.signOut().then(() => {
      window.location.reload();
    });
  };
}
function toggleStudentStatus(_0x439b97, _0x29eff6) {
  const _0x3b1363 = _0x29eff6 ? "هل تريد تفعيل حساب هذا الطالب؟" : "هل تريد تعطيل حساب هذا الطالب؟";
  if (!confirm(_0x3b1363)) {
    return;
  }
  db.collection('users').doc(_0x439b97).update({
    'disabled': !_0x29eff6
  }).then(() => {
    alert(_0x29eff6 ? "تم تفعيل حساب الطالب بنجاح!" : "تم تعطيل حساب الطالب بنجاح!");
    loadStudents();
  })["catch"](_0x4f1658 => {
    alert("حدث خطأ أثناء تحديث حالة الطالب: " + _0x4f1658.message);
  });
}
window.viewStudentGrades = function (_0x2fb3e1) {
  const _0x30ad29 = document.getElementById("gradesModal");
  const _0x4ab3af = document.getElementById("gradesModalContent");
  _0x30ad29.style.display = "flex";
  _0x4ab3af.innerHTML = "<p>جاري تحميل الدرجات...</p>";
  db.collection("results").where("userId", '==', _0x2fb3e1).orderBy("submittedAt", 'desc').get().then(_0x5ee660 => {
    if (_0x5ee660.empty) {
      _0x4ab3af.innerHTML = "<p>لا توجد درجات مسجلة لهذا الطالب.</p>";
      return;
    }
    let _0x572499 = "<h3>درجات الطالب</h3><table class=\"grades-table\"><thead><tr><th>اسم الاختبار</th><th>التاريخ والوقت</th><th>الدرجة</th><th>النسبة المئوية</th><th>الحالة</th></tr></thead><tbody>";
    _0x5ee660.forEach(_0x62ace7 => {
      const _0xa4e4d6 = _0x62ace7.data();
      const _0x54ef54 = _0xa4e4d6.submittedAt?.["toDate"]() || new Date();
      const _0x5db96e = _0x54ef54.toLocaleDateString() + " " + _0x54ef54.toLocaleTimeString();
      _0x572499 += "\n                    <tr>\n                        <td>" + _0xa4e4d6.examTitle + "</td>\n                        <td>" + _0x5db96e + "</td>\n                        <td>" + _0xa4e4d6.obtainedMarks + " / " + _0xa4e4d6.totalMarks + "</td>\n                        <td>" + _0xa4e4d6.scorePercentage + "%</td>\n                        <td>" + _0xa4e4d6.gradeStatus + "</td>\n                    </tr>\n                ";
    });
    _0x572499 += '</tbody></table>';
    _0x4ab3af.innerHTML = _0x572499;
  })['catch'](_0x1aae95 => {
    _0x4ab3af.innerHTML = "<p>حدث خطأ أثناء تحميل الدرجات: " + _0x1aae95.message + "</p>";
  });
};
document.getElementById("disableAllStudentsBtn").addEventListener("click", () => {
    if (!confirm("هل أنت متأكد أنك تريد تعطيل جميع الطلاب؟")) {
        return;
    }

    db.collection("users")
        .where("role", "==", "student")
        .get()
        .then((querySnapshot) => {
            const batch = db.batch(); // استخدام batch لتحديث جميع الطلاب دفعة واحدة
            querySnapshot.forEach((doc) => {
                batch.update(doc.ref, { disabled: true });
            });

            return batch.commit(); // تنفيذ التحديثات
        })
        .then(() => {
            alert("تم تعطيل جميع الطلاب بنجاح!");
            loadStudents(); // إعادة تحميل قائمة الطلاب
        })
        .catch((error) => {
            alert("حدث خطأ أثناء تعطيل الطلاب: " + error.message);
        });
});
// ...existing code...

// تحميل الفئات وعرضها بشكل شجري في جدول أو قائمة
function renderCategoriesTree() {
  const container = document.getElementById("categoriesTreeContainer");
  container.innerHTML = "جاري تحميل الفئات...";
  db.collection("questionCategories").orderBy("name").get().then(snapshot => {
    const categories = {};
    snapshot.forEach(doc => {
      categories[doc.id] = { ...doc.data(), id: doc.id, children: [] };
    });
    Object.values(categories).forEach(cat => {
      if (cat.parentId && categories[cat.parentId]) {
        categories[cat.parentId].children.push(cat);
      }
    });
    const roots = Object.values(categories).filter(cat => !cat.parentId);

    function renderTree(cats, prefix = "") {
      let html = "<ul style='list-style:none;padding-right:0'>";
      cats.forEach(cat => {
        html += `<li style="margin-bottom:7px;">
          <span style="font-weight:bold;color:#0a70ff;">${prefix}${cat.name}</span>
          ${cat.children.length ? renderTree(cat.children, prefix + "&nbsp;&nbsp;&nbsp;&nbsp;— ") : ""}
        </li>`;
      });
      html += "</ul>";
      return html;
    }

    container.innerHTML = renderTree(roots);
  });
}

// استدعِ الدالة عند فتح بنك الأسئلة أو بعد إضافة/تعديل/حذف فئة
document.getElementById("menuQuestionBank").addEventListener("click", function() {
  renderCategoriesTree();
  // ...باقي الكود...
});
function loadStudentProgress() {
  const _0x425f9d = document.getElementById("studentProgressChart");
  _0x425f9d.innerHTML = "<p>جاري تحميل بيانات التقدم...</p>";
  // الحل: استخدم orderBy('userId').where('userId', '==', ...) ثم orderBy('submittedAt', 'asc')
  db.collection("results")
    .where('userId', '==', currentUser.uid)
    .orderBy('userId')
    .orderBy('submittedAt', "asc")
    .get()
    .then(_0x59ce1f => {
      if (_0x59ce1f.empty) {
        _0x425f9d.innerHTML = "<p>لا توجد بيانات تقدم متاحة</p>";
        return;
      }
      const _0x5f3a07 = [];
      _0x59ce1f.forEach(_0xd02fb6 => {
        _0x5f3a07.push(_0xd02fb6.data());
      });
      renderStudentProgressChart(_0x5f3a07);
    })["catch"](_0x2a9474 => {
      _0x425f9d.innerHTML = "<p>حدث خطأ: " + _0x2a9474.message + "</p>";
    });
}
function renderStudentProgressChart(_0x1177b7) {
  const _0xe65680 = document.getElementById("studentProgressChart");
  if (_0x1177b7.length === 0x0) {
    _0xe65680.innerHTML = "<p>لا توجد بيانات تقدم متاحة</p>";
    return;
  }
  let _0x1139b3 = "<h3>تقدمي في الاختبارات</h3>";
  _0x1177b7.forEach((_0x9e058e, _0x2bebfa) => {
    _0x1139b3 += "\n                    <div class=\"progress-label\">\n                        <span>" + _0x9e058e.examTitle + "</span>\n                        <span>" + _0x9e058e.scorePercentage + "%</span>\n                    </div>\n                    <div class=\"progress-bar\">\n                        <div class=\"progress-fill\" style=\"width: " + _0x9e058e.scorePercentage + "%\"></div>\n                    </div>\n                ";
  });
  _0xe65680.innerHTML = _0x1139b3;
}
function loadStudentsProgress() {
  const _0x5ec744 = document.getElementById("studentsProgressChart");
  _0x5ec744.innerHTML = "<p>جاري تحميل بيانات تقدم الطلاب...</p>";
  db.collection('results').get().then(_0x2a671d => {
    if (_0x2a671d.empty) {
      _0x5ec744.innerHTML = "<p>لا توجد بيانات تقدم متاحة</p>";
      return;
    }
    let _0x3c5c63 = 0x0;
    let _0x5198d9 = 0x0;
    let _0x3fec20 = 0x0;
    let _0x2be0c8 = 0x0;
    const _0x35c66d = _0x2a671d.size;
    _0x2a671d.forEach(_0x41adbb => {
      const _0x39a571 = _0x41adbb.data();
      const _0x54afb5 = _0x39a571.scorePercentage;
      if (_0x54afb5 >= 0x5a) {
        _0x3c5c63++;
      } else {
        if (_0x54afb5 >= 0x4b) {
          _0x5198d9++;
        } else if (_0x54afb5 >= 0x3c) {
          _0x3fec20++;
        } else {
          _0x2be0c8++;
        }
      }
    });
    const _0x4b9b62 = Math.round(_0x3c5c63 / _0x35c66d * 0x64);
    const _0x162ef7 = Math.round(_0x5198d9 / _0x35c66d * 0x64);
    const _0x4eff46 = Math.round(_0x3fec20 / _0x35c66d * 0x64);
    const _0x106d2a = Math.round(_0x2be0c8 / _0x35c66d * 0x64);
    _0x5ec744.innerHTML = "\n                <h3>متوسط درجات الطلاب</h3>\n                <div class=\"progress-label\">\n                    <span>الطلاب الممتازون (90%+)</span>\n                    <span>" + _0x4b9b62 + "%</span>\n                </div>\n                <div class=\"progress-bar\">\n                    <div class=\"progress-fill\" style=\"width: " + _0x4b9b62 + "%\"></div>\n                </div>\n\n                <div class=\"progress-label\">\n                    <span>الطلاب الجيدون (75-89%)</span>\n                    <span>" + _0x162ef7 + "%</span>\n                </div>\n                <div class=\"progress-bar\">\n                    <div class=\"progress-fill\" style=\"width: " + _0x162ef7 + "%\"></div>\n                </div>\n\n                <div class=\"progress-label\">\n                    <span>الطلاب المتوسطون (60-74%)</span>\n                    <span>" + _0x4eff46 + "%</span>\n                </div>\n                <div class=\"progress-bar\">\n                    <div class=\"progress-fill\" style=\"width: " + _0x4eff46 + "%\"></div>\n                </div>\n\n                <div class=\"progress-label\">\n                    <span>الطلاب الضعاف (أقل من 60%)</span>\n                    <span>" + _0x106d2a + "%</span>\n                </div>\n                <div class=\"progress-bar\">\n                    <div class=\"progress-fill\" style=\"width: " + _0x106d2a + "%\"></div>\n                </div>\n            ";
  })["catch"](_0x4e51b9 => {
    _0x5ec744.innerHTML = "<p>حدث خطأ أثناء تحميل البيانات: " + _0x4e51b9.message + "</p>";
  });
}

function addQuestion() {
  const questionsContainer = document.getElementById("questionsContainer");
  const questionId = Date.now();
  const questionElement = document.createElement("div");
  questionElement.className = "question-container";
  questionElement.id = "question-" + questionId;

  questionElement.innerHTML = `
    <div class="form-group">
      <label class="form-label">نص السؤال</label>
      <input type="text" class="form-control question-text" required>
    </div>
    <div class="form-group">
      <label class="form-label">رابط الصورة (اختياري)</label>
      <input type="text" class="form-control question-image-url" placeholder="أدخل رابط الصورة">
    </div>
    <div class="form-group">
      <label class="form-label">خيارات الإجابة</label>
      <div id="options-${questionId}">
        <div class="option-item">
          <input type="radio" name="correct-${questionId}" value="0" required>
          <input type="text" class="form-control option-text" placeholder="الخيار الأول" required>
        </div>
        <div class="option-item">
          <input type="radio" name="correct-${questionId}" value="1" required>
          <input type="text" class="form-control option-text" placeholder="الخيار الثاني" required>
        </div>
      </div>
      <button type="button" class="add-btn" onclick="addOption('${questionId}')">
        <i class="fas fa-plus"></i> إضافة خيار
      </button>
      <button type="button" class="remove-btn" onclick="removeQuestion('${questionId}')">
        <i class="fas fa-trash"></i> حذف السؤال
      </button>
    </div>
  `;
  questionsContainer.appendChild(questionElement);
}
// أضف هذا الكود بعد دالة loadStudents أو في ملف الجافاسكريبت بعد تعريف جدول الطلاب

document.getElementById("searchStudentsInput").addEventListener("input", function () {
  const query = this.value.trim().toLowerCase();
  const studentsTable = document.getElementById("studentsTable");
  const rows = studentsTable.querySelectorAll("tr");
  let found = false;
  rows.forEach(row => {
    const nameCell = row.querySelector("td");
    if (!nameCell) return;
    const name = nameCell.textContent.trim().toLowerCase();
    if (name.includes(query)) {
      row.style.display = "";
      found = true;
    } else {
      row.style.display = "none";
    }
  });
  // إذا لم يوجد نتائج
  if (!found && query.length > 0) {
    studentsTable.innerHTML = `<tr><td colspan="5">لا يوجد طلاب مطابقين لبحثك.</td></tr>`;
  }
  // إذا تم مسح البحث أعد تحميل الطلاب
  if (query.length === 0) {
    loadStudents();
  }
});
window.removeQuestion = function (questionId) {
    // إذا كان المعرف يبدأ بـ "question-" استخدمه كما هو، وإلا أضف "question-"
    let elementId = questionId.startsWith("question-") ? questionId : "question-" + questionId;
    const questionElement = document.getElementById(elementId);
    if (questionElement && confirm("هل أنت متأكد من حذف هذا السؤال؟")) {
        questionElement.remove();
    }
};
function loadProfile() {
  document.getElementById("profileName").value = currentUserData?.["name"] || currentUser.email;
  document.getElementById("profileEmail").value = currentUser.email;
  document.getElementById("profileRole").value = userRole === "teacher" ? "معلم" : "طالب";
  db.collection('users').doc(currentUser.uid).get().then(_0xd46be0 => {
    const _0xfb6a91 = _0xd46be0.data();
    document.getElementById("profileExamsCreated").value = _0xfb6a91?.["examsCreated"] || 0x0;
    document.getElementById('profileExamsTaken').value = _0xfb6a91?.["examsTaken"] || 0x0;
  });
}
loginBtn.addEventListener('click', () => showAuthForm('login'));
registerBtn.addEventListener("click", () => showAuthForm("register"));
showLogin.addEventListener("click", _0x457301 => {
  _0x457301.preventDefault();
  showAuthForm('login');
});
showRegister.addEventListener('click', _0x4592a8 => {
  _0x4592a8.preventDefault();
  showAuthForm("register");
});
document.getElementById("loginFormFields").addEventListener("submit", _0x149741 => {
  _0x149741.preventDefault();
  const _0x4849f3 = document.getElementById("loginEmail").value;
  const _0x211319 = document.getElementById("loginPassword").value;
  auth.signInWithEmailAndPassword(_0x4849f3, _0x211319).then(_0x40e345 => {
    const _0x4f4f8f = _0x40e345.user.uid;
    return db.collection("users").doc(_0x4f4f8f).get();
  }).then(_0xeddd08 => {
    if (_0xeddd08.exists && _0xeddd08.data().disabled) {
      alert("تم تعطيل حسابك. يرجى التواصل مع الإدارة.");
      auth.signOut();
    } else {
      location.reload();
    }
  })['catch'](_0x525ed0 => {
    alert("حدث خطأ أثناء تسجيل الدخول: " + _0x525ed0.message);
  });
});
document.getElementById("registerFormFields").addEventListener("submit", _0x13f918 => {
  _0x13f918.preventDefault();
  const _0x3ddb10 = document.getElementById("registerName").value;
  const _0x348723 = document.getElementById('registerEmail').value;
  const _0x5c8104 = document.getElementById("registerPassword").value;
  const _0x3457e6 = document.getElementById("registerConfirmPassword").value;
  const _0x141b3a = document.getElementById("registerRole").value;
  const _0x148afc = document.getElementById("registerError");
  const _0x4e73bc = document.getElementById('registerErrorText');
  if (_0x5c8104 !== _0x3457e6) {
    _0x4e73bc.textContent = "كلمة المرور غير متطابقة";
    _0x148afc.style.display = "flex";
    return;
  }
  auth.createUserWithEmailAndPassword(_0x348723, _0x5c8104).then(_0x3bab03 => {
    return db.collection("users").doc(_0x3bab03.user.uid).set({
      'name': _0x3ddb10,
      'email': _0x348723,
      'role': _0x141b3a,
      'createdAt': firebase.firestore.FieldValue.serverTimestamp(),
      'examsCreated': 0x0,
      'examsTaken': 0x0
    });
  }).then(() => {
    return auth.currentUser.updateProfile({
      'displayName': _0x3ddb10
    });
  }).then(() => {})["catch"](_0x2dc4c4 => {
    _0x4e73bc.textContent = _0x2dc4c4.message;
    _0x148afc.style.display = "flex";
  });
});
logoutBtn.addEventListener('click', () => {
  auth.signOut();
});
// ...existing code...

// عدل كود زر الرئيسية ليحول فقط للرئيسية بدون reload
menuDashboard.addEventListener('click', _0x3db87b => {
  _0x3db87b.preventDefault();
  setActiveMenuItem(menuDashboard);
  showPage(dashboardPage); // فقط عرض صفحة الرئيسية
  // لا تستخدم location.reload();
  loadDashboard(); // إذا كنت تريد تحديث البيانات الرئيسية فقط
});

// ...existing code...
menuExams.addEventListener("click", _0x2734e6 => {
  _0x2734e6.preventDefault();
  setActiveMenuItem(menuExams);
  showPage(examsPage);
  loadAllExams();
});
menuCreateExam.addEventListener("click", _0x32bb70 => {
  _0x32bb70.preventDefault();
  if (userRole !== "teacher") {
    alert("عذرًا، فقط المعلم يمكنه إنشاء الاختبارات.");
    return;
  }
  setActiveMenuItem(menuCreateExam);
  showPage(createExamPage);
  loadStudentsForExam(); // تحميل الطلاب كل مرة تفتح فيها الصفحة
});

menuCreateSlide.addEventListener('click', _0x8960e1 => {
  _0x8960e1.preventDefault();
  setActiveMenuItem(menuCreateSlide);
  showPage(createSlidePage);
});
menuResults.addEventListener("click", _0xf21351 => {
  _0xf21351.preventDefault();
  setActiveMenuItem(menuResults);
  showPage(resultsPage);
});
function toggleGradesDeleteButtons() {
  const deleteExamGradesBtn = document.getElementById("deleteExamGradesBtn");
  const deleteAllStudentGradesBtn = document.getElementById("deleteAllStudentGradesBtn");
  if (userRole === "teacher") {
    if (deleteExamGradesBtn) deleteExamGradesBtn.style.display = "inline-block";
    if (deleteAllStudentGradesBtn) deleteAllStudentGradesBtn.style.display = "inline-block";
  } else {
    if (deleteExamGradesBtn) deleteExamGradesBtn.style.display = "none";
    if (deleteAllStudentGradesBtn) deleteAllStudentGradesBtn.style.display = "none";
  }
}
menuGrades.addEventListener('click', _0x94296d => {
  _0x94296d.preventDefault();
  setActiveMenuItem(menuGrades);
  showPage(gradesPage);
  toggleGradesDeleteButtons(); // أضف هذا السطر هنا أيضاً
  if (userRole === "teacher") {
    loadAllGrades();
  } else {
    loadStudentGrades();
    loadStudentProgress();
  }
});

menuStudents.addEventListener("click", _0x215ac3 => {
  _0x215ac3.preventDefault();
  setActiveMenuItem(menuStudents);
  showPage(studentsPage);
  loadStudents();
});
menuProfile.addEventListener("click", _0xed050f => {
  _0xed050f.preventDefault();
  setActiveMenuItem(menuProfile);
  showPage(profilePage);
  loadProfile();
});
document.getElementById("prevQuestionBtn").addEventListener("click", () => {
  if (currentQuestionIndex > 0x0) {
    currentQuestionIndex--;
    loadQuestion(currentQuestionIndex);
  }
});
document.getElementById("nextQuestionBtn").addEventListener("click", () => {
  if (currentQuestionIndex < currentExam.questions.length - 0x1) {
    currentQuestionIndex++;
    loadQuestion(currentQuestionIndex);
  }
});
// ...existing code...

// اجعل زر "العودة إلى الاختبارات" يذهب إلى الرئيسية (dashboard) بدلاً من صفحة الاختبارات فقط
document.getElementById("backToExamsBtn").addEventListener("click", () => {
  setActiveMenuItem(menuDashboard);
  showPage(dashboardPage);
  loadDashboard(); // إذا كنت تريد تحديث بيانات الرئيسية فقط
});

// ...existing code...
document.getElementById("gradeExamFilter").addEventListener("change", loadFilteredGrades);
document.getElementById('addQuestionBtn').addEventListener("click", addQuestion);
document.getElementById('examForm').addEventListener("submit", saveExam);
document.getElementById("slideForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const chaptersContainer = document.getElementById("chaptersContainer");
    const chapterDivs = chaptersContainer.querySelectorAll(".chapter-item");
    const chaptersArr = [];
    chapterDivs.forEach(chapterDiv => {
        const lessonsArr = [];
        const lessonDivs = chapterDiv.querySelectorAll(".lesson-item");
        lessonDivs.forEach(lessonDiv => {
            lessonsArr.push({
                title: lessonDiv.querySelector(".lesson-title").value.trim(),
                video: lessonDiv.querySelector(".lesson-video").value.trim(),
                download: lessonDiv.querySelector(".lesson-download") ? lessonDiv.querySelector(".lesson-download").value.trim() : ""
            });
        });
        chaptersArr.push({
            title: chapterDiv.querySelector(".chapter-title").value.trim(),
            lessons: lessonsArr
        });
    });

    await db.collection("slides").add({
        title: document.getElementById("slideTitle").value.trim(),
        chapters: chaptersArr,
        createdBy: currentUserData?.["name"] || currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        userId: currentUser.uid
    });
    document.getElementById("slideForm").reset();
    document.getElementById("chaptersContainer").innerHTML = "";
    document.getElementById("slideCreationSuccess").style.display = "flex";
    setTimeout(() => {
        document.getElementById("slideCreationSuccess").style.display = "none";
    }, 2000);
});
document.addEventListener("DOMContentLoaded", () => {
  const _0x1a989b = document.querySelector(".about-content");
  const _0x30f924 = new IntersectionObserver(_0x3c561b => {
    _0x3c561b.forEach(_0x23cad0 => {
      if (_0x23cad0.isIntersecting) {
        _0x1a989b.classList.add("visible");
      }
    });
  });
  _0x30f924.observe(_0x1a989b);
});
initApp();
(function () {
  let _0x3cbc16 = false;
  function _0x57e7d7() {
    const _0x27fa1f = document.createElement("style");
    _0x27fa1f.innerHTML = "\n      .devtools-warning {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100vh;\n        background: linear-gradient(to bottom right, #d10000, #3b0000);\n        color: white;\n        font-family: 'Segoe UI', sans-serif;\n        font-size: 2rem;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        text-align: center;\n        padding: 40px;\n        box-sizing: border-box;\n        z-index: 999999;\n        display: none; /* الرسالة مخفية بشكل افتراضي */\n      }\n      .devtools-warning.show {\n        display: flex; /* تظهر الرسالة عندما يتم اكتشاف أدوات المطور */\n      }\n    ";
    document.head.appendChild(_0x27fa1f);
  }
  function _0x3b51cf() {
    const _0x3715a7 = document.createElement("div");
    _0x3715a7.className = "devtools-warning";
    _0x3715a7.id = "devtools-warning";
    _0x3715a7.textContent = "🚨 تم كشف أدوات المطور! سيتم إغلاق الصفحة لحمايتك.";
    document.body.appendChild(_0x3715a7);
  }
  function _0x1e4658() {
    if (_0x3cbc16) {
      return;
    }
    _0x3cbc16 = true;
    const _0x587f8d = document.getElementById("devtools-warning");
    if (_0x587f8d) {
      _0x587f8d.classList.add('show');
      setTimeout(() => {
        window.location.href = "about:blank";
      }, 0x9c4);
    }
  }

// ...existing code...

// 3. إظهار زر الإحصائيات للمعلم فقط
function setupAuthenticatedUI() {
  // ...existing code...
  if (userRole === "teacher") {
    document.getElementById("menuStudentsStatisticsLi").style.display = "block";
  } else {
    document.getElementById("menuStudentsStatisticsLi").style.display = "none";
  }
  // ...existing code...
}

// 4. عند الضغط على زر الإحصائيات، افتح الصفحة وحمّل الرسومات
document.getElementById("menuStudentsStatistics").addEventListener("click", function(e) {
  e.preventDefault();
  setActiveMenuItem(document.getElementById("menuStudentsStatisticsLi"));
  showPage(document.getElementById("studentsStatisticsPage"));
  loadStudentsStatisticsCharts();
});

// 5. دالة تحميل البيانات ورسم الرسومات البيانية
function loadStudentsStatisticsCharts() {
  db.collection("results").get().then(snapshot => {
    const examStats = {};
    const studentStats = {};
    snapshot.forEach(doc => {
      const data = doc.data();
      // متوسط درجات كل امتحان
      if (!examStats[data.examTitle]) examStats[data.examTitle] = [];
      examStats[data.examTitle].push(data.scorePercentage);

      // المستوى العام لكل طالب
      if (!studentStats[data.userName]) studentStats[data.userName] = [];
      studentStats[data.userName].push(data.scorePercentage);
    });

    // رسم متوسط درجات كل امتحان
    const examLabels = Object.keys(examStats);
    const examAverages = examLabels.map(title => {
      const arr = examStats[title];
      return arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : 0;
    });
    drawBarChart("examAverageChart", examLabels, examAverages, "متوسط الدرجات (%)", "#0a70ff");

    // رسم المستوى العام لكل طالب
    const studentLabels = Object.keys(studentStats);
    const studentAverages = studentLabels.map(name => {
      const arr = studentStats[name];
      return arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : 0;
    });
    drawBarChart("studentGeneralChart", studentLabels, studentAverages, "المستوى العام (%)", "#14ee88");

    // رسم مقارنة الطلاب ببعضهم البعض
    drawRadarChart("studentsCompareChart", studentLabels, studentAverages, "مقارنة الطلاب");
  });
}

// رسم رسم بياني عمودي
function drawBarChart(canvasId, labels, data, label, color) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: label,
        data: data,
        backgroundColor: color,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: false }
      },
      scales: {
        y: { beginAtZero: true, max: 100 }
      }
    }
  });
}

// رسم رسم بياني راداري للمقارنة
function drawRadarChart(canvasId, labels, data, label) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  new Chart(ctx, {
    type: "radar",
    data: {
      labels: labels,
      datasets: [{
        label: label,
        data: data,
        backgroundColor: "rgba(10,112,255,0.2)",
        borderColor: "#0a70ff",
        borderWidth: 2,
        pointBackgroundColor: "#14ee88"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: false }
      },
      scales: {
        r: { beginAtZero: true, max: 100 }
      }
    }
  });
}
// ...existing code...
  function _0x217215() {
    document.addEventListener("keydown", function (_0x1fa319) {
      if (_0x1fa319.key === "F12" || _0x1fa319.ctrlKey && _0x1fa319.shiftKey && ['I', 'J', 'C'].includes(_0x1fa319.key) || _0x1fa319.ctrlKey && _0x1fa319.key === 'U') {
        _0x1fa319.preventDefault();
        _0x1e4658();
      }
    });
    document.addEventListener("contextmenu", function (_0x5562cc) {
      _0x5562cc.preventDefault();
    });
  }
  function _0x4619bc() {
  _0x57e7d7();
  _0x3b51cf();
  _0x217215();

}
  window.addEventListener("DOMContentLoaded", _0x4619bc);
})();

function showNotificationMenuForTeacher() {
  const liSendNotification = document.getElementById("liSendNotification");
  if (!liSendNotification) return;
  if (userRole === "teacher") {
    liSendNotification.style.display = "block";
  } else {
    liSendNotification.style.display = "none";
  }
}

// دالة إظهار نافذة الإشعار
function showNotificationModal() {
  document.getElementById("notificationModal").style.display = "flex";

  // إعادة ربط أزرار التسجيل كل مرة تفتح فيها النافذة
  const startRecordingBtn = document.getElementById("startRecordingBtn");
  const stopRecordingBtn = document.getElementById("stopRecordingBtn");
  const recordedAudio = document.getElementById("recordedAudio");
  const notificationAudioUrl = document.getElementById("notificationAudioUrl");

  let mediaRecorder;
  let audioChunks = [];
  let recordedAudioBlob = null;

  if (startRecordingBtn && stopRecordingBtn && recordedAudio) {
    startRecordingBtn.onclick = async function () {
      audioChunks = [];
      recordedAudioBlob = null;
      recordedAudio.style.display = "none";
      notificationAudioUrl.value = "";
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        startRecordingBtn.style.display = "none";
        stopRecordingBtn.style.display = "inline-block";
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          recordedAudioBlob = new Blob(audioChunks, { type: "audio/webm" });
          recordedAudio.src = URL.createObjectURL(recordedAudioBlob);
          recordedAudio.style.display = "block";
          stopRecordingBtn.style.display = "none";
          startRecordingBtn.style.display = "inline-block";
          // رفع الملف إلى Firebase Storage
          const fileName = "notifications/" + Date.now() + ".webm";
          const storageRef = firebase.storage().ref().child(fileName);
          await storageRef.put(recordedAudioBlob);
          const url = await storageRef.getDownloadURL();
          notificationAudioUrl.value = url;
        };
      } catch (err) {
        alert("تعذر الوصول للميكروفون: " + err.message);
        startRecordingBtn.style.display = "inline-block";
        stopRecordingBtn.style.display = "none";
      }
    };

    stopRecordingBtn.onclick = function () {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    };
  }
}


// دالة إخفاء نافذة الإشعار
function hideNotificationModal() {
  document.getElementById("notificationModal").style.display = "none";
  document.getElementById("notificationMessage").value = "";
}

// دالة إرسال الإشعار إلى قاعدة البيانات
async function sendTeacherNotification() {
  const msg = document.getElementById("notificationMessage").value.trim();
  const audioUrl = document.getElementById("notificationAudioUrl").value.trim();
  if (!msg) {
    showToast("يرجى كتابة الرسالة.", "error");
    return;
  }
  await db.collection("notifications").add({
    message: msg,
    audioUrl: audioUrl || null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  hideNotificationModal();
  showToast("تم إرسال الإشعار بنجاح!", "success");
}
// ربط الأحداث بالأزرار (مرة واحدة بعد التأكد من وجود العناصر)
document.getElementById("menuSendNotification").onclick = function(e) {
  e.preventDefault();
  showNotificationModal();
};
// ...existing code...

// زر حذف جميع الأسئلة ذات "فئة غير معروفة"
const deleteUnknownCategoryQuestionsBtn = document.createElement("button");
deleteUnknownCategoryQuestionsBtn.className = "btn btn-danger";
deleteUnknownCategoryQuestionsBtn.style.marginBottom = "15px";
deleteUnknownCategoryQuestionsBtn.innerHTML = `<i class="fas fa-trash"></i> حذف جميع الأسئلة ذات فئة غير معروفة`;
deleteUnknownCategoryQuestionsBtn.id = "deleteUnknownCategoryQuestionsBtn";

// أضف الزر تحت قائمة الفئات في بنك الأسئلة
questionBankCategorySelect = document.getElementById("questionBankCategory");
if (questionBankCategorySelect) {
  questionBankCategorySelect.parentElement.appendChild(deleteUnknownCategoryQuestionsBtn);
}

// عند الضغط على زر حذف جميع الأسئلة ذات فئة غير معروفة
deleteUnknownCategoryQuestionsBtn.onclick = async function () {
  if (!confirm("هل أنت متأكد أنك تريد حذف جميع الأسئلة ذات فئة غير معروفة؟ لا يمكن التراجع عن هذا الإجراء!")) return;

  // جلب جميع الأسئلة التي لها categoryId غير موجود في الكاش
  const snapshot = await db.collection("questionBank").get();
  if (snapshot.empty) {
    showToast("لا يوجد أسئلة في بنك الأسئلة.", "error");
    return;
  }
  // تأكد من تحميل الكاش أولاً
  if (!window.questionCategoriesCache || Object.keys(window.questionCategoriesCache).length === 0) {
    await loadQuestionBankCategoriesTree();
  }
  const batch = db.batch();
  let found = 0;
  snapshot.forEach(doc => {
    const q = doc.data();
    if (q.categoryId && !questionCategoriesCache[q.categoryId]) {
      batch.delete(doc.ref);
      found++;
    }
  });
  if (found === 0) {
    showToast("لا يوجد أسئلة بفئة غير معروفة.", "error");
    return;
  }
  await batch.commit();
  showToast("تم حذف جميع الأسئلة ذات فئة غير معروفة بنجاح!", "success");
  loadQuestionBank();
};

// ...existing code...
// دالة عرض الإشعار للطالب عند تسجيل الدخول
// ...existing code...

// دالة عرض الإشعار للطالب عند تسجيل الدخول أو عند وصول إشعار جديد
function listenForStudentNotifications() {
  if (userRole === "student") {
    db.collection("notifications")
      .orderBy("createdAt", "desc")
      .limit(1)
      .onSnapshot(snapshot => {
        if (!snapshot.empty) {
          const notif = snapshot.docs[0].data();
          const lastNotif = localStorage.getItem("lastTeacherNotification");
          if (lastNotif !== notif.message) {
            showPopupNotification(notif.message, notif.audioUrl);
            localStorage.setItem("lastTeacherNotification", notif.message);
          }
        }
      });
  }
}
// استدعِ هذه الدالة في نهاية setupAuthenticatedUI بدلاً من showStudentNotification
// setupAuthenticatedUI() {
//   ...
//   showNotificationMenuForTeacher();
//   listenForStudentNotifications();
// }
function showPopupNotification(message, audioUrl) {
  // إذا كانت النافذة موجودة مسبقاً، احذفها
  let modal = document.getElementById("studentNotificationModal");
  if (modal) modal.remove();

  // دعم تنسيقات خاصة: **غامق** __تضخيم__ ==تظليل== (highlight)
  let formattedMessage = message
    // أسطر جديدة
    .replace(/(?:\r\n|\r|\n)/g, "<br>")
    // روابط
    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#0a70ff;text-decoration:underline;">$1</a>')
    // **غامق**
    .replace(/\*\*(.*?)\*\*/g, '<b style="color:#0a70ff;">$1</b>')
    // __تضخيم__
    .replace(/__(.*?)__/g, '<span style="font-size:1.3em;font-weight:bold;">$1</span>')
    // ==تظليل==
    .replace(/==(.+?)==/g, '<mark style="background:#ffe066;color:#222;padding:2px 6px;border-radius:5px;">$1</mark>');

  modal = document.createElement("div");
  modal.id = "studentNotificationModal";
  modal.style.position = "fixed";
  modal.style.top = "0";
  modal.style.left = "0";
  modal.style.width = "100vw";
  modal.style.height = "100vh";
  modal.style.background = "rgba(0,0,0,0.45)";
  modal.style.display = "flex";
  modal.style.justifyContent = "center";
  modal.style.alignItems = "center";
  modal.style.zIndex = "9999";

  modal.innerHTML = `
  <div style="
    background: linear-gradient(135deg, #f8fafc 70%, #e3f0ff 100%);
    border-radius: 22px;
    padding: 38px 32px 28px 32px;
    box-shadow: 0 8px 32px rgba(10,112,255,0.15);
    max-width: 440px;
    width: 95%;
    text-align: center;
    animation: fadeIn 0.5s;
    position: relative;
    direction: rtl;
    border: 2px solid #0a70ff1a;
  ">
    <div style="display:flex;justify-content:center;align-items:center;margin-bottom:10px;">
      <span style="background:#0a70ff1a;border-radius:50%;padding:18px;">
        <i class="fas fa-bell bell-animate" style="font-size:2.7rem;color:#0a70ff;"></i>
      </span>
    </div>
    <h2 style="font-size:1.5rem;color:#0a70ff;margin-bottom:14px;font-weight:bold;letter-spacing:1px;">إشعار من المعلم</h2>
    <div style="font-size:1.25rem;color:#222;margin-bottom:22px;line-height:2;word-break:break-word;text-align:center;">
      ${formattedMessage}
    </div>
    ${audioUrl ? `<audio id="notifAudio" src="${audioUrl}" autoplay style="display:none;"></audio>` : ""}
    <button id="closeStudentNotificationBtn" class="btn btn-success" style="padding:12px 38px;font-size:1.15rem;border-radius:8px;margin-top:10px;background:linear-gradient(90deg,#0a70ff,#14ee88);border:none;">
      <i class="fas fa-check-circle" style="margin-left:8px;"></i>حسناً
    </button>
  </div>
`;
// ...existing code...

// أضف هذا الكود مرة واحدة فقط في <style> أو عبر JavaScript إذا لم يكن موجوداً
if (!document.getElementById('bell-animate-style')) {
  const style = document.createElement('style');
  style.id = 'bell-animate-style';
  style.innerHTML = `
    @keyframes bellRing {
      0% { transform: rotate(0); }
      10% { transform: rotate(-20deg); }
      20% { transform: rotate(18deg); }
      30% { transform: rotate(-16deg); }
      40% { transform: rotate(14deg); }
      50% { transform: rotate(-12deg); }
      60% { transform: rotate(10deg); }
      70% { transform: rotate(-8deg); }
      80% { transform: rotate(6deg); }
      90% { transform: rotate(-4deg); }
      100% { transform: rotate(0); }
    }
    .bell-animate {
      animation: bellRing 1.2s cubic-bezier(.36,.07,.19,.97) both 9;
      transform-origin: top center;
      display: inline-block;
    }
  `;
  document.head.appendChild(style);
}
  document.body.appendChild(modal);

  // تشغيل الصوت إذا كان موجوداً
  if (audioUrl) {
    const audio = document.getElementById("notifAudio");
    if (audio) {
      audio.play().catch(()=>{});
    }
  }

  document.getElementById("closeStudentNotificationBtn").onclick = function() {
    modal.remove();
  };
}

// 🔍 كشف فتح أدوات المطور باستخدام الفرق الزمني في debugger

// تأكد من ربط الأحداث بعد تحميل الصفحة وكل العناصر
document.addEventListener("DOMContentLoaded", function () {
  // زر فتح نافذة الإشعار
  const menuSendNotification = document.getElementById("menuSendNotification");
  if (menuSendNotification) {
    menuSendNotification.onclick = function(e) {
      e.preventDefault();
      showNotificationModal();
    };
  }

  // زر إرسال الإشعار
  const sendNotificationBtn = document.getElementById("sendNotificationBtn");
  if (sendNotificationBtn) {
    sendNotificationBtn.onclick = sendTeacherNotification;
  }

  // زر إلغاء الإشعار
  const cancelNotificationBtn = document.getElementById("cancelNotificationBtn");
  if (cancelNotificationBtn) {
    cancelNotificationBtn.onclick = hideNotificationModal;
  }
});

// --- كاش الفئات ---
let questionCategoriesCache = {};

// تحميل الفئات في بنك الأسئلة ونافذة الإضافة ونافذة الاستيراد
function loadQuestionBankCategories(selected = "", selectId = "questionBankCategory") {
  const select = document.getElementById(selectId);
  select.innerHTML = "";
  db.collection("questionCategories").orderBy("name").get().then(snapshot => {
    questionCategoriesCache = {};
    if (snapshot.empty) {
      select.innerHTML = "<option value=''>بدون فئة</option>";
      return;
    }
    select.innerHTML = "<option value=''>كل الفئات</option>";
    snapshot.forEach(doc => {
      const cat = doc.data();
      questionCategoriesCache[doc.id] = cat.name;
      select.innerHTML += `<option value="${doc.id}" ${selected === doc.id ? "selected" : ""}>${cat.name}</option>`;
    });
  });
}

// زر إضافة فئة جديدة
// عند الضغط على زر إضافة فئة جديدة
document.getElementById("addCategoryBtn").onclick = function() {
  document.getElementById("addCategoryModal").style.display = "flex";
  // تحميل الفئات الرئيسية في القائمة المنسدلة
  const select = document.getElementById("parentCategorySelect");
  select.innerHTML = `<option value="">بدون فئة رئيسية</option>`;
 db.collection("questionCategories")
  .where("parentId", "==", null)
  .orderBy("name")
  .get()
  .then(snapshot => {
    snapshot.forEach(doc => {
      const cat = doc.data();
      select.innerHTML += `<option value="${doc.id}">${cat.name}</option>`;
    });
  });
};

// زر إلغاء
document.getElementById("cancelAddCategoryBtn").onclick = function() {
  document.getElementById("addCategoryModal").style.display = "none";
  document.getElementById("addCategoryForm").reset();
};

// عند حفظ الفئة الجديدة
document.getElementById("addCategoryForm").onsubmit = function(e) {
  e.preventDefault();
  const name = document.getElementById("categoryNameInput").value.trim();
  const parentId = document.getElementById("parentCategorySelect").value || null;
  if (!name) return;
db.collection("questionCategories").add({ name, parentId }).then(() => {
  document.getElementById("addCategoryModal").style.display = "none";
  document.getElementById("addCategoryForm").reset();
  refreshAllCategoryLabels();
  showToast("تمت إضافة الفئة!", "success");
});
};

// عند فتح بنك الأسئلة
document.getElementById("menuQuestionBank").addEventListener("click", function(e) {
  e.preventDefault();
  setActiveMenuItem(this);
  showPage(document.getElementById("questionBankPage"));
  loadQuestionBankCategoriesTree(); // شجري
  loadQuestionBank();
});

// عند تغيير الفئة في بنك الأسئلة
document.getElementById("questionBankCategory").addEventListener("change", function() {
  loadQuestionBank();
});

// تحميل الفئات في نافذة إضافة سؤال جديد
document.getElementById("addQuestionBankBtn").onclick = function() {
  document.getElementById("addQuestionBankModal").style.display = "flex";
  loadQuestionBankCategories("", "questionBankCategoryAdd");
};

// زر إلغاء إضافة سؤال
document.getElementById("cancelAddQuestionBankBtn").onclick = function() {
  document.getElementById("addQuestionBankModal").style.display = "none";
  document.getElementById("addQuestionBankForm").reset();
};

// حفظ السؤال الجديد مع الفئة
document.getElementById("addQuestionBankForm").onsubmit = function(e) {
  e.preventDefault();
  const text = document.getElementById("questionBankText").value.trim();
  const options = [
    { text: document.getElementById("option1").value.trim() },
    { text: document.getElementById("option2").value.trim() }
  ];
  if (document.getElementById("option3").value.trim()) options.push({ text: document.getElementById("option3").value.trim() });
  if (document.getElementById("option4").value.trim()) options.push({ text: document.getElementById("option4").value.trim() });
  const correctAnswer = parseInt(document.getElementById("correctOption").value) - 1;
  const imageUrl = document.getElementById("questionBankImageUrl").value.trim();
  const categoryId = document.getElementById("questionBankCategoryAdd").value || null;

  db.collection("questionBank").add({
    text,
    options,
    correctAnswer,
    imageUrl,
    categoryId,
    createdBy: currentUserData?.name || currentUser.email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    document.getElementById("addQuestionBankModal").style.display = "none";
    document.getElementById("addQuestionBankForm").reset();
    loadQuestionBank();
    showToast("تم إضافة السؤال!", "success");
  });
};

// تحميل وعرض الأسئلة حسب الفئة المختارة مع إمكانية التعديل والحذف
function loadQuestionBank() {
  const container = document.getElementById("questionBankContainer");
  container.innerHTML = "جاري التحميل...";
  const categoryId = document.getElementById("questionBankCategory").value;
  let query = db.collection("questionBank").orderBy("createdAt", "desc");
  if (categoryId && categoryId !== "") query = query.where("categoryId", "==", categoryId);
  query.get().then(snapshot => {
    if (snapshot.empty) {
      container.innerHTML = "<p>لا يوجد أسئلة في هذه الفئة.</p>";
      return;
    }
    let html = "<table class='grades-table'><thead><tr><th>السؤال</th><th>الفئة</th><th>الخيارات</th><th>الصحيح</th><th>صورة</th><th>إجراءات</th></tr></thead><tbody>";
    snapshot.forEach(doc => {
      const q = doc.data();
      let categoryName = "بدون فئة";
      if (q.categoryId && questionCategoriesCache[q.categoryId]) {
        categoryName = questionCategoriesCache[q.categoryId];
      } else if (q.categoryId) {
        categoryName = "فئة غير معروفة";
      }
      html += `<tr>
        <td>${q.text}</td>
        <td>${categoryName}</td>
        <td>${q.options.map((o,i)=>`${i+1}- ${o.text}`).join("<br>")}</td>
        <td>${q.options[q.correctAnswer]?.text || ""}</td>
        <td>${q.imageUrl ? `<img src="${q.imageUrl}" style="max-width:60px;max-height:40px;">` : ""}</td>
        <td>
          <button class="btn btn-outline" onclick="editBankQuestion('${doc.id}')"><i class="fas fa-edit"></i></button>
          <button class="btn btn-danger" onclick="deleteBankQuestion('${doc.id}')"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`;
    });
    html += "</tbody></table>";
    container.innerHTML = html;
  });
}

// حذف سؤال من بنك الأسئلة
window.deleteBankQuestion = function(id) {
  if (confirm("هل تريد حذف هذا السؤال؟")) {
    db.collection("questionBank").doc(id).delete().then(loadQuestionBank);
  }
};
document.getElementById("addQuestionBankBtn").onclick = function() {
  document.getElementById("addQuestionBankModal").style.display = "flex";
  // حل مشكلة تكرار الفئات: تفريغ القائمة قبل تعبئتها
  loadQuestionBankCategoriesTree("", "questionBankCategoryAdd"); // شجري
};
// تعديل سؤال (نافذة مبسطة)
window.editBankQuestion = function(id) {
  db.collection("questionBank").doc(id).get().then(doc => {
    if (!doc.exists) return;
    const q = doc.data();
    document.getElementById("addQuestionBankModal").style.display = "flex";
    document.getElementById("questionBankText").value = q.text;
    document.getElementById("option1").value = q.options[0]?.text || "";
    document.getElementById("option2").value = q.options[1]?.text || "";
    document.getElementById("option3").value = q.options[2]?.text || "";
    document.getElementById("option4").value = q.options[3]?.text || "";
    document.getElementById("correctOption").value = (q.correctAnswer || 0) + 1;
    document.getElementById("questionBankImageUrl").value = q.imageUrl || "";
    // حل مشكلة تكرار الفئات: تفريغ القائمة قبل تعبئتها
    loadQuestionBankCategoriesTree(q.categoryId, "questionBankCategoryAdd");
    // عند الحفظ، حدث بدلاً من إضافة جديد
    document.getElementById("addQuestionBankForm").onsubmit = function(e) {
      e.preventDefault();
      const text = document.getElementById("questionBankText").value.trim();
      const options = [
        { text: document.getElementById("option1").value.trim() },
        { text: document.getElementById("option2").value.trim() }
      ];
      if (document.getElementById("option3").value.trim()) options.push({ text: document.getElementById("option3").value.trim() });
      if (document.getElementById("option4").value.trim()) options.push({ text: document.getElementById("option4").value.trim() });
      const correctAnswer = parseInt(document.getElementById("correctOption").value) - 1;
      const imageUrl = document.getElementById("questionBankImageUrl").value.trim();
      const categoryId = document.getElementById("questionBankCategoryAdd").value || null;
      db.collection("questionBank").doc(id).update({
        text, options, correctAnswer, imageUrl, categoryId
      }).then(() => {
        document.getElementById("addQuestionBankModal").style.display = "none";
        document.getElementById("addQuestionBankForm").reset();
        loadQuestionBank();
        showToast("تم تحديث السؤال!", "success");
        // أعد ربط onsubmit للإضافة العادية
        document.getElementById("addQuestionBankForm").onsubmit = defaultAddQuestionBankFormHandler;
      });
    };
  });
};
// إعادة onsubmit الافتراضي بعد التعديل
const defaultAddQuestionBankFormHandler = document.getElementById("addQuestionBankForm").onsubmit;

// --- استيراد أسئلة من بنك الأسئلة في صفحة إنشاء اختبار ---
document.getElementById("importFromQuestionBankBtn").onclick = function() {
  loadQuestionBankCategoriesTree("", "importBankCategory"); // شجري
  document.getElementById("importQuestionsModal").style.display = "flex";
  loadImportQuestionsList();
};
// عند تغيير الفئة في نافذة الاستيراد
document.getElementById("importBankCategory").addEventListener("change", function() {
  loadImportQuestionsList(1);
});
// ...existing code...

let importQuestionsPage = 1;
const QUESTIONS_PER_PAGE = 10;
let importQuestionsAllDocs = []; // لتخزين كل الأسئلة

function loadImportQuestionsList(page = 1) {
  importQuestionsPage = page;
  const categoryId = document.getElementById("importBankCategory").value;
  let query = db.collection("questionBank").orderBy("createdAt", "desc");
  if (categoryId && categoryId !== "") query = query.where("categoryId", "==", categoryId);
  const list = document.getElementById("importQuestionsList");
  list.innerHTML = `<div style="margin-bottom:10px;">
      <label>
        <input type="checkbox" id="selectAllImportQuestions">
        تحديد الكل
      </label>
    </div>
    جاري التحميل...`;

  query.get().then(snapshot => {
    if (snapshot.empty) {
      list.innerHTML = "<p>لا يوجد أسئلة في هذه الفئة.</p>";
      return;
    }
    importQuestionsAllDocs = [];
    snapshot.forEach(doc => {
      importQuestionsAllDocs.push({ id: doc.id, ...doc.data() });
    });

    // حساب الصفحات
    const totalPages = Math.ceil(importQuestionsAllDocs.length / QUESTIONS_PER_PAGE);
    const startIdx = (importQuestionsPage - 1) * QUESTIONS_PER_PAGE;
    const endIdx = startIdx + QUESTIONS_PER_PAGE;
    const pageQuestions = importQuestionsAllDocs.slice(startIdx, endIdx);

    let html = `<div style="margin-bottom:10px;">
      <label>
        <input type="checkbox" id="selectAllImportQuestions">
        تحديد الكل
      </label>
    </div>
    <table class="grades-table"><thead><tr><th></th><th>السؤال</th><th>الخيارات</th><th>الصحيح</th></tr></thead><tbody>`;

  
pageQuestions.forEach(q => {
  html += `<tr class="import-question-row" data-qid="${q.id}" style="cursor:pointer;">
    <td><input type="checkbox" class="import-question-checkbox" value="${q.id}"></td>
    <td>${q.text}</td>
    <td>${q.options.map((o,i)=>`${i+1}- ${o.text}`).join("<br>")}</td>
    <td>${q.options[q.correctAnswer]?.text || ""}</td>
  </tr>`;
});

html += "</tbody></table>";
list.innerHTML = html;

    // أزرار التنقل بين الصفحات
    html += `<div style="text-align:center;margin-top:15px;">`;
    if (importQuestionsPage > 1) {
      html += `<button class="btn btn-outline" id="prevImportQuestionsPageBtn" style="margin-left:10px;">السابق</button>`;
    }
    html += `<span style="font-weight:bold;">صفحة ${importQuestionsPage} من ${totalPages}</span>`;
    if (importQuestionsPage < totalPages) {
      html += `<button class="btn btn-outline" id="nextImportQuestionsPageBtn" style="margin-right:10px;">التالي</button>`;
    }
    html += `</div>`;

    list.innerHTML = html;
document.querySelectorAll(".import-question-row").forEach(row => {
  row.addEventListener("click", function(e) {
    // تجاهل الضغط على الـ checkbox نفسه حتى لا يعكس مرتين
    if (e.target.classList.contains("import-question-checkbox")) return;
    const checkbox = this.querySelector(".import-question-checkbox");
    checkbox.checked = !checkbox.checked;
    // تحديث حالة "تحديد الكل" تلقائياً
    const allCheckboxes = document.querySelectorAll(".import-question-checkbox");
    const selectAll = document.getElementById("selectAllImportQuestions");
    if (selectAll) {
      selectAll.checked = Array.from(allCheckboxes).every(cb => cb.checked);
    }
  });
});
    // ربط أحداث تحديد الكل
    const selectAll = document.getElementById("selectAllImportQuestions");
    if (selectAll) {
      selectAll.addEventListener("change", function() {
        document.querySelectorAll(".import-question-checkbox").forEach(cb => {
          cb.checked = selectAll.checked;
        });
      });
    }

    // ربط أزرار الصفحات
    if (document.getElementById("prevImportQuestionsPageBtn")) {
      document.getElementById("prevImportQuestionsPageBtn").onclick = () => loadImportQuestionsList(importQuestionsPage - 1);
    }
    if (document.getElementById("nextImportQuestionsPageBtn")) {
      document.getElementById("nextImportQuestionsPageBtn").onclick = () => loadImportQuestionsList(importQuestionsPage + 1);
    }
  });
}

// ...existing code...

// عند الضغط على زر إضافة للأسئلة المختارة
// ...existing code...

// عند الضغط على زر إضافة للأسئلة المختارة
document.getElementById("addSelectedQuestionsBtn").onclick = function() {
  const checked = Array.from(document.querySelectorAll(".import-question-checkbox:checked")).map(cb => cb.value);
  if (checked.length === 0) {
    showToast("اختر سؤالاً واحداً على الأقل.", "error");
    return;
  }
  // تقسيم الـ IDs إلى مجموعات من 10 (Firestore in يدعم 10 فقط في كل استعلام)
  const chunkSize = 10;
  const chunks = [];
  for (let i = 0; i < checked.length; i += chunkSize) {
    chunks.push(checked.slice(i, i + chunkSize));
  }
  const questionsContainer = document.getElementById("questionsContainer");
  let allQuestions = [];
  let promises = chunks.map(chunk =>
    db.collection("questionBank")
      .where(firebase.firestore.FieldPath.documentId(), "in", chunk)
      .get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          allQuestions.push(doc.data());
        });
      })
  );
  Promise.all(promises).then(() => {
    allQuestions.forEach(q => {
      const questionId = Date.now() + Math.floor(Math.random()*10000);
      const questionElement = document.createElement("div");
      questionElement.className = "question-container";
      questionElement.id = "question-" + questionId;
      questionElement.innerHTML = `
        <div class="form-group">
          <label class="form-label">نص السؤال</label>
          <input type="text" class="form-control question-text" value="${q.text}" required>
        </div>
        <div class="form-group">
          <label class="form-label">رابط الصورة (اختياري)</label>
          <input type="text" class="form-control question-image-url" value="${q.imageUrl || ''}" placeholder="أدخل رابط الصورة">
        </div>
        <div class="form-group">
          <label class="form-label">خيارات الإجابة</label>
          <div id="options-${questionId}">
            ${q.options.map((option, optionIndex) => `
              <div class="option-item">
                <input type="radio" name="correct-${questionId}" value="${optionIndex}" ${q.correctAnswer === optionIndex ? "checked" : ""} required>
                <input type="text" class="form-control option-text" value="${option.text}" required>
              </div>
            `).join('')}
          </div>
          <button type="button" class="add-btn" onclick="addOption('${questionId}')">
            <i class="fas fa-plus"></i> إضافة خيار
          </button>
          <button type="button" class="remove-btn" onclick="removeQuestion('${questionId}')">
            <i class="fas fa-trash"></i> حذف السؤال
          </button>
        </div>
      `;
      questionsContainer.appendChild(questionElement);
    });
    document.getElementById("importQuestionsModal").style.display = "none";
    showToast("تم استيراد الأسئلة بنجاح!", "success");
  });
};

// ...existing code...
// ...existing code...

// زر رفع الأسئلة لبنك الأسئلة
document.getElementById("bulkUploadQuestionBankBtn").addEventListener("click", function() {
  document.getElementById("bulkUploadQuestionBankInput").click();
});

document.getElementById("bulkUploadQuestionBankInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const fileExtension = file.name.split('.').pop().toLowerCase();

  if (fileExtension === 'csv') {
    Papa.parse(file, {
      header: true,
      complete: function (results) {
        processBulkQuestionBankQuestions(results.data);
      },
      error: function (error) {
        alert(`حدث خطأ أثناء قراءة الملف: ${error.message}`);
      }
    });
  } else if (['xlsx', 'xls'].includes(fileExtension)) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(sheet);
      processBulkQuestionBankQuestions(jsonData);
    };
    reader.readAsArrayBuffer(file);
  } else {
    alert('يرجى رفع ملف بصيغة CSV أو Excel فقط.');
  }
});

// معالجة الأسئلة ورفعها إلى بنك الأسئلة
function processBulkQuestionBankQuestions(data) {
  let added = 0, failed = 0;
  const collection = db.collection("questionBank");
  // ربط جميع الأسئلة بالفئة المختارة من القائمة الرئيسية (إن وجدت)
  const categoryId = document.getElementById("questionBankCategory").value || null;
  const promises = [];

  data.forEach(row => {
    const text = row['السؤال']?.trim();
    const correctAnswer = parseInt(row['الإجابة الصحيحة']) - 1;
    const imageUrl = row['رابط الصورة']?.trim() || "";
    const options = [];
    for (let i = 1; i <= 4; i++) {
      const optionText = row[`الخيار ${i}`]?.trim();
      if (optionText) options.push({ text: optionText });
    }
    if (text && options.length >= 2 && !isNaN(correctAnswer)) {
      promises.push(
        collection.add({
          text,
          options,
          correctAnswer,
          imageUrl,
          categoryId,
          createdBy: currentUserData?.name || currentUser.email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => added++).catch(() => failed++)
      );
    } else {
      failed++;
    }
  });

  Promise.all(promises).then(() => {
    loadQuestionBank();
    showToast(`تمت إضافة ${added} سؤال${added !== 1 ? "ات" : ""} بنجاح!${failed ? " (" + failed + " لم يتم إضافتها بسبب نقص البيانات)" : ""}`, "success");
  });
}
// ...existing code...

// إظهار زر حذف الكل فقط عند اختيار فئة محددة
document.getElementById("questionBankCategory").addEventListener("change", function() {
  loadQuestionBank();
  const categoryId = this.value;
  const deleteBtn = document.getElementById("deleteAllQuestionsInCategoryBtn");
  if (categoryId && categoryId !== "") {
    deleteBtn.style.display = "inline-block";
  } else {
    deleteBtn.style.display = "none";
  }
});

// عند الضغط على زر حذف جميع الأسئلة في الفئة
document.getElementById("deleteAllQuestionsInCategoryBtn").onclick = async function() {
  const categoryId = document.getElementById("questionBankCategory").value;
  if (!categoryId) {
    showToast("اختر فئة أولاً!", "error");
    return;
  }
  if (!confirm("هل أنت متأكد أنك تريد حذف جميع الأسئلة في هذه الفئة؟ لا يمكن التراجع عن هذا الإجراء!")) return;

  // جلب جميع الأسئلة في الفئة
  const snapshot = await db.collection("questionBank").where("categoryId", "==", categoryId).get();
  if (snapshot.empty) {
    showToast("لا يوجد أسئلة في هذه الفئة.", "error");
    return;
  }
  // حذف الأسئلة دفعة واحدة باستخدام batch
  const batch = db.batch();
  snapshot.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  showToast("تم حذف جميع الأسئلة في الفئة بنجاح!", "success");
  loadQuestionBank();
};
function loadParentCategories(selectedId = "") {
  const select = document.getElementById("parentCategorySelect");
  select.innerHTML = `<option value="">بدون فئة رئيسية</option>`;
  db.collection("questionCategories").orderBy("name").get().then(snapshot => {
    // بناء شجرة الفئات
    const categories = {};
    snapshot.forEach(doc => {
      categories[doc.id] = { ...doc.data(), id: doc.id, children: [] };
    });
    Object.values(categories).forEach(cat => {
      if (cat.parentId && categories[cat.parentId]) {
        categories[cat.parentId].children.push(cat);
      }
    });
    const roots = Object.values(categories).filter(cat => !cat.parentId);

    function renderOptions(cats, prefix = "") {
      let html = "";
      cats.forEach(cat => {
        html += `<option value="${cat.id}" ${selectedId === cat.id ? "selected" : ""}>${prefix}${cat.name}</option>`;
        if (cat.children.length) {
          html += renderOptions(cat.children, prefix + "— ");
        }
      });
      return html;
    }

    select.innerHTML += renderOptions(roots);
  });
}


// عند فتح نافذة إضافة فئة جديدة
document.getElementById("addCategoryBtn").onclick = function() {
  document.getElementById("addCategoryModal").style.display = "flex";
  loadParentCategories();
};

// ...existing code...

// تحميل الفئات بشكل شجري في قائمة اختيار الفئة في بنك الأسئلة
// ...existing code...

// تحميل الفئات بشكل شجري مع عدد الأسئلة بجوار كل فئة
// ...existing code...
function refreshAllCategoryLabels() {
  // القائمة الرئيسية في بنك الأسئلة
  loadQuestionBankCategoriesTree(document.getElementById("questionBankCategory").value, "questionBankCategory");
  // قائمة الفئة في نافذة إضافة سؤال جديد
  loadQuestionBankCategoriesTree(document.getElementById("questionBankCategoryAdd")?.value || "", "questionBankCategoryAdd");
  // قائمة الفئة في نافذة الاستيراد
  loadQuestionBankCategoriesTree(document.getElementById("importBankCategory")?.value || "", "importBankCategory");
  // قائمة الفئة الرئيسية في نافذة إضافة فئة جديدة
  loadParentCategories(document.getElementById("parentCategorySelect")?.value || "");
}
// تحميل الفئات بشكل شجري مع عدد الأسئلة بجوار كل فئة، وعدد كل الأسئلة بجوار "كل الفئات"
function loadQuestionBankCategoriesTree(selected = "", selectId = "questionBankCategory") {
  const select = document.getElementById(selectId);
  select.innerHTML = "";
  // جلب جميع الفئات
  db.collection("questionCategories").orderBy("name").get().then(async snapshot => {
    // بناء شجرة الفئات
    const categories = {};
    questionCategoriesCache = {};
    snapshot.forEach(doc => {
      categories[doc.id] = { ...doc.data(), id: doc.id, children: [], count: 0 };
      questionCategoriesCache[doc.id] = doc.data().name;
    });
    Object.values(categories).forEach(cat => {
      if (cat.parentId && categories[cat.parentId]) {
        categories[cat.parentId].children.push(cat);
      }
    });
    const roots = Object.values(categories).filter(cat => !cat.parentId);

    // جلب عدد الأسئلة لكل فئة (مرة واحدة)
    const questionsSnapshot = await db.collection("questionBank").get();
    const counts = {};
    let totalCount = 0;
    questionsSnapshot.forEach(doc => {
      const q = doc.data();
      if (q.categoryId) {
        counts[q.categoryId] = (counts[q.categoryId] || 0) + 1;
      }
      totalCount++;
    });
    // ضع العدد في كل فئة
    Object.keys(counts).forEach(catId => {
      if (categories[catId]) categories[catId].count = counts[catId];
    });

    // دالة لإظهار الفئات بشكل متداخل مع العدد
    function renderOptions(cats, prefix = "") {
      let html = "";
      cats.forEach(cat => {
        html += `<option value="${cat.id}" ${selected === cat.id ? "selected" : ""}>${prefix}${cat.name} (${cat.count})</option>`;
        if (cat.children.length) {
          html += renderOptions(cat.children, prefix + "— ");
        }
      });
      return html;
    }

    select.innerHTML = `<option value=''>كل الفئات (${totalCount})</option>` + renderOptions(roots);
  });
}

// ...existing code...

// 🔍 كشف فتح أدوات المطور باستخدام الفرق الزمني في debugger
setInterval(() => {
  const start = performance.now();
  debugger;
  const end = performance.now();
  if (end - start > 100) {

    window.location.href = "about:blank"; // أو أي صفحة ثانية
  }
}, 1000);
// ...existing code...
// استبدل كل استدعاء loadQuestionBankCategories(selected, "questionBankCategory")
// بـ loadQuestionBankCategoriesTree(selected, "questionBankCategory")

// مثال عند فتح بنك الأسئلة:
document.getElementById("menuQuestionBank").addEventListener("click", function(e) {
  e.preventDefault();
  setActiveMenuItem(this);
  showPage(document.getElementById("questionBankPage"));
  loadQuestionBankCategoriesTree(); // شجري
  loadQuestionBank();
});

// وأيضاً عند إضافة سؤال جديد إذا أردت نفس الشجرة في نافذة الإضافة:
document.getElementById("addQuestionBankBtn").onclick = function() {
  document.getElementById("addQuestionBankModal").style.display = "flex";
  loadQuestionBankCategoriesTree("", "questionBankCategoryAdd"); // شجري
};
// ...existing code...
// ...existing code...
function selectStudentsByNumber(selectId, number) {
  const select = document.getElementById(selectId);
  if (!select) return;
  // حفظ حالة الزر السابق لكل قائمة
  if (!select._lastSelectedNumber) select._lastSelectedNumber = null;
  // إذا ضغطت نفس الرقم مرتين أزل التحديد
  if (select._lastSelectedNumber === number) {
    for (let i = 0; i < select.options.length; i++) {
      select.options[i].selected = false;
    }
    select._lastSelectedNumber = null;
  } else {
    for (let i = 0; i < select.options.length; i++) {
      const name = select.options[i].textContent || select.options[i].innerText || "";
      select.options[i].selected = name.includes(number);
    }
    select._lastSelectedNumber = number;
  }
}
// ...existing code...
// ...existing code...

// ...existing code...
// ...existing code...
// ...existing code...
// دوال addOption/removeQuestion موجودة لديك بالفعل وتعمل مع الأسئلة المستوردة

    </script>
    <div id="selfTestResultModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 class="modal-title">🎉 تهانينا!</h2>
            <p class="modal-message">لقد أكملت الاختبار بنجاح!</p>
            <div class="result-details">
                <p><strong>نتيجتك:</strong> <span id="selfTestResultScore">0%</span></p>
                <p><strong>عدد الإجابات الصحيحة:</strong> <span id="selfTestCorrectAnswers">0</span></p>
                <p><strong>عدد الإجابات الخاطئة:</strong> <span id="selfTestWrongAnswers">0</span></p>
            </div>
            <button class="btn btn-primary" id="closeSelfTestResultModal">إغلاق</button>
        </div>
    </div>
    <div id="toastMessage" class="toast-message" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span id="toastText">تم حذف الاختبار بنجاح!</span>
    </div>

    <div id="selfTestResultsPage" style="display: none;">
        <h2 class="page-title"><i class="fas fa-chart-bar"></i> نتائج اختبر نفسك</h2>
        <table class="grades-table">
            <thead>
     <tr>
        <th>اسم الطالب</th>
        <th>عنوان الاختبار</th>
        <th>الدرجة المحصلة</th>
        <th>النسبة المئوية</th>
        <th>التاريخ</th>
     </tr>
            </thead>
            <tbody id="selfTestResultsTable">
                <!-- سيتم تحميل النتائج هنا -->
            </tbody>
        </table>
    </div>
 <!-- استبدل الكود التالي في ملفك -->
<div id="accountDisabledModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width:420px;text-align:center;">
        <div style="margin-bottom:18px;">
            <i class="fas fa-user-slash" style="font-size:3rem;color:#FC5C65;"></i>
        </div>
        <h2 class="modal-title" style="color:#FC5C65;">🚫 حساب معطل</h2>
        <p class="modal-message" style="font-size:1.15rem;color:#333;margin-bottom:18px;">
            عذرًا، تم تعطيل حسابك. يرجى التواصل مع الإدارة للحصول على المزيد من التفاصيل.<br>
            إذا كان لديك أي استفسار أو ترغب في التواصل مع الإدارة، اضغط الزر بالأسفل.
        </p>
        <a href="https://wa.me/201060911093" target="_blank" id="whatsappContactBtn"
           style="display:inline-block;background:#25d366;color:#fff;font-size:1.2rem;padding:12px 32px;border-radius:8px;text-decoration:none;font-weight:bold;margin-bottom:10px;">
            <i class="fab fa-whatsapp" style="margin-left:8px;font-size:1.5rem;"></i> تواصل مع الإدارة عبر واتساب
        </a>
        <br>
        <button class="btn btn-primary" onclick="closeAccountDisabledModal()" style="margin-top:10px;">إغلاق</button>
    </div>
</div>
    <div id="unansweredQuestionsModal" class="modal" style="display: none;">
      <div class="modal-content">
          <h2 class="modal-title">⚠️ تنبيه</h2>
          <p class="modal-message" id="unansweredQuestionsMessage"></p>
          <div class="modal-actions">
              <button id="continueSubmitBtn" class="btn btn-success">تسليم</button>
              <button id="cancelSubmitBtn" class="btn btn-danger">إلغاء</button>
          </div>
      </div>
  </div>
  <div id="lessonModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:700px;">
    <span id="closeLessonModal" style="float:left;cursor:pointer;font-size:1.5rem;">&times;</span>
    <div id="lessonModalBody" style="margin-top:15px;"></div>
  </div>
</div>
<!-- أضف حقل إدخال رابط الصوت في نافذة الإشعار -->
<div id="notificationModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h2 class="modal-title">إرسال إشعار للطلاب</h2>
    <textarea id="notificationMessage" class="form-control" rows="4" placeholder="اكتب رسالتك هنا..." style="margin-bottom:15px;"></textarea>
    <input type="text" id="notificationAudioUrl" class="form-control" placeholder="رابط ملف صوتي (اختياري)" style="margin-bottom:15px;">
    <div class="modal-actions">
      <button id="sendNotificationBtn" class="btn btn-success">إرسال</button>
      <button id="cancelNotificationBtn" class="btn btn-danger">إلغاء</button>
    </div>
  </div>
</div>
<button id="toggleSidebarBtn" style="position:fixed;top:100px;right:25px;z-index:2001;background:#0a70ff;color:#fff;border:none;border-radius:50%;width:48px;height:48px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;box-shadow:0 2px 8px rgba(10,112,255,0.12);cursor:pointer;">
  <i class="fas fa-bars"></i>
</button>


</body>
</html>